<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„å®æ—¶è”æœºåœ°å›¾</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; }
        
        /* é‡æ–°å®šä½æŒ‰é’®æ ·å¼ */
        .locate-btn {
            position: absolute;
            bottom: 40px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: none;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            transition: 0.2s;
        }
        .locate-btn:active { background: #f0f0f0; transform: scale(0.95); }
        
        /* çŠ¶æ€æ˜¾ç¤ºæ  */
        .status-bar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ï¼Œä¸æŒ¡åœ°å›¾ */
        }
    </style>
</head>
<body>

    <div id="status" class="status-bar">æ­£åœ¨è¿æ¥å«æ˜Ÿ...</div>

    <div id="map"></div>
    
    <button class="locate-btn" onclick="manualLocate()">ğŸ“ åˆ·æ–°ä½ç½®</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <script>
        // --- ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–åœ°å›¾ ---
        var map = L.map('map').setView([35.8617, 104.1954], 4); // é»˜è®¤çœ‹ä¸­å›½

        // åŠ è½½é«˜æ¸…å«æ˜Ÿåº•å›¾
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri',
            maxZoom: 19
        }).addTo(map);

        // --- ç¬¬äºŒæ­¥ï¼šè”æœºé…ç½® ---
        
        // 1. ç”Ÿæˆéšæœºèº«ä»½ ID
        var myId = "Player_" + Math.floor(Math.random() * 8888);
        document.getElementById('status').innerText = "æˆ‘æ˜¯: " + myId;

        // 2. å®šä¹‰æˆ¿é—´æš—å· (ä¸ºäº†é¿å…å†²çªï¼Œå»ºè®®ä¿ç•™è¿™ä¸ªé•¿ä¸€ç‚¹çš„åå­—)
        var topic = 'mouyu/live/game'; 

        // 3. å­˜å‚¨å…¶ä»–ç©å®¶çš„ä¿¡æ¯ï¼Œæ ¼å¼: { id: { marker: Markerå¯¹è±¡, lastSeen: æ—¶é—´æˆ³ } }
        var otherPlayers = {}; 
        var myMarker = null;

        // --- ç¬¬ä¸‰æ­¥ï¼šè¿æ¥ MQTT æœåŠ¡å™¨ ---
        var client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');

        client.on('connect', function () {
            console.log('âœ… å·²è¿æ¥åˆ°æœåŠ¡å™¨');
            client.subscribe(topic); // è¿›æˆ¿é—´
            // æç¤ºè¿æ¥æˆåŠŸ
            L.popup().setLatLng(map.getCenter())
                .setContent("<b>ç½‘ç»œå·²è¿æ¥ï¼</b><br>æ­£åœ¨ç­‰å¾… GPS...")
                .openOn(map);
        });

        // --- ç¬¬å››æ­¥ï¼šå¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯ (æ˜¾ç¤ºåˆ«äºº + è®°å½•æ—¶é—´) ---
        client.on('message', function (topic, message) {
            try {
                var data = JSON.parse(message.toString());

                // å¦‚æœæ˜¯è‡ªå·±å‘çš„æ¶ˆæ¯ï¼Œå¿½ç•¥
                if (data.id === myId) return;

                var now = Date.now();

                // å¦‚æœæ˜¯æ–°ç©å®¶
                if (!otherPlayers[data.id]) {
                    var newMarker = L.circleMarker([data.lat, data.lng], {
                        color: '#ff0000',      // çº¢è‰²è¾¹æ¡†
                        fillColor: '#f03',     // çº¢è‰²å¡«å……
                        fillOpacity: 0.8,
                        radius: 10
                    }).addTo(map).bindPopup("ğŸš© é˜Ÿå‹: " + data.id);
                    
                    // ã€å…³é”®ã€‘è®°å½•å®ƒæ˜¯è°ï¼Œä»¥åŠâ€œæœ€åä¸€æ¬¡çœ‹è§å®ƒçš„æ—¶é—´â€
                    otherPlayers[data.id] = {
                        marker: newMarker,
                        lastSeen: now
                    };
                } else {
                    // è€ç©å®¶ï¼šæ›´æ–°ä½ç½®ï¼Œå¹¶åˆ·æ–°â€œæœ€ååœ¨çº¿æ—¶é—´â€
                    otherPlayers[data.id].marker.setLatLng([data.lat, data.lng]);
                    otherPlayers[data.id].lastSeen = now;
                }
            } catch (e) {
                console.error("æ•°æ®è§£æé”™è¯¯", e);
            }
        });

        // --- ç¬¬äº”æ­¥ï¼šå¹½çµæ¸…é™¤å™¨ (æ¯ 2 ç§’æ£€æŸ¥ä¸€æ¬¡) ---
        setInterval(function() {
            var now = Date.now();
            // éå†æ‰€æœ‰å·²çŸ¥çš„ç©å®¶
            for (var id in otherPlayers) {
                var player = otherPlayers[id];
                // å¦‚æœè¿™ä¸ªç©å®¶è¶…è¿‡ 10ç§’ (10000æ¯«ç§’) æ²¡å‘æ¶ˆæ¯
                if (now - player.lastSeen > 10000) {
                    console.log("ğŸ‘» ç©å®¶ç¦»å¼€ï¼Œæ¸…é™¤:", id);
                    // 1. ä»åœ°å›¾ä¸Šåˆ æ‰åœ†ç‚¹
                    map.removeLayer(player.marker);
                    // 2. ä»å†…å­˜é‡Œåˆ æ‰è®°å½•
                    delete otherPlayers[id];
                }
            }
        }, 2000); // å®šæ—¶å™¨ï¼šæ¯2ç§’è¿è¡Œä¸€æ¬¡

        // --- ç¬¬å…­æ­¥ï¼šå®šä½å¹¶å‘é€æˆ‘çš„ä½ç½® ---
        
        function locateAndShare() {
            // ä½¿ç”¨ä¹‹å‰è°ƒè¯•æˆåŠŸçš„å‚æ•°ï¼š30ç§’è¶…æ—¶ + é«˜ç²¾åº¦
            map.locate({
                setView: false, // é˜²æ­¢æ¯æ¬¡æ›´æ–°è§†è§’ä¹±è·³
                maxZoom: 17,
                timeout: 30000, 
                enableHighAccuracy: true,
                maximumAge: 0
            });
        }

        // é¦–æ¬¡å®šä½æ ‡å¿—
        var isFirstLocate = true;

        map.on('locationfound', function(e) {
            // 1. åœ¨åœ°å›¾ä¸Šç”»è“è‰²çš„è‡ªå·±
            if (!myMarker) {
                myMarker = L.circleMarker(e.latlng, {
                    color: '#3388ff',      // è“è‰²è¾¹æ¡†
                    fillColor: '#3388ff',  // è“è‰²å¡«å……
                    fillOpacity: 0.8,
                    radius: 12
                }).addTo(map).bindPopup("<b>ğŸ”µ æˆ‘åœ¨è¿™é‡Œ</b>").openPopup();
            } else {
                myMarker.setLatLng(e.latlng);
            }

            // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å®šä½æˆåŠŸï¼ŒæŠŠåœ°å›¾è§†è§’ç§»è¿‡å»
            if (isFirstLocate) {
                map.setView(e.latlng, 17);
                isFirstLocate = false;
                document.getElementById('status').innerText = "ğŸŸ¢ åœ¨çº¿ | ID: " + myId;
            }

            // 2. æŠŠåæ ‡å¹¿æ’­ç»™åˆ«äºº
            var myData = {
                id: myId,
                lat: e.latlng.lat,
                lng: e.latlng.lng
            };
            client.publish(topic, JSON.stringify(myData));
            console.log("ä½ç½®å·²å‘é€", myData);
        });

        map.on('locationerror', function(e) {
            console.log("å®šä½ä¸­...", e.message);
        });

        // æŒ‰é’®ç‚¹å‡»æ‰‹åŠ¨å®šä½
        function manualLocate() {
            isFirstLocate = true; // å…è®¸å†æ¬¡è·³è½¬è§†è§’
            locateAndShare();
            alert("æ­£åœ¨åˆ·æ–°ä½ç½®ï¼Œè¯·ç¨å€™...");
        }

        // --- ç¬¬ä¸ƒæ­¥ï¼šå¯åŠ¨å¾ªç¯ ---
        // ç«‹å³æ‰§è¡Œä¸€æ¬¡
        locateAndShare();
        
        // æ¯ 3 ç§’è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡ä½ç½®
        setInterval(locateAndShare, 3000);

    </script>
</body>
</html>
