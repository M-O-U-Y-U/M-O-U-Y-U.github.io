<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„å…¨æ¯è”æœºåœ°å›¾ (æ··åˆæ¨¡å¼)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; }
        
        /* é‡æ–°å®šä½æŒ‰é’®æ ·å¼ */
        .locate-btn {
            position: absolute;
            bottom: 40px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: none;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            transition: 0.2s;
        }
        .locate-btn:active { background: #f0f0f0; transform: scale(0.95); }
        
        /* çŠ¶æ€æ˜¾ç¤ºæ  */
        .status-bar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="status" class="status-bar">æ­£åœ¨è¿æ¥å«æ˜Ÿ...</div>

    <div id="map"></div>
    
    <button class="locate-btn" onclick="manualLocate()">ğŸ“ åˆ·æ–°ä½ç½®</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <script>
        // --- ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–åœ°å›¾ ---
        var map = L.map('map').setView([35.8617, 104.1954], 4); 

        // ğŸ† æ ¸å¿ƒä¿®æ”¹ï¼šä¸‰å±‚å åŠ æ³• (Satellite + Roads + Labels)
        
        // ç¬¬ 1 å±‚ï¼šåº•å±‚å«æ˜Ÿå½±åƒ (Base)
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri',
            maxZoom: 19
        }).addTo(map);

        // ç¬¬ 2 å±‚ï¼šé“è·¯çº¿æ¡ (é€æ˜å åŠ å±‚) - è¿™ä¸€å±‚è´Ÿè´£ç”»çº¿
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19
        }).addTo(map);

        // ç¬¬ 3 å±‚ï¼šåœ°åæ³¨è®° (é€æ˜å åŠ å±‚) - è¿™ä¸€å±‚è´Ÿè´£å†™å­—
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19
        }).addTo(map);


        // --- ç¬¬äºŒæ­¥ï¼šè”æœºé…ç½® (ä¿æŒä¸å˜) ---
        var myId = "Player_" + Math.floor(Math.random() * 8888);
        document.getElementById('status').innerText = "æˆ‘æ˜¯: " + myId;

        var topic = 'mouyu/live/game'; 
        var otherPlayers = {}; 
        var myMarker = null;

        // --- ç¬¬ä¸‰æ­¥ï¼šè¿æ¥ MQTT æœåŠ¡å™¨ ---
        var client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');

        client.on('connect', function () {
            console.log('âœ… å·²è¿æ¥åˆ°æœåŠ¡å™¨');
            client.subscribe(topic);
            L.popup().setLatLng(map.getCenter())
                .setContent("<b>ç½‘ç»œå·²è¿æ¥ï¼</b><br>æ­£åœ¨ç­‰å¾… GPS...")
                .openOn(map);
        });

        // --- ç¬¬å››æ­¥ï¼šå¤„ç†æ¶ˆæ¯ ---
        client.on('message', function (topic, message) {
            try {
                var data = JSON.parse(message.toString());
                if (data.id === myId) return;

                var now = Date.now();

                if (!otherPlayers[data.id]) {
                    var newMarker = L.circleMarker([data.lat, data.lng], {
                        color: '#ff0000', fillColor: '#f03', fillOpacity: 0.8, radius: 10
                    }).addTo(map).bindPopup("ğŸš© é˜Ÿå‹: " + data.id);
                    
                    otherPlayers[data.id] = { marker: newMarker, lastSeen: now };
                } else {
                    otherPlayers[data.id].marker.setLatLng([data.lat, data.lng]);
                    otherPlayers[data.id].lastSeen = now;
                }
            } catch (e) { console.error(e); }
        });

        // --- ç¬¬äº”æ­¥ï¼šå¹½çµæ¸…é™¤å™¨ ---
        setInterval(function() {
            var now = Date.now();
            for (var id in otherPlayers) {
                var player = otherPlayers[id];
                if (now - player.lastSeen > 10000) {
                    map.removeLayer(player.marker);
                    delete otherPlayers[id];
                }
            }
        }, 2000);

        // --- ç¬¬å…­æ­¥ï¼šå®šä½ä¸å‘é€ ---
        function locateAndShare() {
            map.locate({
                setView: false,
                maxZoom: 17,
                timeout: 30000, 
                enableHighAccuracy: true,
                maximumAge: 0
            });
        }

        var isFirstLocate = true;

        map.on('locationfound', function(e) {
            if (!myMarker) {
                myMarker = L.circleMarker(e.latlng, {
                    color: '#3388ff', fillColor: '#3388ff', fillOpacity: 0.8, radius: 12
                }).addTo(map).bindPopup("<b>ğŸ”µ æˆ‘åœ¨è¿™é‡Œ</b>").openPopup();
            } else {
                myMarker.setLatLng(e.latlng);
            }

            if (isFirstLocate) {
                map.setView(e.latlng, 17);
                isFirstLocate = false;
                document.getElementById('status').innerText = "ğŸŸ¢ åœ¨çº¿ | ID: " + myId;
            }

            var myData = { id: myId, lat: e.latlng.lat, lng: e.latlng.lng };
            client.publish(topic, JSON.stringify(myData));
        });

        map.on('locationerror', function(e) {
            console.log("å®šä½ä¸­...", e.message);
        });

        function manualLocate() {
            isFirstLocate = true; 
            locateAndShare();
            alert("æ­£åœ¨åˆ·æ–°ä½ç½®ï¼Œè¯·ç¨å€™...");
        }

        locateAndShare();
        setInterval(locateAndShare, 3000);

    </script>
</body>
</html>
