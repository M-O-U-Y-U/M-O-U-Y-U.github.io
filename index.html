<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„å…¨æ¯æ—…è¡Œåœ°å›¾</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; }
        
        /* å®šä½æŒ‰é’®æ ·å¼ */
        .locate-btn {
            position: absolute;
            bottom: 30px; /* ç¨å¾®å¾€ä¸Šæä¸€ç‚¹ï¼Œé¿å¼€æ‰‹æœºåº•éƒ¨æ¨ªæ¡ */
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: none;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
        }
        .locate-btn:active {
            background: #f0f0f0;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    
    <button class="locate-btn" onclick="locateUser()">ğŸ“ å¯»æ‰¾æˆ‘çš„ä½ç½®</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. åˆå§‹åŒ–åœ°å›¾ (é»˜è®¤æ˜¾ç¤ºä¸­å›½å…¨æ™¯)
        var map = L.map('map').setView([35.8617, 104.1954], 4);

        // 2. åŠ è½½ Esri é«˜æ¸…å«æ˜Ÿå½±åƒ
        var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri',
            maxZoom: 19
        });
        satelliteLayer.addTo(map);

        // --- æ ¸å¿ƒä¿®æ”¹ï¼šå®šä½åŠŸèƒ½ ---
        
        function locateUser() {
            console.log("æ­£åœ¨å°è¯•å®šä½...");
            
            map.locate({
                setView: true,           // æ‰¾åˆ°ä½ç½®åè‡ªåŠ¨è·³è½¬
                maxZoom: 16,             // è·³è½¬åçš„ç¼©æ”¾çº§åˆ«
                timeout: 30000,          // ã€å…³é”®ä¿®æ”¹ã€‘ç­‰å¾…æ—¶é—´å»¶é•¿åˆ° 30ç§’
                maximumAge: 0,           // ã€å…³é”®ä¿®æ”¹ã€‘å¼ºåˆ¶è·å–æœ€æ–°ä½ç½®ï¼Œä¸ä½¿ç”¨ç¼“å­˜
                enableHighAccuracy: true // ã€å…³é”®ä¿®æ”¹ã€‘å¼€å¯é«˜ç²¾åº¦æ¨¡å¼ (å°è¯•è°ƒç”¨ GPS ç¡¬ä»¶)
            });
        }

        // æˆåŠŸæ—¶çš„å›è°ƒ
        function onLocationFound(e) {
            var radius = e.accuracy / 2;

            // æ¸…é™¤åœ°å›¾ä¸Šå·²æœ‰çš„æ—§å®šä½ç‚¹ (å¯é€‰ä¼˜åŒ–ï¼Œé˜²æ­¢åœ°å›¾ä¸Šå…¨æ˜¯è“ç‚¹)
            map.eachLayer(function (layer) {
                if (layer.options.id === 'userLocation') {
                    map.removeLayer(layer);
                }
            });

            // æ·»åŠ æ–°å®šä½ç‚¹
            L.circleMarker(e.latlng, {
                radius: 10,
                fillColor: "#3388ff",
                color: "#fff",
                weight: 3,
                opacity: 1,
                fillOpacity: 0.8,
                id: 'userLocation' // ç»™å®ƒä¸ªæ ‡è®°ï¼Œæ–¹ä¾¿ä»¥ååˆ é™¤
            }).addTo(map)
            .bindPopup("<b>ä½ åœ¨è¿™é‡Œï¼</b><br>ç²¾åº¦: " + Math.round(radius) + "ç±³").openPopup();

            // ç”»ç²¾åº¦åœˆ
            L.circle(e.latlng, {
                radius: radius,
                id: 'userLocation'
            }).addTo(map);
        }

        // å¤±è´¥æ—¶çš„å›è°ƒ
        function onLocationError(e) {
            // å¦‚æœ 30ç§’åè¿˜æ˜¯å¤±è´¥ï¼Œæ‰å¼¹çª—æç¤º
            alert("å®šä½è¶…æ—¶æˆ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‰‹æœº GPS æ˜¯å¦å¼€å¯ã€‚\n(å»ºè®®åœ¨æˆ·å¤–æˆ–çª—è¾¹å°è¯•)");
            console.log(e.message);
        }

        // ç»‘å®šç›‘å¬å™¨
        map.on('locationfound', onLocationFound);
        map.on('locationerror', onLocationError);

        // 3. é¡µé¢åŠ è½½å®Œæˆåï¼Œè‡ªåŠ¨å¼€å§‹å®šä½
        locateUser();

        // --- ä¹‹å‰çš„æ•°æ®ç‚¹ä¿ç•™ ---
        L.marker([39.9042, 116.4074]).addTo(map)
            .bindPopup("<b>ğŸ‡¨ğŸ‡³ åŒ—äº¬Â·å¤©å®‰é—¨</b>");

    </script>
</body>
</html>
