<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MOUYU å…±äº«åœ°å›¾ (ç”ŸåŒ–å±æœºç‰ˆ)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* ========================
           å…¨å±€ä¸åŸºç¡€æ ·å¼
           ======================== */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; overflow: hidden; transition: background 0.5s; }
        #map { height: 100vh; width: 100%; }
        
        /* ğŸ©¸ è¢«æ„ŸæŸ“æ—¶çš„å…¨å±ç‰¹æ•ˆ */
        body.infected-mode::after {
            content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            box-shadow: inset 0 0 50px 20px rgba(255, 0, 0, 0.6);
            pointer-events: none; z-index: 99999;
            animation: breathe 2s infinite;
        }
        @keyframes breathe { 0% { box-shadow: inset 0 0 50px 20px rgba(255, 0, 0, 0.4); } 50% { box-shadow: inset 0 0 80px 40px rgba(255, 0, 0, 0.7); } 100% { box-shadow: inset 0 0 50px 20px rgba(255, 0, 0, 0.4); } }

        /* å¼¹çª—ä¸é®ç½© */
        .overlay-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
            flex-direction: column; color: white;
        }
        .dialog-box {
            background: white; padding: 25px; border-radius: 16px; width: 85%; max-width: 320px;
            text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: #333;
        }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .dialog-title { font-size: 20px; font-weight: bold; margin-bottom: 15px; color: #333; }
        
        .login-input {
            width: 100%; padding: 12px; font-size: 16px; border: 2px solid #eee; border-radius: 8px;
            margin-bottom: 15px; text-align: center; outline: none; transition: 0.3s;
        }
        .login-input:focus { border-color: #1890ff; }
        
        .action-btn {
            width: 100%; padding: 12px; border: none; border-radius: 8px; 
            font-size: 16px; font-weight: bold; cursor: pointer; color: white;
            transition: transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .action-btn:active { transform: scale(0.98); opacity: 0.9; }
        .btn-blue { background: #1890ff; }
        .btn-red { background: #ff4d4f; }
        .btn-green { background: #52c41a; }
        .btn-gray { background: #f0f0f0; color: #666; }
        .btn-purple { background: #722ed1; } /* åƒµå°¸æŒ‰é’®è‰² */

        /* åœ°å›¾æŒ‰é’® */
        .map-btn {
            background: white; border: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            padding: 8px 12px; font-size: 13px; font-weight: 600; color: #333; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .map-btn:active { background: #f0f0f0; transform: scale(0.95); }
        .map-btn.active { background: #e6f7ff; color: #1890ff; border: 1px solid #1890ff; }

        .locate-btn { position: absolute; bottom: 40px; right: 20px; z-index: 999; padding: 12px 20px; border-radius: 50px; }
        .follow-btn { position: absolute; bottom: 100px; right: 20px; z-index: 999; width: 40px; height: 40px; border-radius: 50%; font-size: 18px; }
        .measure-btn { position: absolute; bottom: 150px; right: 20px; z-index: 999; width: 40px; height: 40px; border-radius: 50%; font-size: 18px; }
        .sos-btn {
            position: absolute; bottom: 210px; right: 20px; z-index: 999;
            width: 40px; height: 40px; border-radius: 50%;
            background: #ff4d4f; color: white; font-weight: bold; font-size: 12px;
            border: 2px solid white; box-shadow: 0 4px 10px rgba(255, 77, 79, 0.4);
            display: flex; align-items: center; justify-content: center;
            animation: pulse-shadow 2s infinite;
        }
        @keyframes pulse-shadow { 0% { box-shadow: 0 0 0 0 rgba(255, 77, 79, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 77, 79, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 77, 79, 0); } }

        /* é¢æ¿ */
        .player-list-panel {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px);
            padding: 15px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            width: 260px; max-height: 70vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.5);
            transition: all 0.3s ease;
        }
        @media (max-width: 600px) {
            .player-list-panel { width: 220px; top: 10px; right: 10px; padding: 10px; }
            .locate-btn { bottom: 30px; right: 10px; padding: 10px 15px; font-size: 12px; }
            .follow-btn { bottom: 90px; right: 10px; width: 36px; height: 36px; }
            .measure-btn { bottom: 135px; right: 10px; width: 36px; height: 36px; }
            .sos-btn { bottom: 180px; right: 10px; width: 36px; height: 36px; }
            .room-setting-box { padding: 8px !important; }
        }

        .panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 10px; cursor: pointer; }
        .panel-title { font-size: 14px; font-weight: 700; color: #1a1a1a; margin: 0; }
        .toggle-icon { font-size: 12px; color: #999; transition: transform 0.3s; }
        .net-status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-online { background-color: #52c41a; box-shadow: 0 0 5px #52c41a; }
        .status-offline { background-color: #ff4d4f; box-shadow: 0 0 5px #ff4d4f; }

        .chat-panel {
            position: absolute; bottom: 30px; left: 20px; z-index: 1000;
            width: 280px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; transition: width 0.3s, transform 0.3s;
        }
        @media (max-width: 600px) { .chat-panel { width: 70%; left: 10px; bottom: 80px; } }
        .chat-header { background: #f0f2f5; padding: 10px 12px; font-size: 12px; font-weight: bold; color: #666; display: flex; justify-content: space-between; cursor: pointer; border-radius: 12px 12px 0 0; }
        .chat-panel.collapsed .chat-header { border-radius: 12px; }
        .chat-content-wrapper { display: block; }
        .chat-panel.collapsed .chat-content-wrapper { display: none; }
        .chat-messages { height: 150px; overflow-y: auto; padding: 10px; font-size: 12px; background: white; }
        .chat-msg-row { margin-bottom: 6px; line-height: 1.4; word-wrap: break-word; }
        .chat-sender { font-weight: bold; color: #1890ff; margin-right: 4px; }
        .chat-input-area { display: flex; padding: 8px; border-top: 1px solid #eee; background: #fff; border-radius: 0 0 12px 12px; align-items: center; }
        .chat-input { flex: 1; border: 1px solid #ddd; border-radius: 4px; padding: 6px 8px; font-size: 12px; outline: none; min-width: 0; }
        .chat-send-btn { margin-left: 6px; background: #1890ff; color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 12px; white-space: nowrap; }

        .user-setting-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .setting-label { font-size: 12px; color: #666; width: 30px; flex-shrink: 0; }
        .avatar-input { width: 40px; text-align: center; border: 1px solid #ddd; border-radius: 8px; padding: 5px; font-size: 16px; background: #f9f9f9; }
        .status-input { flex: 1; border: 1px solid #ddd; border-radius: 8px; padding: 6px; font-size: 12px; background: #f9f9f9; }
        .id-input { flex: 1; border: 1px solid #ddd; border-radius: 8px; padding: 6px; font-size: 12px; background: #f9f9f9; font-weight: bold; color: #333; }
        .gpx-btn { width: 100%; background: #28a745; color: white; border: none; border-radius: 6px; padding: 8px; font-size: 12px; font-weight: bold; cursor: pointer; text-align: center; display: flex; align-items: center; justify-content: center; gap: 5px; }

        .view-switch { display: flex; gap: 5px; background: #eee; padding: 2px; border-radius: 6px; flex: 1; }
        .view-opt { flex: 1; text-align: center; font-size: 11px; padding: 4px 0; cursor: pointer; border-radius: 4px; color: #666; }
        .view-opt.active { background: white; color: #3388ff; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .player-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; margin-bottom: 6px; background: #f8f9fa; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .player-head { display: flex; align-items: center; gap: 5px; font-weight: 600; font-size: 13px; color: #333; }
        .player-status-text { font-size: 11px; color: #666; margin-top: 2px; }
        .player-dist { font-size: 11px; color: #888; }
        
        .emoji-marker-icon { position: relative; display: flex; justify-content: center; align-items: center; background: white; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.3); border: 2px solid white; font-size: 24px; transition: all 0.3s ease; }
        .my-icon-style { border-color: #3388ff; z-index: 1000 !important; }
        .other-icon-style { border-color: #ff4d4f; }
        .zombie-icon-style { border-color: #722ed1 !important; box-shadow: 0 0 15px rgba(114, 46, 209, 0.8); z-index: 2000 !important; }

        .heading-arrow { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid #3388ff; z-index: -1; display: none; }
        .status-bubble { background: white; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border-radius: 4px; padding: 2px 6px; font-size: 12px; font-weight: bold; color: #333; margin-bottom: 5px; }
        .leaflet-tooltip-bottom:before { display: none; }
        
        .flag-icon { font-size: 30px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); animation: bounce 1s infinite; }
        .sos-marker-pulse { border: 3px solid #ff4d4f; background: rgba(255, 77, 79, 0.4); border-radius: 50%; animation: markerPulse 1.5s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes markerPulse { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }

        .msg-bubble-container { position: absolute; bottom: 45px; left: 0; width: 100%; pointer-events: none; display: flex; flex-direction: column-reverse; align-items: flex-start; }
        .msg-bubble { background: rgba(0, 0, 0, 0.75); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; margin-bottom: 5px; max-width: 80%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; animation: fadeUp 0.3s ease-out; margin-left: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .chat-badge { display: none; width: 8px; height: 8px; background: #ff4d4f; border-radius: 50%; margin-right: 5px; }
        .toast-tip { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 8px; font-size: 14px; pointer-events: none; opacity: 0; transition: opacity 0.5s; z-index: 2000; }
        .sos-alert-box { position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: #ff4d4f; color: white; padding: 15px 30px; border-radius: 50px; font-weight: bold; box-shadow: 0 5px 20px rgba(255, 77, 79, 0.6); z-index: 3000; display: none; animation: shake 0.5s; cursor: pointer; }
        @keyframes shake { 0%, 100% { transform: translateX(-50%); } 25% { transform: translateX(-55%); } 75% { transform: translateX(-45%); } }
        .leaflet-control-scale { margin-bottom: 5px !important; margin-left: 10px !important; }
    </style>
</head>
<body>

    <div id="login-overlay" class="overlay-mask">
        <div class="dialog-box">
            <div style="font-size: 40px; margin-bottom: 10px;">ğŸ”’</div>
            <div class="dialog-title">MOUYU å†…éƒ¨ç³»ç»Ÿ</div>
            <input type="password" id="site-password" class="login-input" placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç ..." onkeypress="if(event.key==='Enter') checkSitePassword()">
            <button class="action-btn btn-blue" onclick="checkSitePassword()">è§£é”ç³»ç»Ÿ</button>
            <div id="login-error" style="color:red; font-size:12px; margin-top:10px; opacity:0; transition:opacity 0.3s;">å¯†ç é”™è¯¯</div>
            <div id="lib-error" style="color:red; font-size:11px; margin-top:5px; display:none;">âš ï¸ åŠ å¯†åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢</div>
        </div>
    </div>

    <div id="sos-confirm-overlay" class="overlay-mask" style="display: none;">
        <div class="dialog-box" style="border-top: 5px solid #ff4d4f;">
            <div style="font-size: 40px; margin-bottom: 10px;">âš ï¸</div>
            <div class="dialog-title" style="color:#ff4d4f">ç¡®å®šå‘é€ SOS å—ï¼Ÿ</div>
            <div style="font-size: 13px; color: #666; margin-bottom: 20px; text-align: left; background: #fff1f0; padding: 10px; border-radius: 6px;">
                æ‰€æœ‰äººå°†ç«‹åˆ»çœ‹åˆ°ä½ çš„ä½ç½®ã€‚<br>è¯·ä»…åœ¨ç´§æ€¥æƒ…å†µä¸‹ä½¿ç”¨ã€‚
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="action-btn btn-gray" onclick="cancelSOS()">å–æ¶ˆ</button>
                <button class="action-btn btn-red" onclick="confirmSOS()">ç«‹å³å‘é€</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast-tip">é•¿æŒ‰åœ°å›¾æ’æ—— | ç‚¹å‡»ç›´å°ºæµ‹é‡</div>
    <div id="sos-alert" class="sos-alert-box" onclick="this.style.display='none'">ğŸš¨ æ”¶åˆ° SOS æ±‚æ•‘ä¿¡å·ï¼(ç‚¹å‡»å…³é—­)</div>

    <div class="player-list-panel" id="player-panel">
        <div class="panel-header" onclick="togglePlayerPanel()">
            <div style="display:flex; align-items:center;">
                <span id="net-status-dot" class="net-status-dot status-offline"></span>
                <div class="panel-title">ğŸ“¡ MOUYUåœ°å›¾</div>
            </div>
            <div class="toggle-icon" id="player-toggle-icon">â–¼</div>
        </div>
        <div class="panel-content" id="player-content">
            
            <div class="room-setting-box" style="background: #e6f7ff; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #91d5ff;">
                <div class="user-setting-row room-input-row">
                    <span class="setting-label" style="font-weight:bold; color:#0050b3;">æˆ¿é—´</span>
                    <input type="text" id="room-input" class="id-input" value="å¤§å…" placeholder="æˆ¿é—´å" style="background:white;">
                </div>
                <div class="user-setting-row room-input-row">
                    <span class="setting-label" style="font-weight:bold; color:#0050b3;">å¯†ç </span>
                    <input type="text" id="pass-input" class="status-input" placeholder="å¯†é’¥(å¯é€‰)" style="background:white;">
                </div>
                <button class="gpx-btn" onclick="joinRoom()" style="background:#1890ff; margin-top:5px; height: 32px; line-height: 1;">ğŸšª è¿›å…¥/é‡è¿</button>
            </div>

            <div style="margin-bottom: 10px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                <div style="background: #f9f9f9; padding: 8px; font-size: 12px; font-weight: bold; color: #666; border-bottom: 1px solid #eee;">ğŸ® æ¸¸æˆæ¨¡å¼ (ç”ŸåŒ–å±æœº)</div>
                <div style="padding: 10px; display: flex; flex-direction: column; gap: 8px;">
                    <button class="action-btn btn-purple" onclick="becomeZombie(true)">ğŸ§¬ å˜èº«æ¯ä½“ (å¼€å§‹)</button>
                    <button class="action-btn btn-green" onclick="resetGame()">ğŸ’‰ æ³¨å°„è¡€æ¸… (é‡ç½®)</button>
                    <div style="font-size: 11px; color: #999; text-align: center;">é è¿‘æ„ŸæŸ“è€… (10ç±³å†…) å°†è‡ªåŠ¨å˜å¼‚</div>
                </div>
            </div>
            
            <div style="padding-bottom: 10px; border-bottom: 1px dashed #eee; margin-bottom: 10px;">
                <div class="user-setting-row">
                    <span class="setting-label">è§†å›¾</span>
                    <div class="view-switch">
                        <div class="view-opt active" onclick="setViewMode('auto', this)">è‡ªåŠ¨</div>
                        <div class="view-opt" onclick="setViewMode('mobile', this)">æ‰‹æœº</div>
                        <div class="view-opt" onclick="setViewMode('pc', this)">ç”µè„‘</div>
                    </div>
                </div>
                <div class="user-setting-row">
                    <span class="setting-label">æ˜µç§°</span>
                    <input type="text" id="my-name-input" class="id-input" value="" placeholder="è¾“å…¥åå­—" maxlength="10">
                </div>
                <div class="user-setting-row">
                    <span class="setting-label">å½¢è±¡</span>
                    <input type="text" id="my-avatar-input" class="avatar-input" value="ğŸ˜¼" maxlength="2">
                </div>
            </div>
            <div id="player-list-container">
                <div style="font-size:12px; color:#ccc; text-align:center; padding:10px;">æ‰«æä¸­...</div>
            </div>
            <div class="my-status" id="my-status-text">è¿æ¥ä¸­...</div>
        </div>
    </div>

    <div class="chat-panel" id="chat-panel">
        <div class="msg-bubble-container" id="msg-bubble-container"></div>
        <div class="chat-header" onclick="toggleChat()">
            <div style="display:flex; align-items:center;">
                <div class="chat-badge" id="chat-badge"></div>
                <span>ğŸ’¬ é¢‘é“</span>
            </div>
            <span id="chat-toggle-icon">â–¼</span>
        </div>
        <div class="chat-content-wrapper" id="chat-content-wrapper">
            <div class="chat-messages" id="chat-messages">
                <div class="chat-msg-row" style="color:#999; font-style:italic;">å®æ—¶èŠå¤©ï¼Œåˆ·æ–°å³ç„š...</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" class="chat-input" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." onkeypress="handleChatKey(event)">
                <button class="chat-send-btn" onclick="sendChat()">å‘é€</button>
            </div>
        </div>
    </div>

    <div id="map"></div>
    
    <button class="map-btn sos-btn" onclick="openSOSConfirm()" title="SOS">SOS</button>
    <button class="map-btn measure-btn" id="measure-btn" onclick="toggleMeasure()" title="æµ‹é‡">ğŸ“</button>
    <button class="map-btn follow-btn" id="follow-btn" onclick="toggleFollow()" title="è·Ÿéš">ğŸ”„</button>
    <button class="map-btn locate-btn" onclick="triggerManualLocate()">ğŸ“ å®šä½æˆ‘</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://unpkg.com/crypto-js@4.1.1/crypto-js.js"></script>

    <script>
        // 1. é—¨ç¦ (Hash)
        var SITE_HASH = "c7e616822f366fb1b5e0756af498cc11d2c0862edcb32ca65882f622ff39de1b"; 
        var isSystemUnlocked = false;

        function checkSitePassword() {
            if (typeof CryptoJS === 'undefined') { document.getElementById('lib-error').style.display = 'block'; return; }
            var input = document.getElementById('site-password').value.trim(); 
            if (CryptoJS.SHA256(input).toString() === SITE_HASH) {
                document.getElementById('login-overlay').style.display = 'none';
                isSystemUnlocked = true;
                startApp(); 
            } else {
                var err = document.getElementById('login-error');
                err.style.opacity = 1; setTimeout(() => { err.style.opacity = 0; }, 2000);
            }
        }
        
        // 2. åŠ å¯†é€šä¿¡
        function getRoomPassword() { return document.getElementById('pass-input').value.trim(); }
        function encryptPayload(dataObj) {
            if (typeof CryptoJS === 'undefined') return JSON.stringify(dataObj);
            var pass = getRoomPassword();
            var jsonStr = JSON.stringify(dataObj);
            if (!pass) return jsonStr; 
            try { return "ENC:" + CryptoJS.AES.encrypt(jsonStr, pass).toString(); } catch(e) { return jsonStr; }
        }
        function decryptPayload(payloadStr) {
            if (typeof CryptoJS === 'undefined') return null;
            var pass = getRoomPassword();
            if (payloadStr.startsWith("ENC:")) {
                if (!pass) return null; 
                try {
                    var bytes = CryptoJS.AES.decrypt(payloadStr.substring(4), pass);
                    var originalText = bytes.toString(CryptoJS.enc.Utf8);
                    return originalText ? JSON.parse(originalText) : null;
                } catch (e) { return null; }
            } else {
                if (pass) return null; 
                try { return JSON.parse(payloadStr); } catch(e) { return null; }
            }
        }

        // 3. å®‰å…¨å­˜å‚¨
        var SafeStorage = {
            memory: {},
            setItem: function(key, value) { try { localStorage.setItem(key, value); } catch(e) { this.memory[key] = value; } },
            getItem: function(key) { try { return localStorage.getItem(key); } catch(e) { return this.memory[key] || null; } }
        };

        // æ ¸å¿ƒå˜é‡
        var map, client, satellite, streetMap, darkMap, osmMap;
        var myUniqueId, myName;
        var otherPlayers = {}; var myLatLng = null; var myMarker = null; var myPolyline = null;
        var myCurrentAvatar = "ğŸ˜¼"; var myCurrentStatus = ""; var currentFlag = null; var sosMarkers = [];
        var isMeasuring = false; var measurePoints = []; var measureLine = null; var measureTips = [];
        var isFollowing = false; var myHeading = 0; var currentTopic = ""; 
        var amIZombie = false; // æ˜¯å¦æ„ŸæŸ“

        function startApp() {
            darkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 20 });
            osmMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 });
            satellite = L.layerGroup([
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 }),
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 })
            ]);
            streetMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: 'Â© CartoDB', maxZoom: 20 });

            map = L.map('map', { center: [35.8617, 104.1954], zoom: 4, layers: [satellite], zoomControl: false });
            L.control.zoom({position: 'topleft'}).addTo(map);
            L.control.layers({ "ğŸ›°ï¸ å«æ˜Ÿå›¾": satellite, "ğŸ—ºï¸ OSMåœ°å›¾": osmMap, "ğŸŒ‘ å¤œé—´æ¨¡å¼": darkMap, "â˜€ï¸ ç®€æ´å›¾": streetMap }).addTo(map);
            L.control.scale({ imperial: false, maxWidth: 200 }).addTo(map);
            
            myUniqueId = SafeStorage.getItem('my_unique_id') || "uid_" + Date.now() + Math.floor(Math.random()*1000);
            SafeStorage.setItem('my_unique_id', myUniqueId);
            myName = SafeStorage.getItem('my_nickname') || "å¹¸å­˜è€…" + Math.floor(Math.random()*100);
            document.getElementById('my-name-input').value = myName;
            
            client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
            client.on('connect', function () { updateNetStatus(true); joinRoom(); });
            client.on('offline', function() { updateNetStatus(false); });
            client.on('message', handleMqttMessage);
            
            map.on('click', onMapClick);
            map.on('dragstart', function() { if(isFollowing) toggleFollow(); });
            map.on('contextmenu', onMapContextMenu);
            map.on('locationfound', onLocationFound);

            locateAndShare(false); 
            setInterval(() => locateAndShare(false), 2000); // åŠ å¿«ä½ç½®åˆ·æ–°é¢‘ç‡åˆ°2ç§’
            setInterval(checkZombieInfection, 1000); // ğŸ§Ÿâ€â™‚ï¸ æ¯ç§’æ£€æŸ¥ä¸€æ¬¡æ„ŸæŸ“

            setTimeout(function(){ showToast("é•¿æŒ‰åœ°å›¾æ’æ—— | ç‚¹å‡»ç›´å°ºæµ‹é‡"); }, 1000);
            applyViewMode();
        }

        function updateNetStatus(isOnline) {
            document.getElementById('net-status-dot').className = isOnline ? "net-status-dot status-online" : "net-status-dot status-offline";
            document.getElementById('my-status-text').innerText = isOnline ? "åœ¨çº¿ | ID:" + myUniqueId.substring(0,4) : "ç¦»çº¿...";
        }

        function getTopic(room) { return 'mouyu/live/' + encodeURIComponent(room || "å¤§å…"); }

        function joinRoom() {
            var room = document.getElementById('room-input').value.trim();
            var newTopic = getTopic(room);
            if (currentTopic && client.connected) {
                client.unsubscribe(currentTopic);
                for(var id in otherPlayers) { map.removeLayer(otherPlayers[id].marker); if(otherPlayers[id].polyline) map.removeLayer(otherPlayers[id].polyline); }
                otherPlayers = {}; updatePlayerList();
                if(currentFlag) { map.removeLayer(currentFlag); currentFlag = null; }
                sosMarkers.forEach(m => map.removeLayer(m)); sosMarkers = [];
            }
            currentTopic = newTopic;
            if (client.connected) {
                client.subscribe(currentTopic);
                publishData({ type: 'chat', senderId: 'SYS', senderName: 'ç³»ç»Ÿ', text: `${myName} è¿›æˆ¿` });
                triggerManualLocate();
            }
            alert("âœ… è¿›å…¥: " + room);
            document.querySelector('.panel-title').innerText = "ğŸ“¡ æˆ¿é—´: " + room;
        }

        function publishData(dataObj) {
            if (!client || !client.connected) return;
            // æ¯æ¬¡å‘é€éƒ½å¸¦ä¸Šåƒµå°¸çŠ¶æ€
            dataObj.isZombie = amIZombie;
            client.publish(currentTopic, encryptPayload(dataObj));
        }

        // ==========================
        // ğŸ§Ÿâ€â™‚ï¸ ç”ŸåŒ–å±æœºé€»è¾‘
        // ==========================
        
        function becomeZombie(isMother) {
            if (amIZombie) return; // å·²ç»æ˜¯åƒµå°¸äº†
            amIZombie = true;
            document.body.classList.add('infected-mode'); // å¼€å¯çº¢å±ç‰¹æ•ˆ
            
            // éœ‡åŠ¨åé¦ˆ (éƒ¨åˆ†æ‰‹æœºæ”¯æŒ)
            if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 500]);
            
            var msg = isMother ? "ğŸ§¬ æˆ‘å·²å˜å¼‚ä¸ºæ¯ä½“ï¼æ¸¸æˆå¼€å§‹ï¼" : "ğŸ§Ÿâ€â™‚ï¸ æˆ‘è¢«æ„ŸæŸ“äº†ï¼";
            publishData({ type: 'chat', senderId: myUniqueId, senderName: myName, text: msg });
            
            // å¼ºåˆ¶æ›´æ–°å¤´åƒå’ŒçŠ¶æ€
            myCurrentAvatar = "ğŸ§Ÿâ€â™‚ï¸";
            document.getElementById('my-avatar-input').value = "ğŸ§Ÿâ€â™‚ï¸";
            myCurrentStatus = "å·²æ„ŸæŸ“";
            updateMyMarkerVisuals();
            triggerManualLocate();
            showToast(isMother ? "ä½ å·²å˜èº«æ¯ä½“ï¼Œå»æŠ“äººï¼" : "è­¦å‘Šï¼šä½ å·²è¢«æ„ŸæŸ“ï¼");
        }

        function resetGame() {
            amIZombie = false;
            document.body.classList.remove('infected-mode');
            myCurrentAvatar = "ğŸ˜¼";
            document.getElementById('my-avatar-input').value = "ğŸ˜¼";
            myCurrentStatus = "å¹¸å­˜è€…";
            updateMyMarkerVisuals();
            triggerManualLocate();
            publishData({ type: 'chat', senderId: myUniqueId, senderName: myName, text: "ğŸ’‰ æˆ‘å·²æ³¨å°„è¡€æ¸…ï¼Œæ¢å¤äººç±»ã€‚" });
            showToast("èº«ä»½å·²é‡ç½®ä¸ºäººç±»");
        }

        // æ ¸å¿ƒæ£€æµ‹å¾ªç¯
        function checkZombieInfection() {
            if (amIZombie || !myLatLng) return; // å¦‚æœæˆ‘æ˜¯åƒµå°¸ï¼Œæˆ–è€…è¿˜æ²¡å®šä½ï¼Œè·³è¿‡
            
            for (var id in otherPlayers) {
                var p = otherPlayers[id];
                // åªæœ‰å½“å¯¹æ–¹æ˜¯åƒµå°¸ (isZombie=true)
                if (p.isZombie && p.lat && p.lng) {
                    var dist = map.distance(myLatLng, [p.lat, p.lng]);
                    // è·ç¦»å°äº 10 ç±³
                    if (dist < 10) {
                        console.log("æ¥è§¦æ„ŸæŸ“æºï¼è·ç¦»:", dist);
                        becomeZombie(false); // è¢«åŠ¨æ„ŸæŸ“
                        break;
                    }
                }
            }
        }

        // ==========================
        // ğŸš¨ SOS
        // ==========================
        function openSOSConfirm() {
            if(!myLatLng) { showToast("å®šä½ä¸­ï¼Œè¯·ç¨å..."); return; }
            document.getElementById('sos-confirm-overlay').style.display = 'flex';
        }
        function cancelSOS() { document.getElementById('sos-confirm-overlay').style.display = 'none'; }
        function confirmSOS() {
            document.getElementById('sos-confirm-overlay').style.display = 'none';
            publishData({ type: 'sos', senderId: myUniqueId, senderName: myName, lat: myLatLng.lat, lng: myLatLng.lng });
            showToast("ğŸš¨ SOS ä¿¡å·å·²å‘é€ï¼");
        }

        function handleMqttMessage(topic, message) {
            try {
                var data = decryptPayload(message.toString());
                if (!data) return; 

                if (data.type === 'sos' && data.senderId !== myUniqueId) {
                    document.getElementById('sos-alert').style.display = 'block';
                    map.flyTo([data.lat, data.lng], 18);
                    var sosM = L.marker([data.lat, data.lng], { icon: L.divIcon({ className: 'sos-marker-pulse', iconSize: [50,50], iconAnchor:[25,25] }) }).addTo(map)
                        .bindPopup(`<b style="color:red">ğŸ†˜ ${data.senderName}</b>`).openPopup();
                    sosMarkers.push(sosM); setTimeout(() => map.removeLayer(sosM), 60000);
                    return;
                }

                if (data.type === 'chat' && data.senderId !== myUniqueId) { appendChatMsg(data.senderName, data.text, false); return; }
                
                if (data.type === 'flag_update') {
                    if (data.action === 'add') {
                        if (currentFlag) map.removeLayer(currentFlag);
                        currentFlag = L.marker([data.lat, data.lng], { icon: L.divIcon({ className: 'flag-icon', html: 'ğŸ', iconSize: [30,40], iconAnchor:[15,40] }) }).addTo(map)
                            .bindPopup(`<b>ğŸ é›†åˆ</b><br>${data.senderName}`).openPopup();
                    } else if (data.action === 'remove') { if (currentFlag) { map.removeLayer(currentFlag); currentFlag = null; } }
                    return;
                }
                
                if (data.id === myUniqueId) return;
                
                var now = Date.now(); 
                var pAvatar = data.avatar || "ğŸ“"; 
                var isZombie = !!data.isZombie; // è·å–å¯¹æ–¹æ˜¯å¦åƒµå°¸
                
                if (!otherPlayers[data.id]) {
                    var cssClass = isZombie ? 'emoji-marker-icon zombie-icon-style' : 'emoji-marker-icon other-icon-style';
                    var icon = L.divIcon({ className: cssClass, html: pAvatar, iconSize: [40, 40], iconAnchor: [20, 20] });
                    var newMarker = L.marker([data.lat, data.lng], { icon: icon }).addTo(map);
                    newMarker.bindPopup(`<b>${data.name}</b>`);
                    var newPolyline = L.polyline([], { color: isZombie ? '#722ed1' : '#ff4d4f', weight: 3, opacity: 0.6 }).addTo(map); 
                    otherPlayers[data.id] = { marker: newMarker, polyline: newPolyline, lastSeen: now, lat: data.lat, lng: data.lng, isZombie: isZombie };
                } else {
                    var p = otherPlayers[data.id]; 
                    p.marker.setLatLng([data.lat, data.lng]); 
                    p.polyline.addLatLng([data.lat, data.lng]);
                    p.lastSeen = now; p.lat = data.lat; p.lng = data.lng; p.isZombie = isZombie;
                    
                    // æ›´æ–°å¤–è§‚ (å¦‚æœå˜åƒµå°¸äº†)
                    var cssClass = isZombie ? 'emoji-marker-icon zombie-icon-style' : 'emoji-marker-icon other-icon-style';
                    p.marker.setIcon(L.divIcon({ className: cssClass, html: pAvatar, iconSize: [40, 40], iconAnchor: [20, 20] }));
                }
                updatePlayerList();
            } catch (e) {}
        }

        // ========================
        // UI & Tools
        // ========================
        var currentViewMode = 'auto';
        function setViewMode(mode, btnElement) {
            currentViewMode = mode; document.querySelectorAll('.view-opt').forEach(b => b.classList.remove('active')); if(btnElement) btnElement.classList.add('active'); applyViewMode();
        }
        function applyViewMode() {
            var isMobile = (currentViewMode === 'mobile') || (currentViewMode === 'auto' && window.innerWidth <= 600);
            if (isMobile) { document.body.classList.add('view-mobile'); if (!document.body.dataset.initMobile) { toggleChat(true); togglePlayerPanel(); document.body.dataset.initMobile = "true"; } } 
            else { document.body.classList.remove('view-mobile'); }
        }
        window.addEventListener('resize', applyViewMode);

        function togglePlayerPanel() {
            var content = document.getElementById('player-content'); var icon = document.getElementById('player-toggle-icon'); 
            content.style.display = content.style.display === 'none' ? 'block' : 'none';
            icon.innerText = content.style.display === 'none' ? "â—€" : "â–¼";
            icon.style.transform = content.style.display === 'none' ? "rotate(90deg)" : "rotate(0deg)";
        }
        function toggleChat(forceCollapse) {
            var panel = document.getElementById('chat-panel'); var icon = document.getElementById('chat-toggle-icon'); var badge = document.getElementById('chat-badge');
            if (forceCollapse === true || !panel.classList.contains('collapsed')) { panel.classList.add('collapsed'); icon.innerText = "â–²"; } else { panel.classList.remove('collapsed'); icon.innerText = "â–¼"; badge.style.display = 'none'; }
        }

        function toggleMeasure() {
            isMeasuring = !isMeasuring; var btn = document.getElementById('measure-btn');
            if(isMeasuring) { btn.classList.add('active'); btn.innerHTML = "âŒ"; document.getElementById('map').style.cursor = "crosshair"; showToast("ç‚¹å‡»ä¸¤ç‚¹æµ‹é‡"); if(isFollowing) toggleFollow(); } 
            else { btn.classList.remove('active'); btn.innerHTML = "ğŸ“"; document.getElementById('map').style.cursor = ""; clearMeasure(); }
        }
        function clearMeasure() { if(measureLine) map.removeLayer(measureLine); measureTips.forEach(t => map.removeLayer(t)); measurePoints = []; measureTips = []; }

        function toggleFollow() {
            isFollowing = !isFollowing; var btn = document.getElementById('follow-btn');
            if(isFollowing) { btn.classList.add('active'); if(myLatLng) map.flyTo(myLatLng, 18); showToast("è§†è§’è·Ÿéšå¼€å¯"); } 
            else { btn.classList.remove('active'); showToast("è§†è§’è·Ÿéšå…³é—­"); }
        }

        function onMapClick(e) {
            if (isMeasuring) {
                measurePoints.push(e.latlng);
                var tip = L.circleMarker(e.latlng, { color: '#00f3ff', radius: 4 }).addTo(map); measureTips.push(tip);
                if (measurePoints.length === 2) {
                    var p1 = measurePoints[0]; var p2 = measurePoints[1];
                    var dist = map.distance(p1, p2); var distStr = dist > 1000 ? (dist/1000).toFixed(2) + " km" : Math.round(dist) + " m";
                    measureLine = L.polyline([p1, p2], { color: '#00f3ff', weight: 2, dashArray: '5, 5' }).addTo(map);
                    measureLine.bindPopup(`<b>ğŸ“ ${distStr}</b>`).openPopup();
                    measurePoints = []; setTimeout(() => { measureTips.forEach(t => map.removeLayer(t)); measureTips = []; }, 500);
                } else if (measurePoints.length > 2) { clearMeasure(); }
            }
        }
        function onMapContextMenu(e) {
            if(isMeasuring) return;
            if(confirm("ğŸš© æ’æ——é›†åˆï¼Ÿ")) publishData({ type: 'flag_update', senderName: myName, action: 'add', lat: e.latlng.lat, lng: e.latlng.lng });
        }
        window.removeFlag = function() { if(confirm("å–æ¶ˆé›†åˆç‚¹ï¼Ÿ")) publishData({ type: 'flag_update', action: 'remove' }); };

        function handleChatKey(e) { if(e.key === 'Enter') sendChat(); }
        function sendChat() {
            var input = document.getElementById('chat-input'); var text = input.value; if(!text.trim()) return;
            publishData({ type: 'chat', senderId: myUniqueId, senderName: myName, text: text });
            appendChatMsg(myName, text, true); input.value = "";
        }
        function appendChatMsg(name, text, isMe) {
            var box = document.getElementById('chat-messages'); var div = document.createElement('div'); div.className = 'chat-msg-row';
            var senderHtml = isMe ? `<span class="chat-sender" style="color:#1890ff">æˆ‘:</span>` : `<span class="chat-sender" style="color:#ff4d4f">${name}:</span>`;
            div.innerHTML = `${senderHtml} <span class="chat-text">${text}</span>`;
            box.appendChild(div); box.scrollTop = box.scrollHeight;
            if (!isMe && document.getElementById('chat-panel').classList.contains('collapsed')) { showMsgBubble(name, text); document.getElementById('chat-badge').style.display = 'block'; }
        }
        function showMsgBubble(name, text) {
            var container = document.getElementById('msg-bubble-container'); var bubble = document.createElement('div'); bubble.className = 'msg-bubble';
            bubble.innerText = `${name}: ${text}`; container.appendChild(bubble); setTimeout(() => { bubble.style.opacity = '0'; setTimeout(() => bubble.remove(), 300); }, 3000);
        }
        function showToast(msg) {
            var t = document.getElementById('toast'); t.innerText = msg; t.style.opacity = 1;
            setTimeout(function(){ t.style.opacity = 0; }, 2500);
        }
        window.copyMyCoord = function() {
            if(!myLatLng) return;
            var text = myLatLng.lat.toFixed(6) + "," + myLatLng.lng.toFixed(6);
            navigator.clipboard.writeText(text).then(() => { alert("åæ ‡å·²å¤åˆ¶: " + text); }).catch(() => alert("å¤åˆ¶å¤±è´¥"));
        };

        function triggerQuietUpdate() { clearTimeout(debounceTimer); debounceTimer = setTimeout(function() { locateAndShare(false); }, 800); }
        document.getElementById('my-name-input').addEventListener('input', function(e) { myName = e.target.value.trim(); SafeStorage.setItem('my_nickname', myName); triggerQuietUpdate(); });
        document.getElementById('my-avatar-input').addEventListener('input', function(e) { myCurrentAvatar = e.target.value; updateMyMarkerVisuals(); triggerQuietUpdate(); });

        function updateMyMarkerVisuals() {
            if(!myMarker) return;
            var arrowHtml = `<div class="heading-arrow"></div>` + myCurrentAvatar;
            // å¦‚æœè‡ªå·±æ˜¯åƒµå°¸ï¼Œç”¨ç´«è‰²å…‰ç¯
            var cssClass = amIZombie ? 'emoji-marker-icon zombie-icon-style' : 'emoji-marker-icon my-icon-style';
            myMarker.setIcon(L.divIcon({ className: cssClass, html: arrowHtml, iconSize: [40, 40], iconAnchor: [20, 20] }));
            updateHeadingVisuals();
        }
        function updatePlayerList() {
            var container = document.getElementById('player-list-container'); container.innerHTML = ""; var hasPlayers = false;
            for (var id in otherPlayers) {
                hasPlayers = true; var p = otherPlayers[id];
                var distText = "--"; if (myLatLng) { var d = map.distance(myLatLng, [p.lat, p.lng]); distText = d > 1000 ? (d/1000).toFixed(1)+"km" : Math.round(d)+"m"; }
                
                // åƒµå°¸çŠ¶æ€æ˜¾ç¤º
                var statusHtml = p.isZombie ? `<div style="color:red;font-weight:bold;font-size:10px;">ğŸ§Ÿâ€â™‚ï¸ å·²å˜å¼‚</div>` : "";
                var item = document.createElement('div'); item.className = 'player-item';
                item.innerHTML = `<div class="player-info"><div class="player-head"><span>${p.avatar || 'ğŸ“'}</span><span>${p.name}</span></div>${statusHtml}</div><div class="player-dist">${distText}</div>`;
                (function(targetLat, targetLng) { item.onclick = function() { map.flyTo([targetLat, targetLng], 18); }; })(p.lat, p.lng);
                container.appendChild(item);
            }
            if (!hasPlayers) container.innerHTML = '<div style="font-size:12px; color:#ccc; text-align:center; padding:10px;">æš‚æ— å…¶ä»–äºº</div>';
        }

        function locateAndShare(showAlert = false) { 
            map.locate({ setView: false, maxZoom: 17, timeout: 30000, enableHighAccuracy: true, maximumAge: 0 }); 
            if(showAlert) showToast("æ­£åœ¨åˆ·æ–°ä½ç½®..."); 
        }
        function triggerManualLocate() { locateAndShare(true); }
        var isFirstLocate = true;
        
        function onLocationFound(e) {
            myLatLng = e.latlng; 
            if (isFollowing) map.panTo(myLatLng);
            if (!myPolyline) myPolyline = L.polyline([], { color: '#3388ff', weight: 4, opacity: 0.8 }).addTo(map); 
            myPolyline.addLatLng(e.latlng);
            if (!myMarker) { 
                var arrowHtml = `<div class="heading-arrow"></div>` + myCurrentAvatar;
                myMarker = L.marker(e.latlng, { icon: L.divIcon({ className: 'emoji-marker-icon my-icon-style', html: arrowHtml, iconSize: [40, 40], iconAnchor: [20, 20] }) }).addTo(map)
                    .bindPopup(`<b>æˆ‘</b><br><button onclick="copyMyCoord()" style="font-size:11px;margin-top:5px;">ğŸ“‹ å¤åˆ¶åæ ‡</button>`).openPopup(); 
                if(amIZombie) updateMyMarkerVisuals(); // ä¿æŒåƒµå°¸çŠ¶æ€å¤–è§‚
            } else myMarker.setLatLng(e.latlng);
            if (isFirstLocate) { map.setView(e.latlng, 17); isFirstLocate = false; }
            publishData({ type: 'player_update', id: myUniqueId, name: myName, lat: e.latlng.lat, lng: e.latlng.lng, avatar: myCurrentAvatar });
        }

        if (window.DeviceOrientationEvent) {
            window.addEventListener('deviceorientation', function(event) {
                if (event.alpha !== null) {
                    var heading = event.webkitCompassHeading || (360 - event.alpha);
                    myHeading = heading; updateHeadingVisuals();
                }
            }, true);
        }
        function updateHeadingVisuals() {
            var arrow = document.querySelector('.emoji-marker-icon .heading-arrow');
            if(arrow) { arrow.style.display = 'block'; arrow.style.transform = `translateX(-50%) rotate(${myHeading}deg)`; }
        }
    </script>
</body>
</html>
