<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MOUYU Game Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; }
        
        /* ========================
           ğŸ” 1. å…¨ç«™é—¨ç¦æ ·å¼
           ======================== */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
            flex-direction: column; color: white;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 320px;
            text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .login-title { color: #333; font-size: 20px; font-weight: bold; margin-bottom: 20px; }
        .login-input {
            width: 100%; padding: 12px; font-size: 16px; border: 2px solid #eee; border-radius: 8px;
            margin-bottom: 15px; text-align: center; outline: none; transition: 0.3s;
        }
        .login-input:focus { border-color: #1890ff; }
        .login-btn {
            width: 100%; padding: 12px; background: #1890ff; color: white; border: none;
            border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;
        }

        /* ========================
           ğŸ•¹ï¸ æ¸¸æˆç›¸å…³ UI
           ======================== */
        .game-btn { position: absolute; bottom: 200px; right: 20px; z-index: 999; width: 50px; height: 50px; border-radius: 50%; font-size: 24px; background: #722ed1; color: white; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
        .game-btn:active { transform: scale(0.9); }

        /* æ¸¸æˆé€‰æ‹©é¢æ¿ */
        .game-panel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; background: white; border-radius: 16px; padding: 20px;
            z-index: 2000; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none;
            animation: fadeIn 0.3s;
        }
        .game-panel h3 { margin: 0 0 15px 0; text-align: center; color: #333; }
        .game-option {
            padding: 12px; border: 2px solid #eee; border-radius: 10px; margin-bottom: 10px;
            cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s;
        }
        .game-option:hover { background: #f9f9f9; }
        .game-option.active { border-color: #722ed1; background: #f9f0ff; color: #722ed1; font-weight: bold; }
        .game-icon { font-size: 20px; }
        .close-game-panel { margin-top: 10px; width: 100%; padding: 10px; background: #eee; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* ç”ŸåŒ–å±æœºçŠ¶æ€æ  */
        #biohazard-hud {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 30px;
            z-index: 1000; display: none; font-size: 14px; font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.4); border: 2px solid #ff4d4f;
            display: flex; gap: 15px; align-items: center;
        }
        .hud-item { display: flex; align-items: center; gap: 5px; }
        .be-zombie-btn {
            background: #ff4d4f; border: none; color: white; padding: 4px 10px; border-radius: 15px;
            font-size: 12px; font-weight: bold; cursor: pointer; animation: pulse 2s infinite;
        }
        
        /* æ„ŸæŸ“ç‰¹æ•ˆ */
        @keyframes infected-screen { 
            0% { box-shadow: inset 0 0 0 0 rgba(255,0,0,0); }
            50% { box-shadow: inset 0 0 50px 20px rgba(255,0,0,0.8); }
            100% { box-shadow: inset 0 0 0 0 rgba(255,0,0,0); }
        }
        .infected-fx { animation: infected-screen 1s ease-out; }

        /* é€šç”¨UI */
        .map-btn {
            background: white; border: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            padding: 8px 12px; font-size: 13px; font-weight: 600; color: #333; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .map-btn.active { background: #e6f7ff; color: #1890ff; border: 1px solid #1890ff; }
        .locate-btn { position: absolute; bottom: 40px; right: 20px; z-index: 999; padding: 12px 20px; border-radius: 50px; }
        .follow-btn { position: absolute; bottom: 100px; right: 20px; z-index: 999; width: 40px; height: 40px; border-radius: 50%; font-size: 18px; }
        .measure-btn { position: absolute; bottom: 150px; right: 20px; z-index: 999; width: 40px; height: 40px; border-radius: 50%; font-size: 18px; }

        .player-list-panel {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px);
            padding: 15px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            width: 260px; max-height: 70vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.5);
            transition: all 0.3s ease;
        }
        @media (max-width: 600px) {
            .player-list-panel { width: 200px; top: 10px; right: 10px; padding: 10px; }
            .locate-btn { bottom: 30px; right: 10px; } .follow-btn { bottom: 90px; right: 10px; } .measure-btn { bottom: 135px; right: 10px; } .game-btn { bottom: 185px; right: 10px; width: 40px; height: 40px; font-size: 20px; }
            .room-setting-box { padding: 6px !important; }
            .room-input-row { flex-direction: column; align-items: flex-start !important; gap: 4px !important; }
            .room-input-row .setting-label { width: 100% !important; margin-bottom: 2px; }
            .room-input-row input { width: 100% !important; }
        }

        .panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 10px; cursor: pointer; }
        .panel-title { font-size: 14px; font-weight: 700; color: #1a1a1a; margin: 0; }
        
        .chat-panel {
            position: absolute; bottom: 30px; left: 20px; z-index: 1000;
            width: 280px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; transition: width 0.3s, transform 0.3s;
        }
        @media (max-width: 600px) { .chat-panel { width: 70%; left: 10px; bottom: 80px; } }
        
        .chat-header { background: #f0f2f5; padding: 10px 12px; font-size: 12px; font-weight: bold; color: #666; display: flex; justify-content: space-between; cursor: pointer; border-radius: 12px 12px 0 0; }
        .chat-panel.collapsed .chat-content-wrapper { display: none; }
        .chat-messages { height: 150px; overflow-y: auto; padding: 10px; font-size: 12px; background: white; }
        .chat-input-area { display: flex; padding: 8px; border-top: 1px solid #eee; background: #fff; border-radius: 0 0 12px 12px; align-items: center; }
        .chat-input { flex: 1; border: 1px solid #ddd; border-radius: 4px; padding: 6px 8px; font-size: 12px; outline: none; min-width: 0; }
        .chat-send-btn { margin-left: 6px; background: #1890ff; color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 12px; white-space: nowrap; }

        .user-setting-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .setting-label { font-size: 12px; color: #666; width: 30px; flex-shrink: 0; }
        .avatar-input { width: 40px; text-align: center; border: 1px solid #ddd; border-radius: 8px; padding: 5px; font-size: 16px; background: #f9f9f9; }
        .status-input { flex: 1; border: 1px solid #ddd; border-radius: 8px; padding: 6px; font-size: 12px; background: #f9f9f9; }
        .id-input { flex: 1; border: 1px solid #ddd; border-radius: 8px; padding: 6px; font-size: 12px; background: #f9f9f9; font-weight: bold; color: #333; }
        .gpx-btn { width: 100%; background: #28a745; color: white; border: none; border-radius: 6px; padding: 8px; font-size: 12px; font-weight: bold; cursor: pointer; text-align: center; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .view-switch { display: flex; gap: 5px; background: #eee; padding: 2px; border-radius: 6px; flex: 1; }
        .view-opt { flex: 1; text-align: center; font-size: 11px; padding: 4px 0; cursor: pointer; border-radius: 4px; color: #666; }
        .view-opt.active { background: white; color: #3388ff; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .player-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; margin-bottom: 6px; background: #f8f9fa; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .player-head { display: flex; align-items: center; gap: 5px; font-weight: 600; font-size: 13px; color: #333; }
        .player-status-text { font-size: 11px; color: #666; margin-top: 2px; }
        .player-dist { font-size: 11px; color: #888; }
        
        .emoji-marker-icon { position: relative; display: flex; justify-content: center; align-items: center; background: white; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.3); border: 2px solid white; font-size: 24px; transition: all 0.3s ease; }
        .my-icon-style { border-color: #3388ff; z-index: 1000 !important; }
        .other-icon-style { border-color: #ff4d4f; }
        /* åƒµå°¸æ ·å¼ */
        .zombie-style { border-color: #ff0000 !important; background: #330000 !important; color: white !important; box-shadow: 0 0 15px rgba(255,0,0,0.8) !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        .heading-arrow { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid #3388ff; z-index: -1; display: none; }
        .flag-icon { font-size: 30px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); animation: bounce 1s infinite; }
        .status-bubble { background: white; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border-radius: 4px; padding: 2px 6px; font-size: 12px; font-weight: bold; color: #333; margin-bottom: 5px; }
        .leaflet-tooltip-bottom:before { display: none; }
        
        .msg-bubble-container { position: absolute; bottom: 45px; left: 0; width: 100%; pointer-events: none; display: flex; flex-direction: column-reverse; align-items: flex-start; }
        .msg-bubble { background: rgba(0, 0, 0, 0.75); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; margin-bottom: 5px; max-width: 80%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; animation: fadeUp 0.3s ease-out; margin-left: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .chat-badge { display: none; width: 8px; height: 8px; background: #ff4d4f; border-radius: 50%; margin-right: 5px; }
        .toast-tip { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 8px; font-size: 14px; pointer-events: none; opacity: 0; transition: opacity 0.5s; z-index: 2000; }
        .leaflet-control-scale { margin-bottom: 5px !important; margin-left: 10px !important; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <div style="font-size: 40px; margin-bottom: 10px;">ğŸ”’</div>
            <div class="login-title">MOUYU Game System</div>
            <input type="password" id="site-password" class="login-input" placeholder="è¾“å…¥è®¿é—®å¯†ç ..." onkeypress="if(event.key==='Enter') checkSitePassword()">
            <button class="login-btn" onclick="checkSitePassword()">Enter System</button>
            <div id="login-error" style="color:red; font-size:12px; margin-top:10px; opacity:0; transition:opacity 0.3s;">å¯†ç é”™è¯¯</div>
        </div>
    </div>

    <div id="toast" class="toast-tip"></div>

    <button class="game-btn" onclick="toggleGamePanel()" title="æ¸¸æˆèœå•">ğŸ®</button>
    
    <div class="game-panel" id="game-menu">
        <h3>ğŸ® é€‰æ‹©æ¸¸æˆæ¨¡å¼</h3>
        <div class="game-option active" id="mode-none" onclick="switchGameMode('none')">
            <span class="game-icon">ğŸ³ï¸</span> 
            <div>å’Œå¹³æ¨¡å¼<div style="font-size:10px; color:#999;">ä»…å…±äº«ä½ç½®ï¼Œæ— è§„åˆ™</div></div>
        </div>
        <div class="game-option" id="mode-biohazard" onclick="switchGameMode('biohazard')">
            <span class="game-icon">ğŸ§Ÿ</span>
            <div>ç”ŸåŒ–å±æœº<div style="font-size:10px; color:#999;">åƒµå°¸æŠ“äººï¼Œé è¿‘æ„ŸæŸ“</div></div>
        </div>
        <div class="game-option" style="opacity:0.5; cursor:not-allowed;">
            <span class="game-icon">ğŸ´</span> æ¶‚é¸¦æˆ˜äº‰ (å¼€å‘ä¸­)
        </div>
        <div class="game-option" style="opacity:0.5; cursor:not-allowed;">
            <span class="game-icon">ğŸ“¦</span> å¯»å®çŒäºº (å¼€å‘ä¸­)
        </div>
        <div class="game-option" style="opacity:0.5; cursor:not-allowed;">
            <span class="game-icon">ğŸ•µï¸</span> è°æ˜¯å§åº• (å¼€å‘ä¸­)
        </div>
        <button class="close-game-panel" onclick="toggleGamePanel()">å…³é—­</button>
    </div>

    <div id="biohazard-hud" style="display:none;">
        <div class="hud-item">ğŸ§Ÿ <span id="zombie-count">0</span></div>
        <div class="hud-item">ğŸƒ <span id="human-count">0</span></div>
        <div class="hud-item" style="border-left:1px solid #666; padding-left:10px;">
            <button class="be-zombie-btn" onclick="becomeZombie()">æˆ‘è¦å˜å¼‚!</button>
        </div>
    </div>

    <div class="player-list-panel" id="player-panel">
        <div class="panel-header" onclick="togglePlayerPanel()">
            <div class="panel-title">ğŸ“¡ MOUYUåœ°å›¾</div>
            <div class="toggle-icon" id="player-toggle-icon">â–¼</div>
        </div>
        <div class="panel-content" id="player-content">
            <div class="room-setting-box" style="background: #e6f7ff; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #91d5ff;">
                <div class="user-setting-row room-input-row">
                    <span class="setting-label" style="font-weight:bold; color:#0050b3;">æˆ¿é—´</span>
                    <input type="text" id="room-input" class="id-input" value="å¤§å…" placeholder="æˆ¿é—´å" style="background:white;">
                </div>
                <div class="user-setting-row room-input-row">
                    <span class="setting-label" style="font-weight:bold; color:#0050b3;">å¯†ç </span>
                    <input type="text" id="pass-input" class="status-input" placeholder="åŠ å¯†(å¯é€‰)" style="background:white;">
                </div>
                <button class="gpx-btn" onclick="joinRoom()" style="background:#1890ff; margin-top:5px; height: 32px; line-height: 1;">ğŸšª è¿›å…¥æˆ¿é—´</button>
            </div>
            
            <div style="padding-bottom: 10px; border-bottom: 1px dashed #eee; margin-bottom: 10px;">
                <div class="user-setting-row">
                    <span class="setting-label">è§†å›¾</span>
                    <div class="view-switch">
                        <div class="view-opt active" onclick="setViewMode('auto', this)">è‡ªåŠ¨</div>
                        <div class="view-opt" onclick="setViewMode('mobile', this)">æ‰‹æœº</div>
                        <div class="view-opt" onclick="setViewMode('pc', this)">ç”µè„‘</div>
                    </div>
                </div>
                <div class="user-setting-row">
                    <span class="setting-label">æ˜µç§°</span>
                    <input type="text" id="my-name-input" class="id-input" value="" placeholder="è¾“å…¥åå­—" maxlength="10">
                </div>
                <div class="user-setting-row">
                    <span class="setting-label">å½¢è±¡</span>
                    <input type="text" id="my-avatar-input" class="avatar-input" value="ğŸ˜¼" maxlength="2">
                </div>
            </div>
            <div id="player-list-container">
                <div style="font-size:12px; color:#ccc; text-align:center; padding:10px;">æ‰«æä¸­...</div>
            </div>
            <div class="my-status" id="my-status-text">è¿æ¥ä¸­...</div>
        </div>
    </div>

    <div class="chat-panel" id="chat-panel">
        <div class="msg-bubble-container" id="msg-bubble-container"></div>
        <div class="chat-header" onclick="toggleChat()">
            <div style="display:flex; align-items:center;">
                <div class="chat-badge" id="chat-badge"></div>
                <span>ğŸ’¬ é¢‘é“</span>
            </div>
            <span id="chat-toggle-icon">â–¼</span>
        </div>
        <div class="chat-content-wrapper" id="chat-content-wrapper">
            <div class="chat-messages" id="chat-messages">
                <div class="chat-msg-row" style="color:#999; font-style:italic;">æ¬¢è¿æ¥åˆ°èŠå¤©å®¤...</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" class="chat-input" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." onkeypress="handleChatKey(event)">
                <button class="chat-send-btn" onclick="sendChat()">å‘é€</button>
            </div>
        </div>
    </div>

    <div id="map"></div>
    
    <button class="map-btn measure-btn" id="measure-btn" onclick="toggleMeasure()" title="æµ‹é‡è·ç¦»">ğŸ“</button>
    <button class="map-btn follow-btn" id="follow-btn" onclick="toggleFollow()" title="è§†è§’è·Ÿéš">ğŸ”„</button>
    <button class="map-btn locate-btn" onclick="triggerManualLocate()">ğŸ“ å®šä½æˆ‘</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <script>
        // ============================================
        // ğŸ” ç½‘ç«™é—¨ç¦é€»è¾‘ (è®°å¾—ä¿®æ”¹å¯†ç ï¼)
        // ============================================
        var SITE_PASSWORD = "666"; // <--- ä¿®æ”¹è¿™é‡Œ
        var isSystemUnlocked = false;

        function checkSitePassword() {
            var input = document.getElementById('site-password').value;
            if (input === SITE_PASSWORD) {
                document.getElementById('login-overlay').style.display = 'none';
                isSystemUnlocked = true;
                startApp(); 
            } else {
                var err = document.getElementById('login-error');
                err.style.opacity = 1;
                setTimeout(function() { err.style.opacity = 0; }, 2000);
            }
        }
        
        // ============================================
        // ğŸŒ å…¨å±€å˜é‡
        // ============================================
        var map, client, satellite, streetMap, darkMap;
        var myUniqueId, myName;
        var otherPlayers = {}; var myLatLng = null; var myMarker = null; var myPolyline = null;
        var myCurrentAvatar = "ğŸ˜¼"; var myCurrentStatus = ""; var currentFlag = null; 
        var isMeasuring = false; var measurePoints = []; var measureLine = null; var measureTips = [];
        var isFollowing = false; var myHeading = 0; 
        var currentTopic = ""; 
        var debounceTimer = null;
        
        // ğŸ•¹ï¸ æ¸¸æˆå˜é‡
        var currentGameMode = "none"; // none, biohazard, turf, treasure, amongus
        var myGameRole = "human"; // human, zombie
        var gameLoopInterval = null;

        function startApp() {
            // åˆå§‹åŒ–åœ°å›¾å›¾å±‚
            darkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 20 });
            satellite = L.layerGroup([
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 }),
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 })
            ]);
            streetMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: 'Â© CartoDB', maxZoom: 20 });

            // é»˜è®¤å«æ˜Ÿå›¾
            map = L.map('map', { center: [35.8617, 104.1954], zoom: 4, layers: [satellite], zoomControl: false });
            L.control.zoom({position: 'topleft'}).addTo(map);
            L.control.layers({ "ğŸ›°ï¸ å«æ˜Ÿå›¾": satellite, "ğŸŒ‘ å¤œé—´æ¨¡å¼": darkMap, "â˜€ï¸ è¡—é“å›¾": streetMap }).addTo(map);
            L.control.scale({ imperial: false, maxWidth: 200 }).addTo(map);
            
            // ç”¨æˆ·ä¿¡æ¯
            myUniqueId = localStorage.getItem('my_unique_id');
            if (!myUniqueId) {
                myUniqueId = "uid_" + Date.now() + "_" + Math.floor(Math.random() * 10000);
                localStorage.setItem('my_unique_id', myUniqueId);
            }
            myName = localStorage.getItem('my_nickname');
            if (!myName) { myName = "ç¥ç§˜äºº" + Math.floor(Math.random() * 100); }
            document.getElementById('my-name-input').value = myName;
            
            // è¿æ¥ MQTT
            client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
            client.on('connect', function () { console.log('âœ… MQTT Connected'); joinRoom(); });
            client.on('message', handleMqttMessage);
            
            // åœ°å›¾äº‹ä»¶
            map.on('click', onMapClick);
            map.on('dragstart', function() { if(isFollowing) toggleFollow(); });
            map.on('contextmenu', onMapContextMenu);
            map.on('locationfound', onLocationFound);
            
            // å¯åŠ¨å®šä½
            locateAndShare(false); 
            setInterval(() => locateAndShare(false), 2000); // æ¸¸æˆæ¨¡å¼éœ€è¦æ›´å¿«çš„åˆ·æ–°é¢‘ç‡(2s)
            
            // å¯åŠ¨æ¸…ç† & æ¸¸æˆå¾ªç¯
            gameLoopInterval = setInterval(gameLoop, 1000); 

            applyViewMode();
        }

        // ========================
        // ğŸ® æ¸¸æˆé€»è¾‘å¼•æ“
        // ========================
        function toggleGamePanel() {
            var p = document.getElementById('game-menu');
            p.style.display = (p.style.display === 'block') ? 'none' : 'block';
        }

        function switchGameMode(mode) {
            currentGameMode = mode;
            // UI æ›´æ–°
            document.querySelectorAll('.game-option').forEach(el => el.classList.remove('active'));
            document.getElementById('mode-' + mode).classList.add('active');
            toggleGamePanel(); // å…³é—­é¢æ¿

            // çŠ¶æ€é‡ç½®
            myGameRole = "human";
            updateMyMarkerVisuals();
            
            if (mode === 'none') {
                showToast("å·²åˆ‡æ¢è‡³ï¼šå’Œå¹³æ¨¡å¼");
                document.getElementById('biohazard-hud').style.display = 'none';
            } else if (mode === 'biohazard') {
                showToast("âš ï¸ ç”ŸåŒ–å±æœºæ¨¡å¼å·²å¯åŠ¨ï¼");
                document.getElementById('biohazard-hud').style.display = 'flex';
                // å¹¿æ’­æˆ‘åˆ‡æ¢äº†æ¨¡å¼
                triggerManualLocate();
            }
        }

        function gameLoop() {
            // æ¸…ç†ç¦»çº¿ç©å®¶
            var now = Date.now();
            var listChanged = false;
            var zombieCount = 0;
            var humanCount = 0;

            for (var id in otherPlayers) {
                // è¶…æ—¶æ¸…ç†
                if (now - otherPlayers[id].lastSeen > 10000) { 
                    map.removeLayer(otherPlayers[id].marker); 
                    if(otherPlayers[id].polyline) map.removeLayer(otherPlayers[id].polyline); 
                    delete otherPlayers[id]; 
                    listChanged = true; 
                    continue;
                }
                
                // ç»Ÿè®¡äººæ•°
                if (otherPlayers[id].gameRole === 'zombie') zombieCount++; else humanCount++;

                // --- ğŸ§Ÿ ç”ŸåŒ–å±æœºåˆ¤å®šé€»è¾‘ ---
                if (currentGameMode === 'biohazard' && myGameRole === 'human') {
                    if (otherPlayers[id].gameRole === 'zombie' && myLatLng) {
                        var dist = map.distance(myLatLng, [otherPlayers[id].lat, otherPlayers[id].lng]);
                        if (dist < 15) { // 15ç±³å†…è¢«æ„ŸæŸ“
                            becomeZombie("ğŸ˜­ è¢« " + otherPlayers[id].name + " æ„ŸæŸ“äº†ï¼");
                        }
                    }
                }
            }

            if(listChanged) updatePlayerList();
            
            // æ›´æ–° HUD
            if (myGameRole === 'zombie') zombieCount++; else humanCount++;
            document.getElementById('zombie-count').innerText = zombieCount;
            document.getElementById('human-count').innerText = humanCount;
        }

        function becomeZombie(reason) {
            if (myGameRole === 'zombie') return;
            myGameRole = 'zombie';
            
            // è§†è§‰ç‰¹æ•ˆ
            document.body.classList.add('infected-fx');
            setTimeout(() => document.body.classList.remove('infected-fx'), 1000);
            
            // æç¤º
            if (reason) alert(reason); else showToast("ğŸ§Ÿ ä½ å˜æˆäº†æ¯ä½“åƒµå°¸ï¼å»æ„ŸæŸ“åˆ«äººï¼");
            
            // å¹¿æ’­çŠ¶æ€
            updateMyMarkerVisuals();
            triggerManualLocate();
        }

        function showToast(msg) {
            var t = document.getElementById('toast');
            t.innerText = msg; t.style.opacity = 1;
            setTimeout(function(){ t.style.opacity = 0; }, 3000);
        }

        // ========================
        // ğŸ  æˆ¿é—´ä¸é€šè®¯
        // ========================
        function getTopic(room, pass) {
            if (!room) room = "å¤§å…";
            var safeRoom = encodeURIComponent(room);
            var safePass = pass ? "_" + encodeURIComponent(pass) : "";
            return 'mouyu/game/' + safeRoom + safePass; // Topicæ”¹åä¸º mouyu/game
        }

        function joinRoom() {
            var room = document.getElementById('room-input').value.trim();
            var pass = document.getElementById('pass-input').value.trim();
            var newTopic = getTopic(room, pass);

            if (currentTopic === newTopic) { alert("å·²åœ¨æˆ¿é—´ä¸­"); return; }
            if (currentTopic && client.connected) {
                client.unsubscribe(currentTopic);
                for(var id in otherPlayers) { map.removeLayer(otherPlayers[id].marker); if(otherPlayers[id].polyline) map.removeLayer(otherPlayers[id].polyline); }
                otherPlayers = {}; updatePlayerList();
                if(currentFlag) { map.removeLayer(currentFlag); currentFlag = null; }
            }
            currentTopic = newTopic;
            if (client.connected) {
                client.subscribe(currentTopic);
                client.publish(currentTopic, JSON.stringify({ type: 'chat', senderId: 'SYS', senderName: 'ç³»ç»Ÿ', text: `${myName} åŠ å…¥æˆ¿é—´` }));
                triggerManualLocate();
            }
            showToast("âœ… è¿›å…¥æˆ¿é—´: " + room);
            document.querySelector('.panel-title').innerText = "ğŸ“¡ æˆ¿é—´: " + room;
        }

        function handleMqttMessage(topic, message) {
            try {
                var data = JSON.parse(message.toString());
                if (data.type === 'chat') { if (data.senderId !== myUniqueId) appendChatMsg(data.senderName, data.text, false); return; }
                if (data.type === 'flag_update') {
                    if (data.action === 'add') {
                        if (currentFlag) map.removeLayer(currentFlag);
                        var flagIcon = L.divIcon({ className: 'flag-icon', html: 'ğŸ', iconSize: [30, 40], iconAnchor: [15, 40] });
                        currentFlag = L.marker([data.lat, data.lng], { icon: flagIcon }).addTo(map).bindPopup(`<b>ğŸ é›†åˆ</b><br>å‘èµ·: ${data.senderName}<br><button onclick="removeFlag()">æ‹”æ‰</button>`).openPopup();
                    } else if (data.action === 'remove') { if (currentFlag) { map.removeLayer(currentFlag); currentFlag = null; } }
                    return;
                }
                if (data.id === myUniqueId) return;
                
                var now = Date.now(); 
                var pAvatar = data.avatar || "ğŸ“"; 
                var pRole = data.gameRole || "human"; // è·å–å¯¹æ–¹æ¸¸æˆè§’è‰²
                
                // æ›´æ–°å¯¹æ–¹æ•°æ®
                if (!otherPlayers[data.id]) {
                    // æ–°ç©å®¶
                    var marker = L.marker([data.lat, data.lng]).addTo(map);
                    var polyline = L.polyline([], { color: '#00ff00', weight: 3, opacity: 0.8 }).addTo(map);
                    
                    otherPlayers[data.id] = { marker: marker, polyline: polyline, lastSeen: now, lat: data.lat, lng: data.lng, avatar: pAvatar, name: data.name, gameRole: pRole };
                    updateOtherMarkerStyle(data.id); // è®¾ç½®åˆå§‹æ ·å¼
                } else {
                    // å·²æœ‰ç©å®¶æ›´æ–°
                    var p = otherPlayers[data.id];
                    p.marker.setLatLng([data.lat, data.lng]); 
                    p.polyline.addLatLng([data.lat, data.lng]);
                    p.lastSeen = now; p.lat = data.lat; p.lng = data.lng; p.avatar = pAvatar; p.name = data.name;
                    
                    // å¦‚æœå¯¹æ–¹è§’è‰²å˜äº†ï¼ˆæ¯”å¦‚å˜åƒµå°¸äº†ï¼‰ï¼Œæ›´æ–°æ ·å¼
                    if (p.gameRole !== pRole) {
                        p.gameRole = pRole;
                        updateOtherMarkerStyle(data.id);
                    }
                }
                updatePlayerList();
            } catch (e) {}
        }

        // æ›´æ–°ä»–äººæ ·å¼ï¼ˆåŒºåˆ†äººç±»/åƒµå°¸ï¼‰
        function updateOtherMarkerStyle(id) {
            var p = otherPlayers[id];
            var isZombie = (currentGameMode === 'biohazard' && p.gameRole === 'zombie');
            
            var cssClass = isZombie ? 'emoji-marker-icon zombie-style' : 'emoji-marker-icon other-icon-style';
            var displayAvatar = isZombie ? 'ğŸ§Ÿ' : p.avatar;
            
            var icon = L.divIcon({ className: cssClass, html: displayAvatar, iconSize: [40, 40], iconAnchor: [20, 20] });
            p.marker.setIcon(icon);
            p.marker.unbindPopup().bindPopup(isZombie ? "ğŸ§Ÿ åƒµå°¸: " + p.name : "ğŸš© " + p.name);
            
            // è½¨è¿¹çº¿é¢œè‰²
            p.polyline.setStyle({ color: isZombie ? '#ff0000' : '#00ff00' });
        }

        // ========================
        // ğŸ› ï¸ åŸºç¡€åŠŸèƒ½
        // ========================
        function triggerQuietUpdate() { clearTimeout(debounceTimer); debounceTimer = setTimeout(function() { locateAndShare(false); }, 800); }
        document.getElementById('my-name-input').addEventListener('input', function(e) { myName = e.target.value.trim(); localStorage.setItem('my_nickname', myName); triggerQuietUpdate(); });
        document.getElementById('my-avatar-input').addEventListener('input', function(e) { myCurrentAvatar = e.target.value; updateMyMarkerVisuals(); triggerQuietUpdate(); });

        function updateMyMarkerVisuals() {
            if(!myMarker) return;
            var isZombie = (currentGameMode === 'biohazard' && myGameRole === 'zombie');
            
            var cssClass = isZombie ? 'emoji-marker-icon zombie-style' : 'emoji-marker-icon my-icon-style';
            var displayAvatar = isZombie ? 'ğŸ§Ÿ' : myCurrentAvatar;
            var arrowHtml = `<div class="heading-arrow"></div>` + displayAvatar;

            myMarker.setIcon(L.divIcon({ className: cssClass, html: arrowHtml, iconSize: [40, 40], iconAnchor: [20, 20] }));
            
            if (isZombie) {
                myPolyline.setStyle({ color: '#ff0000' }); 
            } else {
                myPolyline.setStyle({ color: '#3388ff' });
            }
            updateHeadingVisuals();
        }

        function locateAndShare(showAlert = false) { map.locate({ setView: false, maxZoom: 17, timeout: 30000, enableHighAccuracy: true, maximumAge: 0 }); if(showAlert) alert("æ­£åœ¨åˆ·æ–°ä½ç½®..."); }
        function triggerManualLocate() { locateAndShare(true); }
        var isFirstLocate = true;
        
        function onLocationFound(e) {
            myLatLng = e.latlng; 
            if (isFollowing) map.panTo(myLatLng);
            if (!myPolyline) myPolyline = L.polyline([], { color: '#3388ff', weight: 4, opacity: 0.8 }).addTo(map); myPolyline.addLatLng(e.latlng);
            if (!myMarker) { 
                var arrowHtml = `<div class="heading-arrow"></div>` + myCurrentAvatar;
                myMarker = L.marker(e.latlng, { icon: L.divIcon({ className: 'emoji-marker-icon my-icon-style', html: arrowHtml, iconSize: [40, 40], iconAnchor: [20, 20] }) }).addTo(map).bindPopup("<b>æˆ‘</b>").openPopup(); 
            } else myMarker.setLatLng(e.latlng);
            
            // æ¯æ¬¡ä½ç½®æ›´æ–°éƒ½æ£€æŸ¥æ ·å¼ï¼ˆé˜²æ­¢åˆ‡æ¨¡å¼åæ ·å¼æ²¡å˜ï¼‰
            updateMyMarkerVisuals();

            if (isFirstLocate) { map.setView(e.latlng, 17); isFirstLocate = false; }
            
            // å‘é€æ•°æ®åŒ… (åŒ…å« gameRole)
            client.publish(currentTopic, JSON.stringify({ 
                type: 'player_update', id: myUniqueId, name: myName, 
                lat: e.latlng.lat, lng: e.latlng.lng, 
                avatar: myCurrentAvatar, 
                gameRole: myGameRole // å…³é”®ï¼šåŒæ­¥æˆ‘çš„èº«ä»½
            }));
        }

        function updatePlayerList() {
            var container = document.getElementById('player-list-container'); container.innerHTML = ""; var hasPlayers = false;
            for (var id in otherPlayers) {
                hasPlayers = true; var p = otherPlayers[id];
                var distText = "--"; if (myLatLng) { var d = map.distance(myLatLng, [p.lat, p.lng]); d > 1000 ? distText = (d/1000).toFixed(1)+"km" : distText = Math.round(d)+"m"; }
                
                var roleIcon = (p.gameRole === 'zombie') ? 'ğŸ§Ÿ' : 'ğŸ˜€';
                
                var item = document.createElement('div'); item.className = 'player-item';
                item.innerHTML = `<div class="player-info"><div class="player-head"><span>${roleIcon}</span><span>${p.name}</span></div></div><div class="player-dist">${distText}</div>`;
                (function(targetLat, targetLng) { item.onclick = function() { map.flyTo([targetLat, targetLng], 18, { duration: 1.5 }); }; })(p.lat, p.lng);
                container.appendChild(item);
            }
            if (!hasPlayers) container.innerHTML = '<div style="font-size:12px; color:#ccc; text-align:center; padding:10px;">æš‚æ— å…¶ä»–äºº</div>';
        }

        // View Mode & Chat (ä¿æŒåŸæ ·)
        var currentViewMode = 'auto';
        function setViewMode(mode, btnElement) { currentViewMode = mode; document.querySelectorAll('.view-opt').forEach(b => b.classList.remove('active')); if(btnElement) btnElement.classList.add('active'); applyViewMode(); }
        function applyViewMode() { var body = document.body; var isMobile = (currentViewMode === 'mobile') || (currentViewMode === 'auto' && window.innerWidth <= 600); if (isMobile) { body.classList.add('view-mobile'); if (!body.dataset.initMobile) { toggleChat(true); togglePlayerPanel(true); body.dataset.initMobile = "true"; } } else { body.classList.remove('view-mobile'); } }
        window.addEventListener('resize', function() { if (currentViewMode === 'auto') applyViewMode(); });
        function togglePlayerPanel() { var c = document.getElementById('player-content'); var i = document.getElementById('player-toggle-icon'); if (c.style.display === 'none') { c.style.display = 'block'; i.innerText = "â–¼"; i.style.transform = "rotate(0deg)"; } else { c.style.display = 'none'; i.innerText = "â—€"; i.style.transform = "rotate(90deg)"; } }
        function toggleChat() { var p = document.getElementById('chat-panel'); var i = document.getElementById('chat-toggle-icon'); if (p.classList.contains('collapsed')) { p.classList.remove('collapsed'); i.innerText = "â–¼"; document.getElementById('chat-badge').style.display = 'none'; } else { p.classList.add('collapsed'); i.innerText = "â–²"; } }
        function toggleMeasure() { isMeasuring = !isMeasuring; var btn = document.getElementById('measure-btn'); if(isMeasuring) { btn.classList.add('active'); btn.innerHTML = "âŒ"; document.getElementById('map').style.cursor = "crosshair"; alert("ç‚¹å‡»åœ°å›¾ä¸¤ç‚¹æµ‹é‡"); } else { btn.classList.remove('active'); btn.innerHTML = "ğŸ“"; document.getElementById('map').style.cursor = ""; clearMeasure(); } }
        function clearMeasure() { if(measureLine) map.removeLayer(measureLine); measureTips.forEach(t => map.removeLayer(t)); measurePoints = []; measureTips = []; }
        function toggleFollow() { isFollowing = !isFollowing; var btn = document.getElementById('follow-btn'); if(isFollowing) { btn.classList.add('active'); if(myLatLng) map.flyTo(myLatLng, 18); showToast("è§†è§’è·Ÿéšå·²å¼€å¯"); } else { btn.classList.remove('active'); showToast("è§†è§’è·Ÿéšå·²å…³é—­"); } }
        function onMapClick(e) { if (isMeasuring) { measurePoints.push(e.latlng); var tip = L.circleMarker(e.latlng, { color: '#00f3ff', radius: 4 }).addTo(map); measureTips.push(tip); if (measurePoints.length === 2) { var d = map.distance(measurePoints[0], measurePoints[1]); var s = d > 1000 ? (d/1000).toFixed(2) + " km" : Math.round(d) + " m"; measureLine = L.polyline(measurePoints, { color: '#00f3ff', weight: 2, dashArray: '5, 5' }).addTo(map); measureLine.bindPopup(`<b>ğŸ“ ${s}</b>`).openPopup(); measurePoints = []; setTimeout(() => { measureTips.forEach(t => map.removeLayer(t)); measureTips = []; }, 500); } else if (measurePoints.length > 2) { clearMeasure(); } } }
        function onMapContextMenu(e) { if(isMeasuring) return; if(confirm("ğŸš© æ’æ——é›†åˆï¼Ÿ")) client.publish(currentTopic, JSON.stringify({ type: 'flag_update', senderName: myName, action: 'add', lat: e.latlng.lat, lng: e.latlng.lng })); }
        window.removeFlag = function() { if(confirm("å–æ¶ˆé›†åˆç‚¹ï¼Ÿ")) client.publish(currentTopic, JSON.stringify({ type: 'flag_update', action: 'remove' })); };
        function handleChatKey(e) { if(e.key === 'Enter') sendChat(); }
        function sendChat() { var i = document.getElementById('chat-input'); var t = i.value; if(!t.trim()) return; client.publish(currentTopic, JSON.stringify({ type: 'chat', senderId: myUniqueId, senderName: myName, text: t })); appendChatMsg(myName, t, true); i.value = ""; }
        function appendChatMsg(n, t, me) { var b = document.getElementById('chat-messages'); var d = document.createElement('div'); d.className = 'chat-msg-row'; var s = me ? `<span style="color:#1890ff;font-weight:bold">æˆ‘:</span>` : `<span style="color:#ff4d4f;font-weight:bold">${n}:</span>`; d.innerHTML = `${s} ${t}`; b.appendChild(d); b.scrollTop = b.scrollHeight; if (!me && document.getElementById('chat-panel').classList.contains('collapsed')) document.getElementById('chat-badge').style.display = 'block'; }
        if (window.DeviceOrientationEvent) { window.addEventListener('deviceorientation', function(e) { if (e.alpha !== null) { myHeading = e.webkitCompassHeading || (360 - e.alpha); var a = document.querySelector('.my-icon-style .heading-arrow'); if(a) { a.style.display = 'block'; a.style.transform = `translateX(-50%) rotate(${myHeading}deg)`; } } }, true); }
    </script>
</body>
</html>
