<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MOUYUçš„å…±äº«åœ°å›¾</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; }
        
        /* ========================
           ğŸ” 1. å…¨ç«™é—¨ç¦æ ·å¼
           ======================== */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
            flex-direction: column; color: white;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 320px;
            text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .login-title { color: #333; font-size: 20px; font-weight: bold; margin-bottom: 20px; }
        .login-input {
            width: 100%; padding: 12px; font-size: 16px; border: 2px solid #eee; border-radius: 8px;
            margin-bottom: 15px; text-align: center; outline: none; transition: 0.3s;
        }
        .login-input:focus { border-color: #1890ff; }
        .login-btn {
            width: 100%; padding: 12px; background: #1890ff; color: white; border: none;
            border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;
        }
        .login-btn:active { background: #096dd9; transform: scale(0.98); }

        /* ========================
           ğŸ“± 2. ç§»åŠ¨ç«¯ UI ä¼˜åŒ–
           ======================== */
        .map-btn {
            background: white; border: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            padding: 8px 12px; font-size: 13px; font-weight: 600; color: #333; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .map-btn:active { background: #f0f0f0; transform: scale(0.95); }
        .map-btn.active { background: #e6f7ff; color: #1890ff; border: 1px solid #1890ff; }

        .locate-btn { position: absolute; bottom: 40px; right: 20px; z-index: 999; padding: 12px 20px; border-radius: 50px; }
        .follow-btn { position: absolute; bottom: 100px; right: 20px; z-index: 999; width: 40px; height: 40px; border-radius: 50%; font-size: 18px; }
        .measure-btn { position: absolute; bottom: 150px; right: 20px; z-index: 999; width: 40px; height: 40px; border-radius: 50%; font-size: 18px; }

        /* é¢æ¿åŸºç¡€æ ·å¼ */
        .player-list-panel {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px);
            padding: 15px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            width: 260px; /* ç¨å¾®åŠ å®½ä¸€ç‚¹é€‚é…æˆ¿é—´è¾“å…¥ */
            max-height: 70vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.5);
            transition: all 0.3s ease;
        }
        /* æ‰‹æœºç«¯é¢æ¿é€‚é… */
        @media (max-width: 600px) {
            .player-list-panel {
                width: 200px; /* æ‰‹æœºä¸Šçª„ä¸€ç‚¹ */
                top: 10px; right: 10px;
                padding: 10px;
            }
            .locate-btn { bottom: 30px; right: 10px; padding: 10px 15px; font-size: 12px; }
            .follow-btn { bottom: 90px; right: 10px; width: 36px; height: 36px; }
            .measure-btn { bottom: 135px; right: 10px; width: 36px; height: 36px; }
            
            /* æˆ¿é—´è®¾ç½®åŒºåŸŸåœ¨æ‰‹æœºä¸Šçš„ä¼˜åŒ– */
            .room-setting-box { padding: 6px !important; }
            .room-input-row { flex-direction: column; align-items: flex-start !important; gap: 4px !important; }
            .room-input-row .setting-label { width: 100% !important; margin-bottom: 2px; }
            .room-input-row input { width: 100% !important; }
        }

        .panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 10px; cursor: pointer; }
        .panel-title { font-size: 14px; font-weight: 700; color: #1a1a1a; margin: 0; }
        .toggle-icon { font-size: 12px; color: #999; transition: transform 0.3s; }
        
        .chat-panel {
            position: absolute; bottom: 30px; left: 20px; z-index: 1000;
            width: 280px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; transition: width 0.3s, transform 0.3s;
        }
        @media (max-width: 600px) {
            .chat-panel { width: 70%; left: 10px; bottom: 80px; }
        }
        
        .chat-header { background: #f0f2f5; padding: 10px 12px; font-size: 12px; font-weight: bold; color: #666; display: flex; justify-content: space-between; cursor: pointer; border-radius: 12px 12px 0 0; }
        .chat-panel.collapsed .chat-header { border-radius: 12px; }
        .chat-content-wrapper { display: block; }
        .chat-panel.collapsed .chat-content-wrapper { display: none; }
        .chat-messages { height: 150px; overflow-y: auto; padding: 10px; font-size: 12px; background: white; }
        .chat-msg-row { margin-bottom: 6px; line-height: 1.4; word-wrap: break-word; }
        .chat-sender { font-weight: bold; color: #1890ff; margin-right: 4px; }
        .chat-input-area { display: flex; padding: 8px; border-top: 1px solid #eee; background: #fff; border-radius: 0 0 12px 12px; align-items: center; }
        .chat-input { flex: 1; border: 1px solid #ddd; border-radius: 4px; padding: 6px 8px; font-size: 12px; outline: none; min-width: 0; }
        .chat-send-btn { margin-left: 6px; background: #1890ff; color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 12px; white-space: nowrap; }

        .user-setting-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .setting-label { font-size: 12px; color: #666; width: 30px; flex-shrink: 0; }
        .avatar-input { width: 40px; text-align: center; border: 1px solid #ddd; border-radius: 8px; padding: 5px; font-size: 16px; background: #f9f9f9; }
        .status-input { flex: 1; border: 1px solid #ddd; border-radius: 8px; padding: 6px; font-size: 12px; background: #f9f9f9; }
        .id-input { flex: 1; border: 1px solid #ddd; border-radius: 8px; padding: 6px; font-size: 12px; background: #f9f9f9; font-weight: bold; color: #333; }
        .gpx-btn { width: 100%; background: #28a745; color: white; border: none; border-radius: 6px; padding: 8px; font-size: 12px; font-weight: bold; cursor: pointer; text-align: center; display: flex; align-items: center; justify-content: center; gap: 5px; }

        .view-switch { display: flex; gap: 5px; background: #eee; padding: 2px; border-radius: 6px; flex: 1; }
        .view-opt { flex: 1; text-align: center; font-size: 11px; padding: 4px 0; cursor: pointer; border-radius: 4px; color: #666; }
        .view-opt.active { background: white; color: #3388ff; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .player-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; margin-bottom: 6px; background: #f8f9fa; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .player-head { display: flex; align-items: center; gap: 5px; font-weight: 600; font-size: 13px; color: #333; }
        .player-status-text { font-size: 11px; color: #666; margin-top: 2px; }
        .player-dist { font-size: 11px; color: #888; }
        
        .emoji-marker-icon { position: relative; display: flex; justify-content: center; align-items: center; background: white; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.3); border: 2px solid white; font-size: 24px; transition: all 0.3s ease; }
        .my-icon-style { border-color: #3388ff; z-index: 1000 !important; }
        .other-icon-style { border-color: #ff4d4f; }
        .heading-arrow { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid #3388ff; z-index: -1; display: none; }
        .flag-icon { font-size: 30px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .status-bubble { background: white; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border-radius: 4px; padding: 2px 6px; font-size: 12px; font-weight: bold; color: #333; margin-bottom: 5px; }
        .leaflet-tooltip-bottom:before { display: none; }
        
        .msg-bubble-container { position: absolute; bottom: 45px; left: 0; width: 100%; pointer-events: none; display: flex; flex-direction: column-reverse; align-items: flex-start; }
        .msg-bubble { background: rgba(0, 0, 0, 0.75); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; margin-bottom: 5px; max-width: 80%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; animation: fadeUp 0.3s ease-out; margin-left: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .chat-badge { display: none; width: 8px; height: 8px; background: #ff4d4f; border-radius: 50%; margin-right: 5px; }
        .toast-tip { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 8px; font-size: 14px; pointer-events: none; opacity: 0; transition: opacity 0.5s; z-index: 2000; }
        .leaflet-control-scale { margin-bottom: 5px !important; margin-left: 10px !important; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <div style="font-size: 40px; margin-bottom: 10px;">ğŸ”’</div>
            <div class="login-title">MOUYU å†…éƒ¨ç³»ç»Ÿ</div>
            <input type="password" id="site-password" class="login-input" placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç ..." onkeypress="if(event.key==='Enter') checkSitePassword()">
            <button class="login-btn" onclick="checkSitePassword()">è§£é”ç³»ç»Ÿ</button>
            <div id="login-error" style="color:red; font-size:12px; margin-top:10px; opacity:0; transition:opacity 0.3s;">å¯†ç é”™è¯¯</div>
        </div>
    </div>

    <div id="toast" class="toast-tip">é•¿æŒ‰åœ°å›¾æ’æ—— | ç‚¹å‡»ç›´å°ºæµ‹é‡</div>

    <div class="player-list-panel" id="player-panel">
        <div class="panel-header" onclick="togglePlayerPanel()">
            <div class="panel-title">ğŸ“¡ MOUYUåœ°å›¾</div>
            <div class="toggle-icon" id="player-toggle-icon">â–¼</div>
        </div>
        <div class="panel-content" id="player-content">
            
            <div class="room-setting-box" style="background: #e6f7ff; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #91d5ff;">
                <div class="user-setting-row room-input-row">
                    <span class="setting-label" style="font-weight:bold; color:#0050b3;">æˆ¿é—´</span>
                    <input type="text" id="room-input" class="id-input" value="å¤§å…" placeholder="æˆ¿é—´å" style="background:white;">
                </div>
                <div class="user-setting-row room-input-row">
                    <span class="setting-label" style="font-weight:bold; color:#0050b3;">å¯†ç </span>
                    <input type="text" id="pass-input" class="status-input" placeholder="åŠ å¯†(å¯é€‰)" style="background:white;">
                </div>
                <button class="gpx-btn" onclick="joinRoom()" style="background:#1890ff; margin-top:5px; height: 32px; line-height: 1;">ğŸšª è¿›å…¥æˆ¿é—´</button>
            </div>
            
            <div style="padding-bottom: 10px; border-bottom: 1px dashed #eee; margin-bottom: 10px;">
                <div class="user-setting-row">
                    <span class="setting-label">è§†å›¾</span>
                    <div class="view-switch">
                        <div class="view-opt active" onclick="setViewMode('auto', this)">è‡ªåŠ¨</div>
                        <div class="view-opt" onclick="setViewMode('mobile', this)">æ‰‹æœº</div>
                        <div class="view-opt" onclick="setViewMode('pc', this)">ç”µè„‘</div>
                    </div>
                </div>
                <div class="user-setting-row">
                    <span class="setting-label">æ˜µç§°</span>
                    <input type="text" id="my-name-input" class="id-input" value="" placeholder="è¾“å…¥åå­—" maxlength="10">
                </div>
                <div class="user-setting-row">
                    <span class="setting-label">å½¢è±¡</span>
                    <input type="text" id="my-avatar-input" class="avatar-input" value="ğŸ˜¼" maxlength="2">
                </div>
                <div class="user-setting-row">
                    <span class="setting-label">çŠ¶æ€</span>
                    <input type="text" id="my-status-input" class="status-input" placeholder="çŠ¶æ€..." maxlength="10">
                </div>
            </div>
            <div id="player-list-container">
                <div style="font-size:12px; color:#ccc; text-align:center; padding:10px;">æ‰«æä¸­...</div>
            </div>
            <div class="my-status" id="my-status-text">è¿æ¥ä¸­...</div>
        </div>
    </div>

    <div class="chat-panel" id="chat-panel">
        <div class="msg-bubble-container" id="msg-bubble-container"></div>
        <div class="chat-header" onclick="toggleChat()">
            <div style="display:flex; align-items:center;">
                <div class="chat-badge" id="chat-badge"></div>
                <span>ğŸ’¬ é¢‘é“</span>
            </div>
            <span id="chat-toggle-icon">â–¼</span>
        </div>
        <div class="chat-content-wrapper" id="chat-content-wrapper">
            <div class="chat-messages" id="chat-messages">
                <div class="chat-msg-row" style="color:#999; font-style:italic;">æ¬¢è¿æ¥åˆ°èŠå¤©å®¤...</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" class="chat-input" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." onkeypress="handleChatKey(event)">
                <button class="chat-send-btn" onclick="sendChat()">å‘é€</button>
            </div>
        </div>
    </div>

    <div id="map"></div>
    
    <button class="map-btn measure-btn" id="measure-btn" onclick="toggleMeasure()" title="æµ‹é‡è·ç¦»">ğŸ“</button>
    <button class="map-btn follow-btn" id="follow-btn" onclick="toggleFollow()" title="è§†è§’è·Ÿéš">ğŸ”„</button>
    <button class="map-btn locate-btn" onclick="triggerManualLocate()">ğŸ“ å®šä½æˆ‘</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <script>
        // ============================================
        // ğŸ” ç½‘ç«™é—¨ç¦é€»è¾‘ (åœ¨è¿™é‡Œä¿®æ”¹å¯†ç ï¼)
        // ============================================
        var SITE_PASSWORD = "666"; // <--- è¯·åœ¨è¿™é‡Œä¿®æ”¹ä½ çš„ç½‘ç«™è®¿é—®å¯†ç ï¼
        var isSystemUnlocked = false;

        function checkSitePassword() {
            var input = document.getElementById('site-password').value;
            if (input === SITE_PASSWORD) {
                document.getElementById('login-overlay').style.display = 'none';
                isSystemUnlocked = true;
                startApp(); // å¯†ç æ­£ç¡®æ‰å¯åŠ¨åœ°å›¾å’ŒMQTT
            } else {
                var err = document.getElementById('login-error');
                err.style.opacity = 1;
                setTimeout(function() { err.style.opacity = 0; }, 2000);
            }
        }
        
        // ============================================
        // ğŸ—ºï¸ åœ°å›¾ä¸ç³»ç»Ÿæ ¸å¿ƒ (è¢«åŒ…è£¹åœ¨ startApp ä¸­)
        // ============================================
        var map, client, satellite, streetMap, darkMap;
        var myUniqueId, myName;
        var otherPlayers = {}; var myLatLng = null; var myMarker = null; var myPolyline = null;
        var myCurrentAvatar = "ğŸ˜¼"; var myCurrentStatus = ""; var currentFlag = null; 
        var isMeasuring = false; var measurePoints = []; var measureLine = null; var measureTips = [];
        var isFollowing = false; var myHeading = 0; 
        var currentTopic = ""; 
        var debounceTimer = null;

        function startApp() {
            // 1. åˆå§‹åŒ–åœ°å›¾å›¾å±‚
            darkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 20 });
            satellite = L.layerGroup([
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 }),
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 })
            ]);
            streetMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: 'Â© CartoDB', maxZoom: 20 });

            // 2. åˆ›å»ºåœ°å›¾ - âœ… é»˜è®¤ä½¿ç”¨å«æ˜Ÿå›¾ (satellite)ï¼Œå¹¶åŠ å…¥å›¾å±‚æ§åˆ¶å™¨
            map = L.map('map', { center: [35.8617, 104.1954], zoom: 4, layers: [satellite], zoomControl: false });
            L.control.zoom({position: 'topleft'}).addTo(map);
            
            // âœ… æ”¹åï¼š"ğŸŒ‘ å¤œé—´æ¨¡å¼" å’Œ "ğŸ›°ï¸ å«æ˜Ÿå›¾"
            L.control.layers({ "ğŸ›°ï¸ å«æ˜Ÿå›¾": satellite, "ğŸŒ‘ å¤œé—´æ¨¡å¼": darkMap, "â˜€ï¸ è¡—é“å›¾": streetMap }).addTo(map);
            L.control.scale({ imperial: false, maxWidth: 200 }).addTo(map);
            
            // 3. ç”¨æˆ·ä¿¡æ¯
            myUniqueId = localStorage.getItem('my_unique_id');
            if (!myUniqueId) {
                myUniqueId = "uid_" + Date.now() + "_" + Math.floor(Math.random() * 10000);
                localStorage.setItem('my_unique_id', myUniqueId);
            }
            myName = localStorage.getItem('my_nickname');
            if (!myName) { myName = "ç¥ç§˜äºº" + Math.floor(Math.random() * 100); }
            document.getElementById('my-name-input').value = myName;
            document.getElementById('my-status-text').innerText = "ç³»ç»ŸID: " + myUniqueId.substring(0,8)+"...";
            
            // 4. è¿æ¥ MQTT (åªæœ‰å¯†ç æ­£ç¡®æ‰ä¼šæ‰§è¡Œè¿™é‡Œ)
            client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
            client.on('connect', function () { 
                console.log('âœ… MQTT Connected'); 
                joinRoom(); 
            });
            client.on('message', handleMqttMessage);
            
            // 5. ç»‘å®šåœ°å›¾äº‹ä»¶
            map.on('click', onMapClick);
            map.on('dragstart', function() { if(isFollowing) toggleFollow(); });
            map.on('contextmenu', onMapContextMenu);
            map.on('locationfound', onLocationFound);
            map.on('locationerror', function(e) { console.log("å®šä½ä¸­..."); });

            // 6. å¯åŠ¨å®šä½
            locateAndShare(false); 
            setInterval(() => locateAndShare(false), 3000);
            
            // 7. å¯åŠ¨æ¸…ç†å®šæ—¶å™¨
            setInterval(function() {
                var now = Date.now(); var listChanged = false;
                for (var id in otherPlayers) { if (now - otherPlayers[id].lastSeen > 10000) { map.removeLayer(otherPlayers[id].marker); if(otherPlayers[id].polyline) map.removeLayer(otherPlayers[id].polyline); delete otherPlayers[id]; listChanged = true; } }
                if(listChanged) updatePlayerList();
            }, 2000);

            // 8. æç¤ºToast
            setTimeout(function(){ var t = document.getElementById('toast'); t.style.opacity = 1; setTimeout(function(){ t.style.opacity = 0; }, 3000); }, 1000);
            
            applyViewMode();
        }

        // ========================
        // ğŸ  æˆ¿é—´é€»è¾‘
        // ========================
        function getTopic(room, pass) {
            if (!room) room = "å¤§å…";
            var safeRoom = encodeURIComponent(room);
            var safePass = pass ? "_" + encodeURIComponent(pass) : "";
            return 'mouyu/live/' + safeRoom + safePass;
        }

        function joinRoom() {
            var room = document.getElementById('room-input').value.trim();
            var pass = document.getElementById('pass-input').value.trim();
            var newTopic = getTopic(room, pass);

            if (currentTopic === newTopic) { alert("ä½ å·²ç»åœ¨æˆ¿é—´ [" + room + "] é‡Œäº†"); return; }
            if (currentTopic && client.connected) {
                client.unsubscribe(currentTopic);
                for(var id in otherPlayers) { map.removeLayer(otherPlayers[id].marker); if(otherPlayers[id].polyline) map.removeLayer(otherPlayers[id].polyline); }
                otherPlayers = {}; updatePlayerList();
                if(currentFlag) { map.removeLayer(currentFlag); currentFlag = null; }
                document.getElementById('chat-messages').innerHTML = '<div class="chat-msg-row" style="color:#999; font-style:italic;">å·²åˆ‡æ¢æˆ¿é—´...</div>';
            }
            currentTopic = newTopic;
            if (client.connected) {
                client.subscribe(currentTopic);
                client.publish(currentTopic, JSON.stringify({ type: 'chat', senderId: 'SYS', senderName: 'ç³»ç»Ÿ', text: `${myName} è¿›æˆ¿` }));
                triggerManualLocate();
            }
            alert("âœ… å·²è¿›å…¥: " + room);
            document.querySelector('.panel-title').innerText = "ğŸ“¡ æˆ¿é—´: " + room;
        }

        // ========================
        // ğŸ“¡ MQTT æ¶ˆæ¯å¤„ç†
        // ========================
        function handleMqttMessage(topic, message) {
            try {
                var data = JSON.parse(message.toString());
                if (data.type === 'chat') { if (data.senderId !== myUniqueId) appendChatMsg(data.senderName, data.text, false); return; }
                if (data.type === 'flag_update') {
                    if (data.action === 'add') {
                        if (currentFlag) map.removeLayer(currentFlag);
                        var flagIcon = L.divIcon({ className: 'flag-icon', html: 'ğŸ', iconSize: [30, 40], iconAnchor: [15, 40] });
                        currentFlag = L.marker([data.lat, data.lng], { icon: flagIcon }).addTo(map).bindPopup(`<b>ğŸ é›†åˆ</b><br>å‘èµ·: ${data.senderName}<br><button onclick="removeFlag()">æ‹”æ‰</button>`).openPopup();
                    } else if (data.action === 'remove') { if (currentFlag) { map.removeLayer(currentFlag); currentFlag = null; } }
                    return;
                }
                if (data.id === myUniqueId) return;
                
                var now = Date.now(); var pAvatar = data.avatar || "ğŸ“"; var pStatus = data.status || ""; var pName = data.name || "æœªçŸ¥";
                if (!otherPlayers[data.id]) {
                    var icon = L.divIcon({ className: 'emoji-marker-icon other-icon-style', html: pAvatar, iconSize: [40, 40], iconAnchor: [20, 20] });
                    var newMarker = L.marker([data.lat, data.lng], { icon: icon }).addTo(map);
                    if(pStatus) newMarker.bindTooltip(pStatus, { permanent: true, direction: 'top', offset: [0, -22], className: 'status-bubble' });
                    newMarker.bindPopup("ğŸš© " + pName);
                    var newPolyline = L.polyline([], { color: '#00ff00', weight: 3, opacity: 0.8, dashArray: '5, 10' }).addTo(map); newPolyline.addLatLng([data.lat, data.lng]);
                    otherPlayers[data.id] = { marker: newMarker, polyline: newPolyline, lastSeen: now, lat: data.lat, lng: data.lng, avatar: pAvatar, status: pStatus, name: pName };
                } else {
                    var p = otherPlayers[data.id]; p.marker.setLatLng([data.lat, data.lng]); p.polyline.addLatLng([data.lat, data.lng]);
                    p.lastSeen = now; p.lat = data.lat; p.lng = data.lng;
                    if (p.name !== pName) { p.marker.bindPopup("ğŸš© " + pName); p.name = pName; }
                    if (p.avatar !== pAvatar) { p.marker.setIcon(L.divIcon({ className: 'emoji-marker-icon other-icon-style', html: pAvatar, iconSize: [40, 40], iconAnchor: [20, 20] })); p.avatar = pAvatar; }
                    if (p.status !== pStatus) { p.status = pStatus; pStatus ? p.marker.bindTooltip(pStatus, { permanent: true, direction: 'top', offset: [0, -22], className: 'status-bubble' }) : p.marker.unbindTooltip(); }
                }
                updatePlayerList();
            } catch (e) {}
        }

        // ========================
        // ğŸ› ï¸ è¾…åŠ©åŠŸèƒ½
        // ========================
        var currentViewMode = 'auto';
        function setViewMode(mode, btnElement) {
            currentViewMode = mode; var btns = document.querySelectorAll('.view-opt'); btns.forEach(b => b.classList.remove('active')); if(btnElement) btnElement.classList.add('active'); applyViewMode();
        }
        function applyViewMode() {
            var body = document.body; var isMobile = false;
            if (currentViewMode === 'mobile') isMobile = true; else if (currentViewMode === 'pc') isMobile = false; else isMobile = window.innerWidth <= 600;
            if (isMobile) { body.classList.add('view-mobile'); if (!body.dataset.initMobile) { toggleChat(true); togglePlayerPanel(true); body.dataset.initMobile = "true"; } } else { body.classList.remove('view-mobile'); }
        }
        window.addEventListener('resize', function() { if (currentViewMode === 'auto') applyViewMode(); });

        function togglePlayerPanel(forceCollapse) {
            var content = document.getElementById('player-content'); var icon = document.getElementById('player-toggle-icon'); var isHidden = content.style.display === 'none';
            if (forceCollapse === true || !isHidden) { content.style.display = 'none'; icon.innerText = "â—€"; icon.style.transform = "rotate(90deg)"; } else { content.style.display = 'block'; icon.innerText = "â–¼"; icon.style.transform = "rotate(0deg)"; }
        }
        function toggleChat(forceCollapse) {
            var panel = document.getElementById('chat-panel'); var icon = document.getElementById('chat-toggle-icon'); var badge = document.getElementById('chat-badge');
            if (forceCollapse === true || !panel.classList.contains('collapsed')) { panel.classList.add('collapsed'); icon.innerText = "â–²"; } else { panel.classList.remove('collapsed'); icon.innerText = "â–¼"; badge.style.display = 'none'; }
        }

        function toggleMeasure() {
            isMeasuring = !isMeasuring; var btn = document.getElementById('measure-btn');
            if(isMeasuring) { btn.classList.add('active'); btn.innerHTML = "âŒ"; document.getElementById('map').style.cursor = "crosshair"; alert("ç‚¹å‡»åœ°å›¾ä¸¤ç‚¹æµ‹é‡"); if(isFollowing) toggleFollow(); } 
            else { btn.classList.remove('active'); btn.innerHTML = "ğŸ“"; document.getElementById('map').style.cursor = ""; clearMeasure(); }
        }
        function clearMeasure() { if(measureLine) map.removeLayer(measureLine); measureTips.forEach(t => map.removeLayer(t)); measurePoints = []; measureTips = []; }

        function toggleFollow() {
            isFollowing = !isFollowing; var btn = document.getElementById('follow-btn');
            if(isFollowing) { btn.classList.add('active'); if(myLatLng) map.flyTo(myLatLng, 18); document.getElementById('toast').innerText = "è§†è§’è·Ÿéšå·²å¼€å¯"; document.getElementById('toast').style.opacity = 1; setTimeout(()=>document.getElementById('toast').style.opacity=0, 2000); } 
            else { btn.classList.remove('active'); document.getElementById('toast').innerText = "è§†è§’è·Ÿéšå·²å…³é—­"; document.getElementById('toast').style.opacity = 1; setTimeout(()=>document.getElementById('toast').style.opacity=0, 2000); }
        }

        function onMapClick(e) {
            if (isMeasuring) {
                measurePoints.push(e.latlng);
                var tip = L.circleMarker(e.latlng, { color: '#00f3ff', radius: 4 }).addTo(map); measureTips.push(tip);
                if (measurePoints.length === 2) {
                    var p1 = measurePoints[0]; var p2 = measurePoints[1];
                    var dist = map.distance(p1, p2); var distStr = dist > 1000 ? (dist/1000).toFixed(2) + " km" : Math.round(dist) + " m";
                    measureLine = L.polyline([p1, p2], { color: '#00f3ff', weight: 2, dashArray: '5, 5' }).addTo(map);
                    measureLine.bindPopup(`<b>ğŸ“ ${distStr}</b>`).openPopup();
                    measurePoints = []; setTimeout(() => { measureTips.forEach(t => map.removeLayer(t)); measureTips = []; }, 500);
                } else if (measurePoints.length > 2) { clearMeasure(); }
            }
        }
        function onMapContextMenu(e) {
            if(isMeasuring) return;
            if(confirm("ğŸš© æ’æ——é›†åˆï¼Ÿ")) client.publish(currentTopic, JSON.stringify({ type: 'flag_update', senderName: myName, action: 'add', lat: e.latlng.lat, lng: e.latlng.lng }));
        }
        window.removeFlag = function() { if(confirm("å–æ¶ˆé›†åˆç‚¹ï¼Ÿ")) client.publish(currentTopic, JSON.stringify({ type: 'flag_update', action: 'remove' })); };

        // èŠå¤©
        function handleChatKey(e) { if(e.key === 'Enter') sendChat(); }
        function sendChat() {
            var input = document.getElementById('chat-input'); var text = input.value; if(!text.trim()) return;
            client.publish(currentTopic, JSON.stringify({ type: 'chat', senderId: myUniqueId, senderName: myName, text: text }));
            appendChatMsg(myName, text, true); input.value = "";
        }
        function appendChatMsg(name, text, isMe) {
            var box = document.getElementById('chat-messages'); var div = document.createElement('div'); div.className = 'chat-msg-row';
            var senderHtml = isMe ? `<span class="chat-sender" style="color:#1890ff">æˆ‘:</span>` : `<span class="chat-sender" style="color:#ff4d4f">${name}:</span>`;
            div.innerHTML = `${senderHtml} <span class="chat-text">${text}</span>`;
            box.appendChild(div); box.scrollTop = box.scrollHeight;
            if (!isMe && document.getElementById('chat-panel').classList.contains('collapsed')) { showMsgBubble(name, text); document.getElementById('chat-badge').style.display = 'block'; }
        }
        function showMsgBubble(name, text) {
            var container = document.getElementById('msg-bubble-container'); var bubble = document.createElement('div'); bubble.className = 'msg-bubble';
            bubble.innerText = `${name}: ${text}`; container.appendChild(bubble); setTimeout(() => { bubble.style.opacity = '0'; setTimeout(() => bubble.remove(), 300); }, 3000);
        }

        // å®šä½ä¸æ›´æ–°
        function triggerQuietUpdate() { clearTimeout(debounceTimer); debounceTimer = setTimeout(function() { locateAndShare(false); }, 800); }
        document.getElementById('my-name-input').addEventListener('input', function(e) { myName = e.target.value.trim(); localStorage.setItem('my_nickname', myName); triggerQuietUpdate(); });
        document.getElementById('my-avatar-input').addEventListener('input', function(e) { myCurrentAvatar = e.target.value; updateMyMarkerVisuals(); triggerQuietUpdate(); });
        document.getElementById('my-status-input').addEventListener('input', function(e) { myCurrentStatus = e.target.value; updateMyMarkerVisuals(); triggerQuietUpdate(); });

        function updateMyMarkerVisuals() {
            if(!myMarker) return;
            var arrowHtml = `<div class="heading-arrow"></div>` + myCurrentAvatar;
            myMarker.setIcon(L.divIcon({ className: 'emoji-marker-icon my-icon-style', html: arrowHtml, iconSize: [40, 40], iconAnchor: [20, 20] }));
            if (myCurrentStatus) myMarker.bindTooltip(myCurrentStatus, { permanent: true, direction: 'top', offset: [0, -22], className: 'status-bubble' }); else myMarker.unbindTooltip();
            updateHeadingVisuals();
        }
        function updatePlayerList() {
            var container = document.getElementById('player-list-container'); container.innerHTML = ""; var hasPlayers = false;
            for (var id in otherPlayers) {
                hasPlayers = true; var p = otherPlayers[id];
                var distText = "--"; if (myLatLng) { var d = map.distance(myLatLng, [p.lat, p.lng]); d > 1000 ? distText = (d/1000).toFixed(1)+"km" : distText = Math.round(d)+"m"; }
                var statusHtml = p.status ? `<div class="player-status-text">ğŸ’¬ ${p.status}</div>` : '';
                var item = document.createElement('div'); item.className = 'player-item';
                item.innerHTML = `<div class="player-info"><div class="player-head"><span>${p.avatar}</span><span>${p.name}</span></div>${statusHtml}</div><div class="player-dist">${distText}</div>`;
                (function(targetLat, targetLng) { item.onclick = function() { map.flyTo([targetLat, targetLng], 18, { duration: 1.5 }); }; })(p.lat, p.lng);
                container.appendChild(item);
            }
            if (!hasPlayers) container.innerHTML = '<div style="font-size:12px; color:#ccc; text-align:center; padding:10px;">æš‚æ— å…¶ä»–äºº</div>';
        }

        function locateAndShare(showAlert = false) { map.locate({ setView: false, maxZoom: 17, timeout: 30000, enableHighAccuracy: true, maximumAge: 0 }); if(showAlert) alert("æ­£åœ¨åˆ·æ–°ä½ç½®..."); }
        function triggerManualLocate() { locateAndShare(true); }
        var isFirstLocate = true;
        function onLocationFound(e) {
            myLatLng = e.latlng; 
            if (isFollowing) map.panTo(myLatLng);
            if (!myPolyline) myPolyline = L.polyline([], { color: '#00f3ff', weight: 4, opacity: 0.8 }).addTo(map); myPolyline.addLatLng(e.latlng);
            if (!myMarker) { 
                var arrowHtml = `<div class="heading-arrow"></div>` + myCurrentAvatar;
                myMarker = L.marker(e.latlng, { icon: L.divIcon({ className: 'emoji-marker-icon my-icon-style', html: arrowHtml, iconSize: [40, 40], iconAnchor: [20, 20] }) }).addTo(map).bindPopup("<b>æˆ‘</b>").openPopup(); if(myCurrentStatus) updateMyMarkerVisuals(); 
            } else myMarker.setLatLng(e.latlng);
            if (isFirstLocate) { map.setView(e.latlng, 17); isFirstLocate = false; }
            client.publish(currentTopic, JSON.stringify({ type: 'player_update', id: myUniqueId, name: myName, lat: e.latlng.lat, lng: e.latlng.lng, avatar: myCurrentAvatar, status: myCurrentStatus }));
        }

        if (window.DeviceOrientationEvent) {
            window.addEventListener('deviceorientation', function(event) {
                if (event.alpha !== null) {
                    var heading = event.webkitCompassHeading || (360 - event.alpha);
                    myHeading = heading; updateHeadingVisuals();
                }
            }, true);
        }
        function updateHeadingVisuals() {
            var arrow = document.querySelector('.my-icon-style .heading-arrow');
            if(arrow) { arrow.style.display = 'block'; arrow.style.transform = `translateX(-50%) rotate(${myHeading}deg)`; }
        }
    </script>
</body>
</html>
