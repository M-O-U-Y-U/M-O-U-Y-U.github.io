<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MOUYU å…±äº«åœ°å›¾ (æµ‹è¯•)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* ========================
           åŸºç¡€æ ·å¼
           ======================== */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; overflow: hidden; }
        #map { height: 100vh; height: 100dvh; width: 100%; }
        
        /* é®ç½©ä¸å¼¹çª—é€šç”¨ */
        .overlay-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
            flex-direction: column; color: white;
        }
        .dialog-box {
            background: white; padding: 25px; border-radius: 16px; width: 85%; max-width: 360px;
            text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: #333; position: relative;
        }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .dialog-title { font-size: 22px; font-weight: bold; margin-bottom: 10px; color: #333; }
        .dialog-subtitle { font-size: 13px; color: #666; margin-bottom: 15px; line-height: 1.5; }
        
        .login-input { width: 100%; padding: 12px; font-size: 16px; border: 2px solid #eee; border-radius: 8px; margin-bottom: 15px; text-align: center; outline: none; transition: 0.3s; }
        .login-input:focus { border-color: #1890ff; }
        
        .action-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 15px; font-weight: bold; cursor: pointer; color: white; transition: all 0.2s; margin-top: 5px; }
        .action-btn:active { transform: scale(0.98); opacity: 0.9; }
        .action-btn:disabled { background: #ccc !important; cursor: not-allowed; transform: none; }
        
        .btn-blue { background: #1890ff; }
        .btn-red { background: #ff4d4f; }
        .btn-green { background: #52c41a; }
        .btn-gray { background: #f0f0f0; color: #666; }
        .btn-black { background: #333; color: #fff; }
        .btn-orange { background: #fa8c16; color: #fff; }
        .btn-purple { background: #722ed1; color: #fff; }
        
        .btn-turf-red { background: linear-gradient(45deg, #ff4d4f, #ff7875); box-shadow: 0 4px 15px rgba(255, 77, 79, 0.4); font-size: 18px; padding: 20px; }
        .btn-turf-blue { background: linear-gradient(45deg, #1890ff, #40a9ff); box-shadow: 0 4px 15px rgba(24, 144, 255, 0.4); font-size: 18px; padding: 20px; }

        .dialog-btns { display: flex; gap: 10px; width: 100%; }
        .dialog-btns button { flex: 1; }

        /* åœ°å›¾æŒ‰é’® */
        .map-btn {
            background: white; border: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            padding: 8px 12px; font-size: 13px; font-weight: 600; color: #333; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .map-btn:active { background: #f0f0f0; transform: scale(0.95); }
        .map-btn.active { background: #e6f7ff; color: #1890ff; border: 1px solid #1890ff; }
        
        .locate-btn { position: absolute; bottom: 40px; right: 20px; z-index: 999; padding: 12px 20px; border-radius: 50px; }
        .follow-btn { position: absolute; bottom: 100px; right: 20px; z-index: 999; width: 40px; height: 40px; border-radius: 50%; font-size: 18px; }
        .measure-btn { position: absolute; bottom: 150px; right: 20px; z-index: 999; width: 40px; height: 40px; border-radius: 50%; font-size: 18px; }
        
        /* ğŸ“¡ é›·è¾¾æŒ‰é’® */
        .radar-btn {
            position: absolute; bottom: 210px; right: 20px; z-index: 999; width: 50px; height: 50px; border-radius: 50%;
            background: #222; color: #00f3ff; font-weight: bold; font-size: 24px; border: 2px solid #00f3ff;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.5); display: flex; align-items: center; justify-content: center;
            transition: all 0.3s;
        }
        .radar-btn:active { transform: scale(0.9); }
        .radar-cooldown { filter: grayscale(1); border-color: #666; color: #666; box-shadow: none; pointer-events: none; }

        /* é¢æ¿æ ·å¼ */
        .player-list-panel {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px);
            padding: 15px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            width: 260px; max-height: 70vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.5);
            transition: all 0.3s ease;
        }
        @media (max-width: 600px) {
            .player-list-panel { width: 220px; top: 10px; right: 10px; padding: 10px; }
            .locate-btn { bottom: 30px; right: 10px; padding: 10px 15px; font-size: 12px; }
            .follow-btn { bottom: 90px; right: 10px; width: 36px; height: 36px; }
            .measure-btn { bottom: 135px; right: 10px; width: 36px; height: 36px; }
            .radar-btn { bottom: 180px; right: 10px; width: 40px; height: 40px; font-size: 20px; }
            .room-setting-box { padding: 8px !important; }
        }

        .panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 10px; cursor: pointer; }
        .panel-title { font-size: 14px; font-weight: 700; color: #1a1a1a; margin: 0; }
        .toggle-icon { font-size: 12px; color: #999; transition: transform 0.3s; }
        .net-status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-online { background-color: #52c41a; box-shadow: 0 0 5px #52c41a; }
        .status-offline { background-color: #ff4d4f; box-shadow: 0 0 5px #ff4d4f; }

        /* èŠå¤© */
        .chat-panel {
            position: absolute; bottom: 30px; left: 20px; z-index: 1000;
            width: 280px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; transition: width 0.3s, transform 0.3s;
        }
        @media (max-width: 600px) { .chat-panel { width: 70%; left: 10px; bottom: 80px; } }
        .chat-header { background: #f0f2f5; padding: 10px 12px; font-size: 12px; font-weight: bold; color: #666; display: flex; justify-content: space-between; cursor: pointer; border-radius: 12px 12px 0 0; }
        .chat-panel.collapsed .chat-header { border-radius: 12px; }
        .chat-content-wrapper { display: block; }
        .chat-panel.collapsed .chat-content-wrapper { display: none; }
        .chat-messages { height: 150px; overflow-y: auto; padding: 10px; font-size: 12px; background: white; }
        .chat-msg-row { margin-bottom: 6px; line-height: 1.4; word-wrap: break-word; }
        .chat-sender { font-weight: bold; color: #1890ff; margin-right: 4px; }
        .chat-input-area { display: flex; padding: 8px; border-top: 1px solid #eee; background: #fff; border-radius: 0 0 12px 12px; align-items: center; }
        .chat-input { flex: 1; border: 1px solid #ddd; border-radius: 4px; padding: 6px 8px; font-size: 12px; outline: none; min-width: 0; }
        .chat-send-btn { margin-left: 6px; background: #1890ff; color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 12px; white-space: nowrap; }
        .emoji-btn { background: none; border: none; font-size: 18px; cursor: pointer; margin-right: 5px; }

        /* è®¾ç½®è¡Œ */
        .user-setting-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .setting-label { font-size: 12px; color: #666; width: 30px; flex-shrink: 0; }
        .avatar-input { width: 40px; text-align: center; border: 1px solid #ddd; border-radius: 8px; padding: 5px; font-size: 16px; background: #f9f9f9; }
        .status-input { flex: 1; border: 1px solid #ddd; border-radius: 8px; padding: 6px; font-size: 12px; background: #f9f9f9; }
        .id-input { flex: 1; border: 1px solid #ddd; border-radius: 8px; padding: 6px; font-size: 12px; background: #f9f9f9; font-weight: bold; color: #333; }
        .gpx-btn { width: 100%; background: #28a745; color: white; border: none; border-radius: 6px; padding: 8px; font-size: 12px; font-weight: bold; cursor: pointer; text-align: center; display: flex; align-items: center; justify-content: center; gap: 5px; }

        .view-switch { display: flex; gap: 5px; background: #eee; padding: 2px; border-radius: 6px; flex: 1; }
        .view-opt { flex: 1; text-align: center; font-size: 11px; padding: 4px 0; cursor: pointer; border-radius: 4px; color: #666; }
        .view-opt.active { background: white; color: #3388ff; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* ç©å®¶åˆ—è¡¨ */
        .player-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; margin-bottom: 6px; background: #f8f9fa; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .player-head { display: flex; align-items: center; gap: 5px; font-weight: 600; font-size: 13px; color: #333; }
        .player-status-text { font-size: 11px; color: #666; margin-top: 2px; }
        .player-dist { font-size: 11px; color: #888; }
        
        .emoji-marker-icon { position: relative; display: flex; justify-content: center; align-items: center; background: white; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.3); border: 2px solid white; font-size: 24px; transition: all 0.3s ease; }
        .my-icon-style { border-color: #3388ff; z-index: 1000 !important; }
        .other-icon-style { border-color: #ff4d4f; }
        .zombie-icon-style { border-color: #520339; background: #2a0000; color: red; animation: shake 1s infinite; z-index: 2000 !important;}
        .turf-red-icon { border-color: #ff4d4f !important; box-shadow: 0 0 10px #ff4d4f !important; z-index: 1500 !important; }
        .turf-blue-icon { border-color: #1890ff !important; box-shadow: 0 0 10px #1890ff !important; z-index: 1500 !important; }
        
        .heading-arrow { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid #3388ff; z-index: -1; display: none; }
        .status-bubble { background: white; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border-radius: 4px; padding: 2px 6px; font-size: 12px; font-weight: bold; color: #333; margin-bottom: 5px; }
        .leaflet-tooltip-bottom:before { display: none; }
        
        .flag-icon { font-size: 30px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } }

        .msg-bubble-container { position: absolute; bottom: 45px; left: 0; width: 100%; pointer-events: none; display: flex; flex-direction: column-reverse; align-items: flex-start; }
        .msg-bubble { background: rgba(0, 0, 0, 0.75); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; margin-bottom: 5px; max-width: 80%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; animation: fadeUp 0.3s ease-out; margin-left: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .chat-badge { display: none; width: 8px; height: 8px; background: #ff4d4f; border-radius: 50%; margin-right: 5px; }
        
        .floating-emoji { font-size: 60px; position: absolute; animation: floatUp 2s forwards; pointer-events: none; z-index: 5000; text-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        @keyframes floatUp { 0% { transform: translateY(0) scale(0.5); opacity: 0; } 20% { transform: translateY(-20px) scale(1.2); opacity: 1; } 100% { transform: translateY(-150px) scale(1); opacity: 0; } }

        .toast-tip { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 8px; font-size: 14px; pointer-events: none; opacity: 0; transition: opacity 0.5s; z-index: 2000; }
        .leaflet-control-scale { margin-bottom: 5px !important; margin-left: 10px !important; }

        /* ========================
           ç‰¹æ®Šæ¨¡å¼é¢æ¿
           ======================== */
        .game-status-panel {
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.85); color: white; padding: 10px 20px; border-radius: 30px;
            font-size: 14px; font-weight: bold; z-index: 2000; display: none; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 1px solid #555; align-items: center; gap: 15px;
        }
        .panel-timer { color: #fff; font-family: monospace; font-size: 16px; border-right: 1px solid #666; padding-right: 15px; }
        
        .turf-score-bar { width: 200px; height: 10px; background: #333; border-radius: 5px; overflow: hidden; display: flex; }
        .score-red { height: 100%; background: #ff4d4f; width: 50%; transition: width 0.5s; }
        .score-blue { height: 100%; background: #1890ff; width: 50%; transition: width 0.5s; }
        
        .infection-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 30%, rgba(139, 0, 0, 0.8) 100%);
            z-index: 8000; pointer-events: none; display: none;
            animation: pulse-red 1s infinite;
        }
        .out-of-bounds-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            box-shadow: inset 0 0 100px 50px rgba(255, 0, 0, 0.8);
            z-index: 8000; pointer-events: none; display: none;
            animation: pulse-red 0.5s infinite;
        }
        @keyframes pulse-red { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
        
        .countdown-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999; display: none;
            flex-direction: column; justify-content: center; align-items: center; color: red;
        }
        .count-number { font-size: 120px; font-weight: 900; font-family: monospace; animation: scaleUp 0.5s; }
        .count-text { font-size: 24px; color: white; margin-top: 10px; }
        @keyframes scaleUp { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .force-stop-btn {
            display: none; width: 100%; background: #000; color: #ff4d4f; border: 1px solid #ff4d4f; 
            border-radius: 6px; padding: 10px; font-size: 13px; font-weight: bold; cursor: pointer; margin-top: 8px;
        }
        
        .rules-list { text-align: left; background: #f9f9f9; padding: 10px; border-radius: 8px; font-size: 13px; color: #555; margin-bottom: 15px; }
        .rules-list li { margin-bottom: 5px; }
        
        .win-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 10000; display: none;
            justify-content: center; align-items: center; flex-direction: column;
            color: white; animation: fadeIn 1s;
        }
        .win-title { font-size: 40px; font-weight: 900; margin-bottom: 20px; text-shadow: 0 0 20px currentColor; }
        
        .admin-controls-box {
            display:none; border-top:1px dashed #ccc; padding-top:10px; margin-top:10px;
            background: #fffbe6; padding: 10px; border-radius: 8px;
        }
        
        .setting-field { display:flex; align-items:center; justify-content:center; gap:5px; margin-bottom:5px; font-size:13px; }
        .setting-input { width:60px; text-align:center; padding:4px; border:1px solid #ddd; border-radius:4px; }
        
        .emoji-bar { background:white; padding:5px; display:flex; gap:5px; border-top:1px solid #eee; display:none;}
        .emoji-picker-btn { font-size: 20px; background:none; border:none; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-overlay" class="overlay-mask">
        <div class="dialog-box">
            <div style="font-size: 40px; margin-bottom: 10px;">ğŸ”’</div>
            <div class="dialog-title">MOUYU å†…éƒ¨ç³»ç»Ÿ</div>
            <input type="password" id="site-password" class="login-input" placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç ..." onkeypress="if(event.key==='Enter') checkSitePassword()">
            <button class="action-btn btn-blue" onclick="checkSitePassword()">è§£é”ç³»ç»Ÿ</button>
            <div id="login-error" style="color:red; font-size:12px; margin-top:10px; opacity:0; transition:opacity 0.3s;">å¯†ç é”™è¯¯</div>
            <div id="lib-error" style="color:red; font-size:11px; margin-top:5px; display:none;">âš ï¸ åŠ å¯†åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢</div>
        </div>
    </div>

    <div id="generic-modal" class="overlay-mask" style="display: none; z-index: 11000;">
        <div class="dialog-box">
            <div class="dialog-title" id="gen-title">æç¤º</div>
            <div class="dialog-subtitle" id="gen-desc" style="color:#333; font-size:15px;"></div>
            <div class="dialog-btns" id="gen-btns"></div>
        </div>
    </div>

    <div id="mode-select-overlay" class="overlay-mask" style="display: none;">
        <div class="dialog-box">
            <div style="font-size: 40px; margin-bottom: 10px;">ğŸ› ï¸</div>
            <div class="dialog-title">åˆ›å»ºæˆ¿é—´è®¾ç½®</div>
            <div class="dialog-subtitle">è¯·é€‰æ‹©è¯¥æˆ¿é—´çš„ç©æ³•æ¨¡å¼ã€‚<br>æ³¨æ„ï¼šä¸€ç»åˆ›å»ºï¼Œæ¨¡å¼æ— æ³•æ›´æ”¹ã€‚</div>
            <button class="action-btn btn-blue" onclick="createRoom('normal')">ğŸŒ æ™®é€šå®šä½æ¨¡å¼</button>
            <button class="action-btn btn-black" onclick="createRoom('bio')">ğŸ§Ÿâ€â™‚ï¸ ç”ŸåŒ–å±æœºæ¨¡å¼</button>
            <button class="action-btn btn-orange" onclick="createRoom('turf')">ğŸ´ æ¶‚é¸¦æˆ˜äº‰æ¨¡å¼</button>
            <button class="action-btn btn-purple" onclick="createRoom('ghost')">ğŸ•µï¸ å¹½çµå§åº•æ¨¡å¼</button>
            <button class="action-btn btn-gray" onclick="document.getElementById('mode-select-overlay').style.display='none'">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="turf-team-overlay" class="overlay-mask" style="display: none; z-index: 10001;">
        <div class="dialog-box">
            <div class="dialog-title">ğŸ´ é€‰æ‹©é˜µè¥</div>
            <div class="dialog-subtitle">è¯·é€‰æ‹©ä½ è¦åŠ å…¥çš„é˜Ÿä¼<br>ç§»åŠ¨å³å¯æ¶‚æŠ¹åœ°å›¾ï¼</div>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button class="action-btn btn-turf-red" onclick="selectTurfTeam('red')">ğŸ”´ çº¢é˜Ÿ (Red)</button>
                <button class="action-btn btn-turf-blue" onclick="selectTurfTeam('blue')">ğŸ”µ è“é˜Ÿ (Blue)</button>
            </div>
        </div>
    </div>

    <div id="common-vote-overlay" class="overlay-mask" style="display: none;">
        <div class="dialog-box" style="max-width: 360px;">
            <div style="font-size: 30px; margin-bottom: 10px;">ğŸ—³ï¸ æ¸¸æˆæŠ•ç¥¨</div>
            <div class="dialog-title" id="vote-title">å‡†å¤‡å¼€å§‹</div>
            <ul class="rules-list" id="vote-rules"></ul>
            <div style="margin-bottom: 15px; font-size: 14px; font-weight: bold; color: #1890ff;">
                âœ… å‡†å¤‡çŠ¶æ€ï¼š<span id="vote-count">0</span>
            </div>
            <div id="voter-btns" style="display: flex; gap: 10px;">
                <button class="action-btn btn-gray" onclick="document.getElementById('common-vote-overlay').style.display='none'">å…³é—­</button>
                <button id="btn-vote-yes" class="action-btn btn-green" onclick="castVote()">ğŸ™‹â€â™‚ï¸ æˆ‘å‡†å¤‡å¥½äº†</button>
            </div>
            <div id="admin-controls" class="admin-controls-box">
                <div style="font-size:12px; color:#666; margin-bottom:5px; font-weight:bold;">ğŸ“‹ æ¸¸æˆè®¾ç½® (ä»…æˆ¿ä¸»)</div>
                <div class="setting-field">
                    <span>â±ï¸ æ¸¸æˆæ—¶é•¿:</span>
                    <input type="number" id="custom-game-time" value="5" min="1" max="60" class="setting-input">åˆ†
                </div>
                <div class="setting-field" id="setting-zombie-row" style="display:none;">
                    <span>ğŸ¦  åˆå§‹æ¯ä½“:</span>
                    <input type="number" id="custom-zombie-num" value="1" min="1" max="10" class="setting-input">äºº
                </div>
                <div style="margin-bottom:10px;">
                    <button id="draw-fence-btn" class="action-btn btn-orange" onclick="toggleDrawFence()">âœï¸ å¿…é¡»åˆ’å®šèŒƒå›´</button>
                    <div id="fence-status" style="font-size:11px; color:#666; margin-top:2px;">æœªè®¾ç½®èŒƒå›´</div>
                </div>
                <button id="admin-start-btn" class="action-btn btn-red" disabled onclick="finalStartGame()">ç­‰å¾…å…¨å‘˜æŠ•ç¥¨...</button>
            </div>
        </div>
    </div>

    <div id="countdown-overlay" class="countdown-overlay">
        <div class="count-number" id="countdown-num">10</div>
        <div class="count-text" id="countdown-text">å‡†å¤‡å¼€å§‹...</div>
    </div>
    
    <div id="win-overlay" class="win-modal">
        <div class="win-title" id="win-title">èƒœåˆ©</div>
        <div id="win-desc" style="font-size: 18px; margin-bottom: 30px;">ç»“æœæè¿°</div>
        <button class="action-btn btn-gray" style="width: 200px;" onclick="closeWinOverlayAndReset()">å…³é—­å¹¶é‡ç½®</button>
    </div>
    
    <div id="infection-effect" class="infection-overlay"></div>
    <div id="out-bounds-effect" class="out-of-bounds-overlay"></div>

    <div id="bio-status-bar" class="game-status-panel" style="display: none;">
        <div class="panel-timer" id="bio-timer">00:00</div>
        <div style="margin-left:10px; color:#52c41a">ğŸ›¡ï¸ <span id="survivor-count">0</span></div>
        <div style="margin-left:10px; color:#ff4d4f">ğŸ§Ÿâ€â™‚ï¸ <span id="zombie-count">0</span></div>
    </div>

    <div id="turf-status-bar" class="game-status-panel" style="display: none; flex-direction: column; align-items: center; gap: 5px;">
        <div style="display:flex; justify-content:space-between; width:100%; font-size:12px; color:#ccc;">
            <span>ğŸš© é¢†åœ°ç§¯åˆ†</span>
            <span id="turf-timer" style="color:white; font-family:monospace;">00:00</span>
        </div>
        <div class="turf-score-bar">
            <div id="bar-red" class="score-red"></div>
            <div id="bar-blue" class="score-blue"></div>
        </div>
        <div style="display:flex; gap:15px; font-size:14px;">
            <div style="color:#ff4d4f; font-weight:bold;">ğŸ”´ <span id="score-red-val">0</span></div>
            <div style="color:#1890ff; font-weight:bold;">ğŸ”µ <span id="score-blue-val">0</span></div>
        </div>
    </div>
    
    <div id="ghost-status-bar" class="game-status-panel" style="display: none;">
        <div class="panel-timer" id="ghost-timer">00:00</div>
        <div style="margin-left:10px;" id="ghost-status-text">ğŸ•µï¸ ä»»åŠ¡è¿›è¡Œä¸­...</div>
    </div>

    <div id="toast" class="toast-tip">é•¿æŒ‰åœ°å›¾æ’æ—— | ç‚¹å‡»ç›´å°ºæµ‹é‡</div>

    <div class="player-list-panel" id="player-panel">
        <div class="panel-header" onclick="togglePlayerPanel()">
            <div style="display:flex; align-items:center;">
                <span id="net-status-dot" class="net-status-dot status-offline"></span>
                <div class="panel-title">ğŸ“¡ MOUYUåœ°å›¾</div>
            </div>
            <div class="toggle-icon" id="player-toggle-icon">â–¼</div>
        </div>
        <div class="panel-content" id="player-content">
            
            <div class="room-setting-box" style="background: #e6f7ff; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #91d5ff;">
                <div class="user-setting-row room-input-row">
                    <span class="setting-label" style="font-weight:bold; color:#0050b3;">æˆ¿é—´</span>
                    <input type="text" id="room-input" class="id-input" value="å¤§å…" placeholder="æˆ¿é—´å" style="background:white;">
                </div>
                <div class="user-setting-row room-input-row">
                    <span class="setting-label" style="font-weight:bold; color:#0050b3;">å¯†ç </span>
                    <input type="text" id="pass-input" class="status-input" placeholder="åŠ å¯†(å¯é€‰)" style="background:white;">
                </div>

                <div style="display:flex; gap:5px; margin-top:5px;">
                    <button class="gpx-btn" onclick="preJoinCheck()" style="background:#1890ff; flex:1;">ğŸšª åŠ å…¥æˆ¿é—´</button>
                    <button class="gpx-btn" onclick="openCreateModal()" style="background:#fa8c16; flex:1;">ğŸ› ï¸ åˆ›å»ºæˆ¿é—´</button>
                </div>
                
                <button id="init-vote-btn" class="action-btn btn-green" onclick="initiateVote()" style="display:none; font-size:13px; padding:8px; margin-top:5px;">ğŸ—³ï¸ å‘èµ·æ¸¸æˆæŠ•ç¥¨ (æˆ¿ä¸»)</button>
                <button id="force-stop-btn" class="force-stop-btn" onclick="forceEndGame()">â›” å¼ºåˆ¶ç»“æŸæ¸¸æˆ</button>
            </div>
            
            <div style="padding-bottom: 10px; border-bottom: 1px dashed #eee; margin-bottom: 10px;">
                <div class="user-setting-row">
                    <span class="setting-label">è§†å›¾</span>
                    <div class="view-switch">
                        <div class="view-opt active" onclick="setViewMode('auto', this)">è‡ªåŠ¨</div>
                        <div class="view-opt" onclick="setViewMode('mobile', this)">æ‰‹æœº</div>
                        <div class="view-opt" onclick="setViewMode('pc', this)">ç”µè„‘</div>
                    </div>
                </div>
                <div class="user-setting-row">
                    <span class="setting-label">æ˜µç§°</span>
                    <input type="text" id="my-name-input" class="id-input" value="" placeholder="è¾“å…¥åå­—" maxlength="10">
                </div>
                <div class="user-setting-row">
                    <span class="setting-label">å½¢è±¡</span>
                    <input type="text" id="my-avatar-input" class="avatar-input" value="ğŸ˜¼" maxlength="2">
                </div>
                <div class="user-setting-row">
                    <span class="setting-label">çŠ¶æ€</span>
                    <input type="text" id="my-status-input" class="status-input" placeholder="çŠ¶æ€..." maxlength="10">
                </div>
            </div>
            <div id="player-list-container">
                <div style="font-size:12px; color:#ccc; text-align:center; padding:10px;">æ‰«æä¸­...</div>
            </div>
            <div class="my-status" id="my-status-text">è¿æ¥ä¸­...</div>
        </div>
    </div>

    <div class="chat-panel" id="chat-panel">
        <div class="msg-bubble-container" id="msg-bubble-container"></div>
        <div class="chat-header" onclick="toggleChat()">
            <div style="display:flex; align-items:center;">
                <div class="chat-badge" id="chat-badge"></div>
                <span>ğŸ’¬ é¢‘é“ (æ— è®°å½•)</span>
            </div>
            <span id="chat-toggle-icon">â–¼</span>
        </div>
        <div class="chat-content-wrapper" id="chat-content-wrapper">
            <div class="chat-messages" id="chat-messages">
                <div class="chat-msg-row" style="color:#999; font-style:italic;">å®æ—¶èŠå¤©ï¼Œåˆ·æ–°å³ç„š...</div>
            </div>
            <div class="emoji-bar" id="emoji-bar">
                <button class="emoji-picker-btn" onclick="sendEmoji('ğŸ’£')">ğŸ’£</button>
                <button class="emoji-picker-btn" onclick="sendEmoji('ğŸ‘»')">ğŸ‘»</button>
                <button class="emoji-picker-btn" onclick="sendEmoji('ğŸ’©')">ğŸ’©</button>
                <button class="emoji-picker-btn" onclick="sendEmoji('â¤ï¸')">â¤ï¸</button>
                <button class="emoji-picker-btn" onclick="sendEmoji('ğŸ¤¡')">ğŸ¤¡</button>
            </div>
            <div class="chat-input-area">
                <button class="emoji-btn" onclick="toggleEmoji()">ğŸ˜Š</button>
                <input type="text" id="chat-input" class="chat-input" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." onkeypress="handleChatKey(event)">
                <button class="chat-send-btn" onclick="sendChat()">å‘é€</button>
            </div>
        </div>
    </div>

    <div id="map"></div>
    
    <button class="map-btn radar-btn" id="radar-btn" onclick="useRadar()" title="é›·è¾¾æ‰«æ" style="display:none;">ğŸ“¡</button>
    <button class="map-btn measure-btn" id="measure-btn" onclick="toggleMeasure()" title="æµ‹é‡è·ç¦»">ğŸ“</button>
    <button class="map-btn follow-btn" id="follow-btn" onclick="toggleFollow()" title="è§†è§’è·Ÿéš">ğŸ”„</button>
    <button class="map-btn locate-btn" onclick="triggerManualLocate()">ğŸ“ å®šä½æˆ‘</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://unpkg.com/crypto-js@4.1.1/crypto-js.js"></script>

    <script>
        // ============================================
        // ğŸ” 1. ç½‘ç«™é—¨ç¦
        // ============================================
        var SITE_HASH = "c7e616822f366fb1b5e0756af498cc11d2c0862edcb32ca65882f622ff39de1b"; 
        var isSystemUnlocked = false;

        function checkSitePassword() {
            if (typeof CryptoJS === 'undefined') {
                document.getElementById('lib-error').style.display = 'block';
                return;
            }
            var inputRaw = document.getElementById('site-password').value;
            var input = inputRaw.trim(); 
            var inputHash = CryptoJS.SHA256(input).toString();

            if (inputHash === SITE_HASH) {
                document.getElementById('login-overlay').style.display = 'none';
                isSystemUnlocked = true;
                startApp(); 
            } else {
                var err = document.getElementById('login-error');
                err.style.opacity = 1;
                err.innerText = "å¯†ç é”™è¯¯";
                setTimeout(function() { err.style.opacity = 0; }, 2000);
            }
        }
        
        // ============================================
        // ğŸ› ï¸ é€šç”¨å¼¹çª—ç»„ä»¶
        // ============================================
        function showModal(title, text, confirmText, cancelText, onConfirm) {
            var modal = document.getElementById('generic-modal');
            document.getElementById('gen-title').innerText = title;
            document.getElementById('gen-desc').innerText = text;
            var btns = document.getElementById('gen-btns');
            btns.innerHTML = "";
            
            if (cancelText) {
                var btnCancel = document.createElement('button');
                btnCancel.className = "action-btn btn-gray";
                btnCancel.innerText = cancelText;
                btnCancel.onclick = function() { modal.style.display = 'none'; };
                btns.appendChild(btnCancel);
            }
            
            if (confirmText) {
                var btnConfirm = document.createElement('button');
                btnConfirm.className = "action-btn btn-blue";
                btnConfirm.innerText = confirmText;
                btnConfirm.onclick = function() { 
                    modal.style.display = 'none';
                    if (onConfirm) onConfirm();
                };
                btns.appendChild(btnConfirm);
            }
            modal.style.display = 'flex';
        }
        function alertBox(text) { showModal("æç¤º", text, "ç¡®å®š", null, null); }
        function confirmBox(text, callback) { showModal("ç¡®è®¤", text, "ç¡®å®š", "å–æ¶ˆ", callback); }

        // ============================================
        // ğŸ” åŠ å¯†é€šä¿¡
        // ============================================
        function getRoomPassword() { return document.getElementById('pass-input').value.trim(); }
        function encryptPayload(dataObj) {
            if (typeof CryptoJS === 'undefined') return JSON.stringify(dataObj);
            var pass = getRoomPassword();
            var jsonStr = JSON.stringify(dataObj);
            if (!pass) return jsonStr; 
            try { return "ENC:" + CryptoJS.AES.encrypt(jsonStr, pass).toString(); } 
            catch(e) { return jsonStr; }
        }
        function decryptPayload(payloadStr) {
            if (typeof CryptoJS === 'undefined') return null;
            var pass = getRoomPassword();
            if (payloadStr.startsWith("ENC:")) {
                if (!pass) return null; 
                try {
                    var bytes = CryptoJS.AES.decrypt(payloadStr.substring(4), pass);
                    var originalText = bytes.toString(CryptoJS.enc.Utf8);
                    if (!originalText) return null; 
                    return JSON.parse(originalText);
                } catch (e) { return null; }
            } else {
                if (pass) return null; 
                try { return JSON.parse(payloadStr); } catch(e) { return null; }
            }
        }

        var SafeStorage = {
            memory: {},
            setItem: function(key, value) { try { localStorage.setItem(key, value); } catch(e) { this.memory[key] = value; } },
            getItem: function(key) { try { return localStorage.getItem(key); } catch(e) { return this.memory[key] || null; } }
        };

        // ============================================
        // ğŸ—ºï¸ æ ¸å¿ƒé€»è¾‘
        // ============================================
        var map, client, satellite, streetMap, darkMap;
        var myUniqueId, myName;
        var otherPlayers = {}; var myLatLng = null; var myMarker = null; var myPolyline = null;
        var myCurrentAvatar = "ğŸ˜¼"; var myCurrentStatus = ""; var currentFlag = null; 
        var isMeasuring = false; var measurePoints = []; var measureLine = null; var measureTips = [];
        var isFollowing = false; var myHeading = 0; 
        var currentTopic = ""; 
        var debounceTimer = null;
        var audioCtx = null; 

        // æ¸¸æˆçŠ¶æ€
        var currentMode = 'normal'; 
        var isGameRunning = false; 
        var voteSet = new Set(); 
        var gameDurationSeconds = 300; 
        var localTimerInterval = null;
        
        // ç”ŸåŒ–
        var isZombie = false; 
        var zombieList = new Set();
        
        // æ¶‚é¸¦
        var myTeam = null; // 'red' or 'blue'
        var redScore = 0;
        var blueScore = 0;
        
        // å¹½çµ
        var isFoggy = false;
        var isRadarCooldown = false;
        var myRole = 'crew'; // 'crew', 'impostor'
        var ghostTarget = null; // ä»»åŠ¡ç‚¹
        var crumbPoints = []; // è¶³è¿¹ç‚¹
        var fogTimer = null;
        var allGhostTargets = {}; // å­˜å‚¨æ‰€æœ‰äººçš„ç›®æ ‡

        // å›´æ 
        var fencePoints = [];
        var fencePolygonLayer = null;
        var isDrawingFence = false;
        var drawTempPoints = [];
        var drawTempLayer = null;
        var outOfBoundsTimer = null;

        function startApp() {
            if ('wakeLock' in navigator) { try { navigator.wakeLock.request('screen'); } catch(e) {} }
            document.addEventListener('visibilitychange', async () => {
                if (document.visibilityState === 'visible' && 'wakeLock' in navigator) { try { await navigator.wakeLock.request('screen'); } catch(e) {} }
            });

            try { window.AudioContext = window.AudioContext || window.webkitAudioContext; audioCtx = new AudioContext(); } catch(e) {}

            darkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 20 });
            satellite = L.layerGroup([
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 }),
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 })
            ]);
            streetMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: 'Â© CartoDB', maxZoom: 20 });

            map = L.map('map', { center: [35.8617, 104.1954], zoom: 4, layers: [satellite], zoomControl: false });
            L.control.zoom({position: 'topleft'}).addTo(map);
            L.control.layers({ "ğŸ›°ï¸ å«æ˜Ÿå›¾": satellite, "ğŸŒ‘ å¤œé—´æ¨¡å¼": darkMap, "â˜€ï¸ ç®€æ´å›¾": streetMap }).addTo(map);
            L.control.scale({ imperial: false, maxWidth: 200 }).addTo(map);
            
            myUniqueId = SafeStorage.getItem('my_unique_id');
            if (!myUniqueId || myUniqueId.startsWith("uid_")) {
                myUniqueId = Math.random().toString(36).substr(2, 6).toUpperCase();
                SafeStorage.setItem('my_unique_id', myUniqueId);
            }
            myName = SafeStorage.getItem('my_nickname');
            if (!myName) { myName = "é˜Ÿå‹" + Math.floor(Math.random() * 100); }
            document.getElementById('my-name-input').value = myName;
            document.getElementById('my-status-text').innerText = "ID: " + myUniqueId;
            
            client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
            client.on('connect', function () { 
                console.log('âœ… MQTT Connected'); 
                updateNetStatus(true);
                joinRoom(false, 'normal', true); 
            });
            client.on('offline', function() { updateNetStatus(false); });
            client.on('reconnect', function() { updateNetStatus(true); });
            client.on('message', handleMqttMessage);
            
            map.on('click', onMapClick);
            map.on('dblclick', finishDrawing); 
            map.on('dragstart', function() { if(isFollowing) toggleFollow(); });
            map.on('contextmenu', onMapContextMenu);
            map.on('locationfound', onLocationFound);

            locateAndShare(false); 
            setInterval(() => locateAndShare(false), 2000); 
            
            setInterval(function() {
                var now = Date.now(); var listChanged = false;
                for (var id in otherPlayers) { 
                    if (now - otherPlayers[id].lastSeen > 15000) { 
                        map.removeLayer(otherPlayers[id].marker); 
                        if(otherPlayers[id].polyline) map.removeLayer(otherPlayers[id].polyline); 
                        if(otherPlayers[id].crumbs) { otherPlayers[id].crumbs.forEach(c => map.removeLayer(c)); otherPlayers[id].crumbs = []; }
                        
                        delete otherPlayers[id]; 
                        zombieList.delete(id); 
                        listChanged = true; 
                    } 
                }
                if(listChanged) updatePlayerList();
                if(currentMode === 'bio') updateBioStats();
            }, 2000);

            setTimeout(function(){ showToast("é•¿æŒ‰åœ°å›¾æ’æ—— | ç‚¹å‡»ç›´å°ºæµ‹é‡"); }, 1000);
            applyViewMode();
        }

        function updateNetStatus(isOnline) {
            var dot = document.getElementById('net-status-dot');
            if(isOnline) {
                dot.className = "net-status-dot status-online";
                document.getElementById('my-status-text').innerText = "ID: " + myUniqueId;
            } else {
                dot.className = "net-status-dot status-offline";
                document.getElementById('my-status-text').innerText = "è¿æ¥æ–­å¼€...";
            }
        }

        function getTopic(room) { return 'mouyu/live/' + encodeURIComponent(room || "å¤§å…"); }

        function preJoinCheck() { joinRoom(false); }
        function openCreateModal() { document.getElementById('mode-select-overlay').style.display = 'flex'; }
        
        function createRoom(mode) {
            document.getElementById('mode-select-overlay').style.display = 'none';
            if (mode !== 'normal') {
                var pass = getRoomPassword();
                if (!pass) {
                    alertBox("âš ï¸ ç‰¹æ®Šæ¨¡å¼å¿…é¡»è®¾ç½®æˆ¿é—´å¯†ç ï¼Œä»¥é˜²æ­¢è·¯äººè¯¯å…¥ï¼");
                    return;
                }
            }
            joinRoom(true, mode);
        }

        function joinRoom(isCreator = false, initialMode = 'normal', isAutoLobby = false) {
            var room;
            if(isAutoLobby) {
                room = "å¤§å…";
                document.getElementById('room-input').value = "å¤§å…";
                document.getElementById('pass-input').value = "";
            } else {
                room = document.getElementById('room-input').value.trim();
            }
            
            var newTopic = getTopic(room);
            resetGameState(); 

            if (currentTopic && client.connected) {
                client.unsubscribe(currentTopic);
                for(var id in otherPlayers) { 
                    map.removeLayer(otherPlayers[id].marker); 
                    if(otherPlayers[id].polyline) map.removeLayer(otherPlayers[id].polyline); 
                    if(otherPlayers[id].crumbs) otherPlayers[id].crumbs.forEach(c => map.removeLayer(c));
                }
                otherPlayers = {}; updatePlayerList();
                if(currentFlag) { map.removeLayer(currentFlag); currentFlag = null; }
                if(myPolyline) { map.removeLayer(myPolyline); myPolyline = null; } 
                document.getElementById('chat-messages').innerHTML = '<div class="chat-msg-row" style="color:#999; font-style:italic;">å·²åˆ‡æ¢æˆ¿é—´...</div>';
            }
            currentTopic = newTopic;
            if (client.connected) {
                client.subscribe(currentTopic);
                publishData({ type: 'sys_hello', senderId: myUniqueId, senderName: myName });
                
                if (isCreator && initialMode !== 'normal') {
                    setTimeout(function() {
                        publishData({ type: 'sys_mode_switch', mode: initialMode });
                    }, 500);
                }
                triggerManualLocate();
            }
            
            if(!isAutoLobby) {
                alertBox("âœ… å·²è¿›å…¥: " + room + "\nğŸ” åŠ å¯†: " + (getRoomPassword() ? "å¼€å¯" : "å…³é—­"));
            }
            document.querySelector('.panel-title').innerText = "ğŸ“¡ " + room;
        }

        function publishData(dataObj) {
            if (!client || !client.connected) return;
            client.publish(currentTopic, encryptPayload(dataObj));
        }

        // ==========================
        // ğŸ® æ¸¸æˆçŠ¶æ€ç®¡ç†
        // ==========================
        
        function switchMode(mode) {
            currentMode = mode;
            // UI Reset
            document.getElementById('init-vote-btn').style.display = 'none';
            document.getElementById('bio-status-bar').style.display = 'none';
            document.getElementById('turf-status-bar').style.display = 'none';
            document.getElementById('ghost-status-bar').style.display = 'none';
            document.getElementById('force-stop-btn').style.display = 'none';
            document.getElementById('turf-team-overlay').style.display = 'none';
            document.getElementById('radar-btn').style.display = 'none';
            
            if (mode === 'bio') {
                document.getElementById('init-vote-btn').style.display = 'block';
                document.getElementById('bio-status-bar').style.display = 'flex';
                showToast("âš ï¸ æˆ¿é—´å·²åˆ‡æ¢ä¸ºã€ç”ŸåŒ–å±æœºæ¨¡å¼ã€‘");
            } else if (mode === 'turf') {
                document.getElementById('init-vote-btn').style.display = 'block';
                document.getElementById('turf-status-bar').style.display = 'flex';
                document.getElementById('turf-team-overlay').style.display = 'flex';
                showToast("âš ï¸ æˆ¿é—´å·²åˆ‡æ¢ä¸ºã€æ¶‚é¸¦æˆ˜äº‰æ¨¡å¼ã€‘");
            } else if (mode === 'ghost') {
                document.getElementById('init-vote-btn').style.display = 'block';
                document.getElementById('ghost-status-bar').style.display = 'flex';
                showToast("âš ï¸ æˆ¿é—´å·²åˆ‡æ¢ä¸ºã€å¹½çµå§åº•æ¨¡å¼ã€‘");
            }
        }

        function resetGameState() {
            currentMode = 'normal';
            isGameRunning = false;
            
            // Bio
            isZombie = false;
            zombieList.clear();
            voteSet.clear();
            // Turf
            myTeam = null;
            redScore = 0; blueScore = 0;
            updateTurfScoreDisplay();
            // Ghost
            isFoggy = false;
            if(ghostTarget) { map.removeLayer(ghostTarget); ghostTarget = null; }
            if(fogTimer) clearInterval(fogTimer);
            document.getElementById('radar-btn').style.display = 'none';
            for(var key in allGhostTargets) {
                if(allGhostTargets[key]) map.removeLayer(allGhostTargets[key]);
            }
            allGhostTargets = {};
            
            // Common
            fencePoints = [];
            if(fencePolygonLayer) { map.removeLayer(fencePolygonLayer); fencePolygonLayer = null; }
            document.getElementById('fence-status').innerText = "æœªè®¾ç½®èŒƒå›´";
            
            isDrawingFence = false;
            drawTempPoints = [];
            if(drawTempLayer) { map.removeLayer(drawTempLayer); drawTempLayer = null; }
            document.getElementById('draw-fence-btn').innerText = "âœï¸ åˆ’å®šæ¸¸æˆèŒƒå›´";
            
            if(localTimerInterval) clearInterval(localTimerInterval);
            if(outOfBoundsTimer) clearTimeout(outOfBoundsTimer);
            
            document.getElementById('init-vote-btn').style.display = 'none';
            document.getElementById('bio-status-bar').style.display = 'none';
            document.getElementById('turf-status-bar').style.display = 'none';
            document.getElementById('ghost-status-bar').style.display = 'none';
            document.getElementById('force-stop-btn').style.display = 'none';
            document.getElementById('infection-effect').style.display = 'none';
            document.getElementById('out-bounds-effect').style.display = 'none';
            document.getElementById('countdown-overlay').style.display = 'none';
            document.getElementById('common-vote-overlay').style.display = 'none';
            document.getElementById('win-overlay').style.display = 'none';
            document.getElementById('turf-team-overlay').style.display = 'none';
            
            if(myPolyline) { map.removeLayer(myPolyline); myPolyline = null; }
            for(var id in otherPlayers) {
                if(otherPlayers[id].polyline) { map.removeLayer(otherPlayers[id].polyline); otherPlayers[id].polyline = null; }
                if(otherPlayers[id].crumbs) { otherPlayers[id].crumbs.forEach(c => map.removeLayer(c)); otherPlayers[id].crumbs = []; }
            }
            
            myCurrentAvatar = document.getElementById('my-avatar-input').value || "ğŸ˜¼";
            myCurrentStatus = document.getElementById('my-status-input').value || "";
            updateMyMarkerVisuals();
        }

        function forceEndGame() {
            confirmBox("ç¡®å®šå¼ºåˆ¶ç»“æŸæœ¬è½®æ¸¸æˆå—ï¼Ÿ\næ‰€æœ‰äººçš„çŠ¶æ€å°†é‡ç½®ã€‚", function() {
                publishData({ type: 'sys_game_stop' });
            });
        }

        // ==========================
        // ğŸ´ æ¶‚é¸¦æˆ˜äº‰é€»è¾‘
        // ==========================
        function selectTurfTeam(team) {
            myTeam = team;
            document.getElementById('turf-team-overlay').style.display = 'none';
            
            if (team === 'red') {
                myCurrentAvatar = "ğŸ”´";
                myCurrentStatus = "çº¢é˜Ÿ";
                document.getElementById('my-name-input').style.color = "#ff4d4f";
            } else {
                myCurrentAvatar = "ğŸ”µ";
                myCurrentStatus = "è“é˜Ÿ";
                document.getElementById('my-name-input').style.color = "#1890ff";
            }
            updateMyMarkerVisuals();
            if(myPolyline) { map.removeLayer(myPolyline); myPolyline = null; }
            publishData({ type: 'turf_join', team: team, id: myUniqueId });
        }
        
        function updateTurfScoreDisplay() {
            document.getElementById('score-red-val').innerText = Math.round(redScore);
            document.getElementById('score-blue-val').innerText = Math.round(blueScore);
            var total = redScore + blueScore;
            if(total > 0) {
                var redPct = (redScore / total) * 100;
                document.getElementById('bar-red').style.width = redPct + "%";
                document.getElementById('bar-blue').style.width = (100 - redPct) + "%";
            }
        }

        // ==========================
        // ğŸ§± ç”µå­å›´æ é€»è¾‘
        // ==========================
        function toggleDrawFence() {
            if(isDrawingFence) {
                isDrawingFence = false;
                drawTempPoints = [];
                if(drawTempLayer) { map.removeLayer(drawTempLayer); drawTempLayer = null; }
                document.getElementById('draw-fence-btn').innerText = "âœï¸ åˆ’å®šæ¸¸æˆèŒƒå›´";
                showToast("å·²å–æ¶ˆç»˜åˆ¶");
            } else {
                isDrawingFence = true;
                drawTempPoints = [];
                document.getElementById('draw-fence-btn').innerText = "âŒ å–æ¶ˆç»˜åˆ¶ (åŒå‡»åœ°å›¾å®Œæˆ)";
                showToast("è¯·åœ¨åœ°å›¾ä¸Šç‚¹å‡»ç‚¹ï¼ŒåŒå‡»ç»“æŸ");
            }
        }
        
        function finishDrawing() {
            if(!isDrawingFence) return;
            if(drawTempPoints.length < 3) { alertBox("è‡³å°‘éœ€è¦3ä¸ªç‚¹æ‰èƒ½æ„æˆåŒºåŸŸï¼"); return; }
            
            isDrawingFence = false;
            document.getElementById('draw-fence-btn').innerText = "âœï¸ é‡ç”»èŒƒå›´";
            
            var flatPoints = drawTempPoints.map(p => [p.lat, p.lng]);
            publishData({ type: 'sys_update_fence', points: flatPoints });
            updateFenceVisuals(flatPoints);
            if(drawTempLayer) { map.removeLayer(drawTempLayer); drawTempLayer = null; }
        }
        
        function updateFenceVisuals(points) {
            fencePoints = points;
            if(fencePolygonLayer) map.removeLayer(fencePolygonLayer);
            if(points && points.length > 0) {
                fencePolygonLayer = L.polygon(points, { color: 'red', fillOpacity: 0.1, dashArray: '5, 5' }).addTo(map);
                document.getElementById('fence-status').innerText = "âœ… å·²è®¾ç½®èŒƒå›´";
            } else {
                document.getElementById('fence-status').innerText = "æœªè®¾ç½®èŒƒå›´";
            }
        }
        
        function isPointInPolygon(lat, lng, polyPoints) {
            var x = lat, y = lng;
            var inside = false;
            for (var i = 0, j = polyPoints.length - 1; i < polyPoints.length; j = i++) {
                var xi = polyPoints[i][0], yi = polyPoints[i][1];
                var xj = polyPoints[j][0], yj = polyPoints[j][1];
                var intersect = ((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }
        
        function getRandomPointInPolygon(polyPoints) {
            if(!polyPoints || polyPoints.length < 3) return null;
            // ç®€å•çš„è¾¹ç•Œæ¡†æ³•
            var minLat = 90, maxLat = -90, minLng = 180, maxLng = -180;
            polyPoints.forEach(p => {
                if(p[0] < minLat) minLat = p[0];
                if(p[0] > maxLat) maxLat = p[0];
                if(p[1] < minLng) minLng = p[1];
                if(p[1] > maxLng) maxLng = p[1];
            });
            
            for(var i=0; i<50; i++) { // å°è¯•50æ¬¡
                var lat = minLat + Math.random() * (maxLat - minLat);
                var lng = minLng + Math.random() * (maxLng - minLng);
                if(isPointInPolygon(lat, lng, polyPoints)) {
                    return [lat, lng];
                }
            }
            return null; // å¤±è´¥
        }

        // ==========================
        // ğŸ—³ï¸ æŠ•ç¥¨ä¸å¼€å§‹
        // ==========================
        function initiateVote() {
            if(currentMode === 'normal') return;
            
            var title = document.getElementById('vote-title');
            var rules = document.getElementById('vote-rules');
            var zRow = document.getElementById('setting-zombie-row');
            
            rules.innerHTML = "";
            zRow.style.display = "none";
            
            if(currentMode === 'bio') {
                title.innerText = "å‡†å¤‡å¼€å§‹ç”ŸåŒ–æ¨¡å¼"; zRow.style.display = "flex";
                rules.innerHTML = `<li>ğŸ¯ <b>ç›®æ ‡ï¼š</b>å¹¸å­˜è€…å­˜æ´» æˆ– åƒµå°¸æ„ŸæŸ“å…¨å‘˜ã€‚</li><li>ğŸ§Ÿ <b>æ„ŸæŸ“ï¼š</b>è·ç¦» < 10ç±³ è‡ªåŠ¨æ„ŸæŸ“ã€‚</li>`;
            } else if (currentMode === 'turf') {
                title.innerText = "å‡†å¤‡å¼€å§‹æ¶‚é¸¦æˆ˜äº‰";
                rules.innerHTML = `<li>ğŸ¯ <b>ç›®æ ‡ï¼š</b>è·‘åŠ¨è¦†ç›–æ›´é•¿è·¯å¾„ã€‚</li><li>ğŸ–Œï¸ <b>è§„åˆ™ï¼š</b>è½¨è¿¹ä¼šè¦†ç›–å¯¹æ‰‹é¢œè‰²ã€‚</li>`;
            } else if (currentMode === 'ghost') {
                title.innerText = "å‡†å¤‡å¼€å§‹å¹½çµæ¨¡å¼";
                rules.innerHTML = `<li>ğŸ¯ <b>å¥½äººï¼š</b>å‰å¾€ä¸“å±ä»»åŠ¡ç‚¹ã€‚</li><li>ğŸ”ª <b>å†…é¬¼ï¼š</b>å‡»æ€å¥½äºº(é è¿‘)ã€‚</li><li>ğŸŒ«ï¸ <b>è¿·é›¾ï¼š</b>30ç§’éšèº«ï¼Œæ€æ‰‹éœ€é›·è¾¾ã€‚</li>`;
            }
            
            publishData({ type: 'vote_init', initiator: myName, mode: currentMode });
        }
        
        function castVote() {
            publishData({ type: 'vote_cast', id: myUniqueId });
            document.getElementById('btn-vote-yes').disabled = true;
            document.getElementById('btn-vote-yes').innerText = "å·²å‡†å¤‡";
        }
        
        function finalStartGame() {
            if (currentMode === 'ghost' && fencePoints.length === 0) {
                alertBox("âš ï¸ å¹½çµæ¨¡å¼å¿…é¡»åˆ’å®šå›´æ æ‰èƒ½ç”Ÿæˆä»»åŠ¡ç‚¹ï¼");
                return;
            }
            
            document.getElementById('common-vote-overlay').style.display = 'none';
            var mins = document.getElementById('custom-game-time').value;
            var numZombies = document.getElementById('custom-zombie-num').value;
            
            var duration = (parseInt(mins) || 5) * 60;
            var zCount = parseInt(numZombies) || 1;
            
            publishData({ type: 'game_countdown', count: 10 });
            
            setTimeout(function() {
                publishData({ type: 'sys_clear_map' });
                
                if(currentMode === 'bio') {
                    var candidates = Object.keys(otherPlayers);
                    candidates.push(myUniqueId);
                    var targetIds = [];
                    for(var i=0; i<zCount && candidates.length > 0; i++) {
                        var idx = Math.floor(Math.random() * candidates.length);
                        targetIds.push(candidates[idx]);
                        candidates.splice(idx, 1); 
                    }
                    publishData({ type: 'game_infect_batch', targets: targetIds });
                } else if (currentMode === 'ghost') {
                    var players = Object.keys(otherPlayers);
                    players.push(myUniqueId);
                    var killer = players[Math.floor(Math.random() * players.length)];
                    
                    // ä¸ºæ¯ä¸ªäººç”Ÿæˆå”¯ä¸€ä»»åŠ¡ç‚¹
                    var targetsMap = {};
                    players.forEach(pid => {
                        var pt = getRandomPointInPolygon(fencePoints);
                        if(pt) targetsMap[pid] = {lat: pt[0], lng: pt[1]};
                    });
                    
                    publishData({ type: 'ghost_start', killer: killer, targets: targetsMap });
                }
                
                publishData({ type: 'game_start_timer', timestamp: Date.now(), duration: duration });
            }, 10000);
        }

        // ==========================
        // ğŸ‘» å¹½çµæ¨¡å¼
        // ==========================
        function startGhostRound(killerId, targets) {
            myRole = (myUniqueId === killerId) ? 'impostor' : 'crew';
            
            // ä¿å­˜æ‰€æœ‰ç›®æ ‡ç‚¹ï¼Œç”¨äºæ€æ‰‹å¯è§
            allGhostTargets = {};
            for(var uid in targets) {
                var t = targets[uid];
                var iconType = (uid === myUniqueId) ? 'â­' : 'ğŸ¯';
                // åªæœ‰è‡ªå·±æˆ–è€…æ˜¯æ€æ‰‹æ‰èƒ½çœ‹åˆ°ç‚¹
                if (uid === myUniqueId || myRole === 'impostor') {
                    var m = L.marker([t.lat, t.lng], { 
                        icon: L.divIcon({ className: 'flag-icon', html: iconType, iconSize: [30, 30] }) 
                    }).addTo(map);
                    if (uid === myUniqueId) {
                        m.bindPopup("<b>æˆ‘çš„ä»»åŠ¡ç‚¹</b>").openPopup();
                        ghostTarget = m;
                    } else {
                        m.bindPopup("ç©å®¶ç›®æ ‡");
                    }
                    allGhostTargets[uid] = m;
                }
            }

            if(myRole === 'impostor') {
                alertBox("ğŸ”ª ä½ æ˜¯å†…é¬¼ï¼å»å‡»æ€å¥½äººï¼");
                document.getElementById('ghost-status-text').innerText = "ğŸ”ª ç›®æ ‡ï¼šå‡»æ€æ‰€æœ‰å¥½äºº";
                document.getElementById('ghost-status-text').style.color = "red";
                document.getElementById('radar-btn').style.display = 'flex';
            } else {
                alertBox("ğŸ›¡ï¸ ä½ æ˜¯èˆ¹å‘˜ï¼å‰å¾€é»„è‰²æ˜Ÿæ˜Ÿæ‰“å¡ï¼");
                document.getElementById('ghost-status-text').innerText = "ğŸƒ ç›®æ ‡ï¼šå‰å¾€æ‰“å¡ç‚¹";
            }
            
            // å¯åŠ¨è¿·é›¾å¾ªç¯
            fogTimer = setInterval(function() {
                isFoggy = !isFoggy;
                showToast(isFoggy ? "ğŸŒ«ï¸ è¿·é›¾é™ä¸´..." : "â˜€ï¸ è§†é‡æ¢å¤");
                updatePlayerList();
            }, 30000);
        }
        
        function useRadar() {
            if(isRadarCooldown) return;
            isRadarCooldown = true;
            document.getElementById('radar-btn').classList.add('radar-cooldown');
            var tempFog = isFoggy;
            isFoggy = false;
            updatePlayerList();
            playBeep(800, 0.1);
            setTimeout(() => { isFoggy = tempFog; updatePlayerList(); }, 3000); 
            setTimeout(() => { isRadarCooldown = false; document.getElementById('radar-btn').classList.remove('radar-cooldown'); showToast("ğŸ“¡ é›·è¾¾å……èƒ½å®Œæ¯•"); }, 30000); 
        }
        
        function checkGhostInteractions() {
            if(!isGameRunning) return;
            
            // å¥½äººæ‰“å¡
            if(myRole === 'crew' && ghostTarget) {
                var d = map.distance(myLatLng, ghostTarget.getLatLng());
                if(d < 15) {
                    publishData({ type: 'ghost_win_crew', winner: myName });
                }
            }
            // åäººæ€äºº
            if(myRole === 'impostor') {
                for(var id in otherPlayers) {
                    var d = map.distance(myLatLng, [otherPlayers[id].lat, otherPlayers[id].lng]);
                    if(d < 10) { // å‡»æ€
                        publishData({ type: 'ghost_kill', victim: id, killer: myName });
                    }
                }
            }
        }

        // ==========================
        // ğŸ”Š éŸ³æ•ˆä¸è¡¨æƒ…
        // ==========================
        function playBeep(freq, dur) {
            if(!audioCtx) return;
            var osc = audioCtx.createOscillator();
            var gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = freq;
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + dur);
            osc.stop(audioCtx.currentTime + dur);
        }
        
        function checkProximityAlert() {
            var nearby = false;
            for(var id in otherPlayers) {
                var d = map.distance(myLatLng, [otherPlayers[id].lat, otherPlayers[id].lng]);
                if(d < 50) nearby = true;
            }
            if(nearby) playBeep(600, 0.05);
        }
        
        function toggleEmoji() {
            var bar = document.getElementById('emoji-bar');
            bar.style.display = (bar.style.display === 'none') ? 'flex' : 'none';
        }
        function sendEmoji(emoji) {
            publishData({ type: 'emoji_bomb', id: myUniqueId, emoji: emoji });
            toggleEmoji();
        }
        function showEmojiAnim(id, emoji) {
            var marker = (id === myUniqueId) ? myMarker : (otherPlayers[id] ? otherPlayers[id].marker : null);
            if(!marker) return;
            var pos = map.latLngToContainerPoint(marker.getLatLng());
            var el = document.createElement('div');
            el.className = 'floating-emoji';
            el.innerText = emoji;
            el.style.left = pos.x + 'px';
            el.style.top = pos.y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }

        // ==========================
        // æ¸¸æˆé€šç”¨é€»è¾‘
        // ==========================
        function becomeZombie() {
            if(isZombie) return;
            isZombie = true;
            zombieList.add(myUniqueId);
            document.getElementById('infection-effect').style.display = 'block';
            if (window.navigator && window.navigator.vibrate) { window.navigator.vibrate([200, 100, 200, 100, 500]); }
            alertBox("ğŸ§Ÿâ€â™‚ï¸ ä½ å·²è¢«æ„ŸæŸ“ï¼å»æŠ“æ•å¹¸å­˜è€…ï¼");
            myCurrentAvatar = "ğŸ§Ÿâ€â™‚ï¸"; myCurrentStatus = "å·²æ„ŸæŸ“";
            updateMyMarkerVisuals();
            publishData({ type: 'player_infected', id: myUniqueId, name: myName });
        }
        
        function updateTimerDisplay(secondsLeft) {
            var m = Math.floor(secondsLeft / 60);
            var s = Math.floor(secondsLeft % 60);
            var str = (m < 10 ? "0"+m : m) + ":" + (s < 10 ? "0"+s : s);
            document.getElementById('bio-timer').innerText = str;
            document.getElementById('turf-timer').innerText = str;
            document.getElementById('ghost-timer').innerText = str;
        }
        
        function checkWinCondition() {
            if (!isGameRunning) return;
            if (currentMode === 'bio') {
                var total = Object.keys(otherPlayers).length + 1;
                var zombies = zombieList.size;
                var survivors = total - zombies;
                if (survivors === 0 && zombies > 0) {
                    if(localTimerInterval) clearInterval(localTimerInterval);
                    isGameRunning = false; 
                    showWinModal("ğŸ§Ÿâ€â™‚ï¸ åƒµå°¸è·èƒœ", "å…¨å‘˜æ„ŸæŸ“ï¼Œæ— äººç”Ÿè¿˜", "red");
                }
            }
        }
        
        function showWinModal(title, desc, color) {
            document.getElementById('infection-effect').style.display = 'none';
            document.getElementById('out-bounds-effect').style.display = 'none';
            document.getElementById('win-title').innerText = title;
            document.getElementById('win-title').style.color = color;
            document.getElementById('win-desc').innerText = desc;
            document.getElementById('win-overlay').style.display = 'flex';
        }
        function closeWinOverlayAndReset() {
            document.getElementById('win-overlay').style.display = 'none';
            publishData({ type: 'sys_game_stop' });
        }

        function handleMqttMessage(topic, message) {
            try {
                var payloadStr = message.toString();
                var data = decryptPayload(payloadStr);
                if (!data) return; 

                if (data.type === 'sys_hello') {
                    if (currentMode !== 'normal') publishData({ type: 'sys_sync_state', mode: currentMode, running: isGameRunning, fence: fencePoints });
                    return;
                }
                if (data.type === 'sys_sync_state') {
                    if (data.mode !== 'normal' && currentMode === 'normal') {
                        switchMode(data.mode);
                        if (data.fence) updateFenceVisuals(data.fence);
                        if (data.running) { document.getElementById('force-stop-btn').style.display = 'block'; isGameRunning = true; }
                    }
                    return;
                }
                if (data.type === 'sys_mode_switch') { switchMode(data.mode); return; }
                if (data.type === 'sys_game_stop') { resetGameState(); showToast("â›” æ¸¸æˆå·²é‡ç½®"); return; }
                if (data.type === 'sys_update_fence') { updateFenceVisuals(data.points); return; }
                if (data.type === 'sys_announce') { showToast("ğŸ“¢ " + data.msg); appendChatMsg("ç³»ç»Ÿ", data.msg, false); return; }
                if (data.type === 'sys_clear_map') {
                    if(myPolyline) myPolyline.setLatLngs([]);
                    for(var id in otherPlayers) { if(otherPlayers[id].polyline) otherPlayers[id].polyline.setLatLngs([]); }
                    redScore = 0; blueScore = 0; updateTurfScoreDisplay();
                    return;
                }
                
                // æŠ•ç¥¨
                if (data.type === 'vote_init') {
                    voteSet.clear();
                    document.getElementById('vote-count').innerText = "0";
                    var title = document.getElementById('vote-title');
                    var rules = document.getElementById('vote-rules');
                    var zRow = document.getElementById('setting-zombie-row');
                    rules.innerHTML = ""; zRow.style.display = "none";
                    if(data.mode === 'bio') {
                        title.innerText = "å‡†å¤‡å¼€å§‹ç”ŸåŒ–æ¨¡å¼"; zRow.style.display = "flex";
                        rules.innerHTML = `<li>ğŸ¯ <b>ç›®æ ‡ï¼š</b>å¹¸å­˜è€…å­˜æ´» æˆ– åƒµå°¸æ„ŸæŸ“å…¨å‘˜ã€‚</li><li>ğŸ§Ÿ <b>æ„ŸæŸ“ï¼š</b>è·ç¦» < 10ç±³ è‡ªåŠ¨æ„ŸæŸ“ã€‚</li>`;
                    } else if (data.mode === 'turf') {
                        title.innerText = "å‡†å¤‡å¼€å§‹æ¶‚é¸¦æˆ˜äº‰";
                        rules.innerHTML = `<li>ğŸ¯ <b>ç›®æ ‡ï¼š</b>è·‘åŠ¨è¦†ç›–æ›´é•¿è·¯å¾„ã€‚</li><li>ğŸ–Œï¸ <b>è§„åˆ™ï¼š</b>è½¨è¿¹ä¼šè¦†ç›–å¯¹æ‰‹é¢œè‰²ã€‚</li>`;
                    } else if (data.mode === 'ghost') {
                        title.innerText = "å‡†å¤‡å¼€å§‹å¹½çµæ¨¡å¼";
                        rules.innerHTML = `<li>ğŸ¯ <b>å¥½äººï¼š</b>å‰å¾€ä¸“å±ä»»åŠ¡ç‚¹ã€‚</li><li>ğŸ”ª <b>å†…é¬¼ï¼š</b>å‡»æ€å¥½äººã€‚</li><li>ğŸŒ«ï¸ <b>è¿·é›¾ï¼š</b>æ¯30ç§’éšèº«ã€‚</li>`;
                    }
                    document.getElementById('common-vote-overlay').style.display = 'block';
                    document.getElementById('btn-vote-yes').disabled = false;
                    document.getElementById('btn-vote-yes').innerText = "ğŸ™‹â€â™‚ï¸ æˆ‘å‡†å¤‡å¥½äº†";
                    document.getElementById('admin-controls').style.display = (data.initiator === myName) ? 'block' : 'none';
                    return;
                }
                if (data.type === 'vote_cast') {
                    voteSet.add(data.id);
                    var total = Object.keys(otherPlayers).length + 1;
                    document.getElementById('vote-count').innerText = voteSet.size + " / " + total;
                    var btn = document.getElementById('admin-start-btn');
                    if (voteSet.size >= total) { btn.disabled = false; btn.innerText = "ğŸ”¥ ç¡®è®¤æœ€ç»ˆå¼€å§‹"; }
                    else { btn.disabled = true; btn.innerText = "ç­‰å¾…å…¨å‘˜å‡†å¤‡"; }
                    return;
                }

                // æ¸¸æˆé€šç”¨
                if (data.type === 'game_countdown') {
                    document.getElementById('common-vote-overlay').style.display = 'none';
                    var count = data.count;
                    var overlay = document.getElementById('countdown-overlay');
                    var numEl = document.getElementById('countdown-num');
                    overlay.style.display = 'flex';
                    numEl.innerText = count;
                    isGameRunning = true;
                    document.getElementById('force-stop-btn').style.display = 'block'; 
                    var timer = setInterval(function() {
                        count--; numEl.innerText = count;
                        if(count <= 0) { clearInterval(timer); overlay.style.display = 'none'; }
                    }, 1000);
                    return;
                }
                if (data.type === 'game_start_timer') {
                    if(localTimerInterval) clearInterval(localTimerInterval);
                    var serverStart = data.timestamp;
                    var duration = data.duration || 300; 
                    localTimerInterval = setInterval(function() {
                        var elapsed = Math.floor((Date.now() - serverStart) / 1000);
                        var remain = duration - elapsed;
                        if (remain <= 0) {
                            remain = 0;
                            clearInterval(localTimerInterval);
                            if (isGameRunning) {
                                isGameRunning = false;
                                if (currentMode === 'bio') {
                                    if(!isZombie) showWinModal("ğŸ›¡ï¸ å¹¸å­˜è€…èƒœåˆ©", "åšå®ˆåˆ°äº†æœ€åï¼", "#52c41a");
                                    else showWinModal("ğŸ›¡ï¸ å¹¸å­˜è€…èƒœåˆ©", "åƒµå°¸è¡ŒåŠ¨å¤±è´¥...", "#52c41a");
                                } else if (currentMode === 'turf') {
                                    if (redScore > blueScore) showWinModal("ğŸ”´ çº¢é˜Ÿèƒœåˆ©", `çº¢: ${Math.round(redScore)}m vs è“: ${Math.round(blueScore)}m`, "#ff4d4f");
                                    else showWinModal("ğŸ”µ è“é˜Ÿèƒœåˆ©", `è“: ${Math.round(blueScore)}m vs çº¢: ${Math.round(redScore)}m`, "#1890ff");
                                } else if (currentMode === 'ghost') {
                                    showWinModal("âŒ› æ—¶é—´è€—å°½", "å†…é¬¼æœªèƒ½é˜»æ­¢ä»»åŠ¡...", "#52c41a");
                                }
                            }
                        }
                        updateTimerDisplay(remain);
                    }, 1000);
                }

                // ç”ŸåŒ–æ¶ˆæ¯
                if (currentMode === 'bio') {
                    if (data.type === 'game_infect_batch') {
                        var targets = data.targets || [];
                        targets.forEach(function(tid) {
                            zombieList.add(tid);
                            if (tid === myUniqueId) becomeZombie();
                            else if (otherPlayers[tid]) {
                                otherPlayers[tid].avatar = "ğŸ§Ÿâ€â™‚ï¸";
                                otherPlayers[tid].marker.setIcon(L.divIcon({ className: 'emoji-marker-icon zombie-icon-style', html: "ğŸ§Ÿâ€â™‚ï¸", iconSize: [40, 40], iconAnchor: [20, 20] }));
                                otherPlayers[tid].polyline.setStyle({ color: '#ff0000' });
                            }
                        });
                        showToast("âš ï¸ æ¯ä½“å·²å‡ºç°ï¼"); updateBioStats(); checkWinCondition();
                    }
                    if (data.type === 'player_infected') {
                        zombieList.add(data.id);
                        if (data.id !== myUniqueId && otherPlayers[data.id]) {
                            otherPlayers[data.id].avatar = "ğŸ§Ÿâ€â™‚ï¸";
                            otherPlayers[data.id].marker.setIcon(L.divIcon({ className: 'emoji-marker-icon zombie-icon-style', html: "ğŸ§Ÿâ€â™‚ï¸", iconSize: [40, 40], iconAnchor: [20, 20] }));
                            otherPlayers[data.id].polyline.setStyle({ color: '#ff0000' });
                            showToast("âš ï¸ " + otherPlayers[data.id].name + " å˜å¼‚äº†ï¼");
                        }
                        updateBioStats(); checkWinCondition();
                    }
                }
                
                // æ¶‚é¸¦æ¶ˆæ¯
                if (currentMode === 'turf') {
                    if (data.type === 'turf_join') { if(otherPlayers[data.id]) otherPlayers[data.id].team = data.team; }
                }
                
                // å¹½çµæ¶ˆæ¯
                if (currentMode === 'ghost') {
                    if (data.type === 'ghost_start') { startGhostRound(data.killer, data.targets); }
                    if (data.type === 'ghost_kill') {
                        showToast("â˜ ï¸ " + (otherPlayers[data.victim] ? otherPlayers[data.victim].name : "æœ‰äºº") + " è¢«å‡»æ€äº†ï¼");
                        if(data.victim === myUniqueId) {
                            alertBox("â˜ ï¸ ä½ å·²è¢«å†…é¬¼å‡»æ€ï¼");
                            map.removeLayer(myMarker); 
                        }
                        if(localTimerInterval) clearInterval(localTimerInterval);
                        isGameRunning = false;
                        showWinModal("ğŸ”ª å†…é¬¼èƒœåˆ©", "å¥½äººå·²è¢«å‡»æ€", "red");
                    }
                    if (data.type === 'ghost_win_crew') {
                        if(localTimerInterval) clearInterval(localTimerInterval);
                        isGameRunning = false;
                        showWinModal("ğŸ›¡ï¸ å¥½äººèƒœåˆ©", data.winner + " å®Œæˆäº†ä»»åŠ¡ï¼", "#52c41a");
                    }
                }
                
                // æ‚é¡¹
                if (data.type === 'chat') { if (data.senderId !== myUniqueId) appendChatMsg(data.senderName, data.text, false); }
                if (data.type === 'emoji_bomb') { showEmojiAnim(data.id, data.emoji); }
                if (data.type === 'flag_update') {
                    if (data.action === 'add') {
                        if (currentFlag) map.removeLayer(currentFlag);
                        var flagIcon = L.divIcon({ className: 'flag-icon', html: 'ğŸ', iconSize: [30, 40] });
                        currentFlag = L.marker([data.lat, data.lng], { icon: flagIcon }).addTo(map).bindPopup(`<b>ğŸ é›†åˆ</b><br>å‘èµ·: ${data.senderName}<br><button onclick="removeFlag()">âŒ å–æ¶ˆ</button>`).openPopup();
                    } else if (data.action === 'remove') { if (currentFlag) { map.removeLayer(currentFlag); currentFlag = null; } }
                }
                
                if (data.id === myUniqueId) return;
                
                var now = Date.now(); 
                var pAvatar = data.avatar || "ğŸ“"; 
                if (currentMode === 'bio' && zombieList.has(data.id)) { pAvatar = "ğŸ§Ÿâ€â™‚ï¸"; }

                if (!otherPlayers[data.id]) {
                    var iconClass = 'emoji-marker-icon other-icon-style';
                    if (currentMode === 'bio' && zombieList.has(data.id)) iconClass = 'emoji-marker-icon zombie-icon-style';
                    if (currentMode === 'turf') {
                        if (data.team === 'red') iconClass = 'emoji-marker-icon turf-red-icon';
                        if (data.team === 'blue') iconClass = 'emoji-marker-icon turf-blue-icon';
                    }

                    var icon = L.divIcon({ className: iconClass, html: pAvatar, iconSize: [40, 40], iconAnchor: [20, 20] });
                    var newMarker = L.marker([data.lat, data.lng], { icon: icon }).addTo(map);
                    if(data.status) newMarker.bindTooltip(data.status, { permanent: true, direction: 'top', offset: [0, -22], className: 'status-bubble' });
                    
                    newMarker.bindPopup(`<b>${data.name}</b>`);
                    var lineColor = '#ff4d4f'; var lineWidth = 4; var lineOpacity = 0.6;
                    
                    if (currentMode === 'bio' && zombieList.has(data.id)) lineColor = '#ff0000';
                    if (currentMode === 'turf') {
                        lineWidth = 30; lineOpacity = 0.5;
                        lineColor = (data.team === 'red') ? '#ff4d4f' : '#1890ff';
                    }

                    var newPolyline = L.polyline([], { color: lineColor, weight: lineWidth, opacity: lineOpacity, lineCap: 'round' }).addTo(map); 
                    newPolyline.addLatLng([data.lat, data.lng]);
                    
                    otherPlayers[data.id] = { marker: newMarker, polyline: newPolyline, lastSeen: now, lat: data.lat, lng: data.lng, avatar: pAvatar, status: data.status, name: data.name, team: data.team, crumbs: [] };
                } else {
                    var p = otherPlayers[data.id]; 
                    var lastLat = p.lat; var lastLng = p.lng;
                    p.marker.setLatLng([data.lat, data.lng]); 
                    p.polyline.addLatLng([data.lat, data.lng]);
                    
                    if(p.polyline.getLatLngs().length > 500) { var pts = p.polyline.getLatLngs(); pts.shift(); p.polyline.setLatLngs(pts); }
                    p.lastSeen = now; p.lat = data.lat; p.lng = data.lng;
                    
                    if (currentMode === 'turf' && data.team && isGameRunning) {
                        var dist = map.distance([lastLat, lastLng], [data.lat, data.lng]);
                        var isInside = true;
                        if(fencePoints.length > 0) isInside = isPointInPolygon(data.lat, data.lng, fencePoints);
                        if(dist < 50 && isInside) { 
                            if (data.team === 'red') redScore += dist; else if (data.team === 'blue') blueScore += dist;
                            updateTurfScoreDisplay();
                        }
                    }
                    
                    if (currentMode === 'ghost' && isGameRunning) {
                        if (!p.crumbs) p.crumbs = [];
                        var crumb = L.circleMarker([data.lat, data.lng], { radius: 2, color: '#999', fillOpacity:0.5 }).addTo(map);
                        p.crumbs.push(crumb);
                        setTimeout(() => map.removeLayer(crumb), 600000); 
                    }

                    if (p.name !== data.name) { p.marker.bindPopup(`<b>${data.name}</b>`); p.name = data.name; }
                    
                    var iconClass = 'emoji-marker-icon other-icon-style';
                    var lineColor = '#ff4d4f'; var lineWidth = 4;
                    
                    if (currentMode === 'bio' && zombieList.has(data.id)) {
                        iconClass = 'emoji-marker-icon zombie-icon-style'; lineColor = '#ff0000'; pAvatar = "ğŸ§Ÿâ€â™‚ï¸";
                    } else if (currentMode === 'turf') {
                        if (data.team === 'red') { iconClass = 'emoji-marker-icon turf-red-icon'; lineColor='#ff4d4f'; }
                        if (data.team === 'blue') { iconClass = 'emoji-marker-icon turf-blue-icon'; lineColor='#1890ff'; }
                        lineWidth = 30; p.polyline.setStyle({ opacity: 0.5, lineCap: 'round' });
                    }
                    
                    p.marker.setIcon(L.divIcon({ className: iconClass, html: pAvatar, iconSize: [40, 40], iconAnchor: [20, 20] })); 
                    p.polyline.setStyle({ color: lineColor, weight: lineWidth });
                    
                    // å¹½çµæ¨¡å¼æ˜¾éšé€»è¾‘
                    // å¹¸å­˜è€…çœ‹é˜Ÿå‹å¯è§ï¼Œçœ‹æ€æ‰‹ï¼ˆå¦‚æœæ€æ‰‹åœ¨è¿·é›¾ä¸­ï¼‰ä¸å¯è§ï¼Ÿ
                    // ä¸ºäº†ç®€åŒ–ï¼šè¿·é›¾æœŸé—´ï¼Œåªæ˜¾ç¤ºè‡ªå·±ã€‚
                    // ä½†æ˜¯ prompt è¯´ "è‡ªå·±é˜µè¥çš„æ²¡æœ‰è¿·é›¾"ã€‚
                    // å¦‚æœæˆ‘æ˜¯ Crew, æˆ‘çœ‹ Crew å¯è§ã€‚Impostor å¦‚æœä¼ªè£…æˆ Crew åº”è¯¥ä¹Ÿå¯è§ï¼Ÿ
                    // é€»è¾‘ï¼šGhost Mode ä¸‹ï¼Œè¿·é›¾æœŸé—´åªéšè—â€œæ•Œå¯¹é˜µè¥â€ï¼Ÿ
                    // æ€æ‰‹è§†è§’ï¼šçœ‹ä¸åˆ°å¹¸å­˜è€…ã€‚å¹¸å­˜è€…è§†è§’ï¼šçœ‹ä¸åˆ°æ€æ‰‹ã€‚
                    // ç®€å•å®ç°ï¼šè¿·é›¾æœŸé—´ï¼Œé™¤äº†è‡ªå·±ï¼Œè°éƒ½çœ‹ä¸è§ï¼ˆé™¤éç”¨äº†é›·è¾¾ï¼‰ã€‚
                    if (currentMode === 'ghost' && isGameRunning && isFoggy) {
                        p.marker.setOpacity(0); p.polyline.setStyle({opacity: 0});
                    } else {
                        p.marker.setOpacity(1); 
                        if(currentMode !== 'ghost') p.polyline.setStyle({opacity: (currentMode==='turf'?0.5:0.8)});
                    }

                    if (p.status !== data.status) { 
                        p.status = data.status; p.status ? p.marker.bindTooltip(p.status, { permanent: true, direction: 'top', offset: [0, -22], className: 'status-bubble' }) : p.marker.unbindTooltip(); 
                    }
                }
                updatePlayerList();
                if(currentMode === 'bio') updateBioStats();
            } catch (e) { console.error("Msg Error", e); }
        }

        function updateBioStats() {
            var total = Object.keys(otherPlayers).length + 1;
            var zombies = zombieList.size;
            var survivors = total - zombies;
            document.getElementById('survivor-count').innerText = survivors;
            document.getElementById('zombie-count').innerText = zombies;
        }

        var currentViewMode = 'auto';
        function setViewMode(mode, btnElement) {
            currentViewMode = mode; var btns = document.querySelectorAll('.view-opt'); btns.forEach(b => b.classList.remove('active')); if(btnElement) btnElement.classList.add('active'); applyViewMode();
        }
        function applyViewMode() {
            var body = document.body; var isMobile = false;
            if (currentViewMode === 'mobile') isMobile = true; else if (currentViewMode === 'pc') isMobile = false; else isMobile = window.innerWidth <= 600;
            if (isMobile) { body.classList.add('view-mobile'); if (!body.dataset.initMobile) { toggleChat(true); togglePlayerPanel(true); body.dataset.initMobile = "true"; } } else { body.classList.remove('view-mobile'); }
        }
        window.addEventListener('resize', function() { if (currentViewMode === 'auto') applyViewMode(); });

        function togglePlayerPanel() {
            var content = document.getElementById('player-content'); var icon = document.getElementById('player-toggle-icon'); 
            var isHidden = content.style.display === 'none';
            content.style.display = isHidden ? 'block' : 'none';
            icon.innerText = isHidden ? "â–¼" : "â—€";
            icon.style.transform = isHidden ? "rotate(0deg)" : "rotate(90deg)";
        }
        function toggleChat(forceCollapse) {
            var panel = document.getElementById('chat-panel'); var icon = document.getElementById('chat-toggle-icon'); var badge = document.getElementById('chat-badge');
            if (forceCollapse === true || !panel.classList.contains('collapsed')) { panel.classList.add('collapsed'); icon.innerText = "â–²"; } else { panel.classList.remove('collapsed'); icon.innerText = "â–¼"; badge.style.display = 'none'; }
        }

        function toggleMeasure() {
            isMeasuring = !isMeasuring; var btn = document.getElementById('measure-btn');
            if(isMeasuring) { 
                btn.classList.add('active'); btn.innerHTML = "âŒ"; document.getElementById('map').style.cursor = "crosshair"; 
                showToast("ç‚¹å‡»åœ°å›¾ä¸¤ç‚¹æµ‹é‡"); if(isFollowing) toggleFollow(); 
            } else { 
                btn.classList.remove('active'); btn.innerHTML = "ğŸ“"; document.getElementById('map').style.cursor = ""; clearMeasure(); 
            }
        }
        function clearMeasure() { if(measureLine) map.removeLayer(measureLine); measureTips.forEach(t => map.removeLayer(t)); measurePoints = []; measureTips = []; }

        function toggleFollow() {
            isFollowing = !isFollowing; var btn = document.getElementById('follow-btn');
            if(isFollowing) { btn.classList.add('active'); if(myLatLng) map.flyTo(myLatLng, 18); showToast("è§†è§’è·Ÿéšå·²å¼€å¯"); } 
            else { btn.classList.remove('active'); showToast("è§†è§’è·Ÿéšå·²å…³é—­"); }
        }

        function onMapClick(e) {
            if(isDrawingFence) {
                drawTempPoints.push(e.latlng);
                if(drawTempLayer) map.removeLayer(drawTempLayer);
                drawTempLayer = L.polygon(drawTempPoints, { color: 'orange', dashArray: '5, 5' }).addTo(map);
                return;
            }
            if (isMeasuring) {
                measurePoints.push(e.latlng);
                var tip = L.circleMarker(e.latlng, { color: '#00f3ff', radius: 4 }).addTo(map); measureTips.push(tip);
                if (measurePoints.length === 2) {
                    var p1 = measurePoints[0]; var p2 = measurePoints[1];
                    var dist = map.distance(p1, p2); 
                    var distStr = dist > 1000 ? (dist/1000).toFixed(2) + " km" : Math.round(dist) + " m";
                    measureLine = L.polyline([p1, p2], { color: '#00f3ff', weight: 2, dashArray: '5, 5' }).addTo(map);
                    measureLine.bindPopup(`<b>ğŸ“ ${distStr}</b>`).openPopup();
                    measurePoints = []; setTimeout(() => { measureTips.forEach(t => map.removeLayer(t)); measureTips = []; }, 500);
                } else if (measurePoints.length > 2) { clearMeasure(); }
            }
        }
        function onMapContextMenu(e) {
            if(isMeasuring) return;
            confirmBox("ğŸš© æ’æ——é›†åˆï¼Ÿ", function() {
                publishData({ type: 'flag_update', senderName: myName, action: 'add', lat: e.latlng.lat, lng: e.latlng.lng });
            });
        }
        window.removeFlag = function() { confirmBox("å–æ¶ˆé›†åˆç‚¹ï¼Ÿ", function() { publishData({ type: 'flag_update', action: 'remove' }); }); };

        function handleChatKey(e) { if(e.key === 'Enter') sendChat(); }
        function sendChat() {
            var input = document.getElementById('chat-input'); var text = input.value; if(!text.trim()) return;
            publishData({ type: 'chat', senderId: myUniqueId, senderName: myName, text: text });
            appendChatMsg(myName, text, true); input.value = "";
        }
        function appendChatMsg(name, text, isMe) {
            var box = document.getElementById('chat-messages'); var div = document.createElement('div'); div.className = 'chat-msg-row';
            var senderHtml = isMe ? `<span class="chat-sender" style="color:#1890ff">æˆ‘:</span>` : `<span class="chat-sender" style="color:#ff4d4f">${name}:</span>`;
            div.innerHTML = `${senderHtml} <span class="chat-text">${text}</span>`;
            if (box.children.length > 100) box.removeChild(box.firstChild);
            box.appendChild(div); box.scrollTop = box.scrollHeight;
            if (!isMe && document.getElementById('chat-panel').classList.contains('collapsed')) { showMsgBubble(name, text); document.getElementById('chat-badge').style.display = 'block'; }
        }
        function showMsgBubble(name, text) {
            var container = document.getElementById('msg-bubble-container'); var bubble = document.createElement('div'); bubble.className = 'msg-bubble';
            bubble.innerText = `${name}: ${text}`; container.appendChild(bubble); setTimeout(() => { bubble.style.opacity = '0'; setTimeout(() => bubble.remove(), 300); }, 3000);
        }
        function showToast(msg) {
            var t = document.getElementById('toast'); t.innerText = msg; t.style.opacity = 1;
            setTimeout(function(){ t.style.opacity = 0; }, 2500);
        }
        
        window.copyMyCoord = function() {
            if(!myLatLng) return;
            var text = myLatLng.lat.toFixed(6) + "," + myLatLng.lng.toFixed(6);
            navigator.clipboard.writeText(text).then(() => { alertBox("åæ ‡å·²å¤åˆ¶: " + text); }).catch(() => alertBox("å¤åˆ¶å¤±è´¥"));
        };

        function triggerQuietUpdate() { clearTimeout(debounceTimer); debounceTimer = setTimeout(function() { locateAndShare(false); }, 800); }
        document.getElementById('my-name-input').addEventListener('input', function(e) { myName = e.target.value.trim(); SafeStorage.setItem('my_nickname', myName); triggerQuietUpdate(); });
        document.getElementById('my-avatar-input').addEventListener('input', function(e) { myCurrentAvatar = e.target.value; updateMyMarkerVisuals(); triggerQuietUpdate(); });
        document.getElementById('my-status-input').addEventListener('input', function(e) { myCurrentStatus = e.target.value; updateMyMarkerVisuals(); triggerQuietUpdate(); });

        function updateMyMarkerVisuals() {
            if(!myMarker) return;
            var arrowHtml = `<div class="heading-arrow"></div>` + myCurrentAvatar;
            var iconClass = 'emoji-marker-icon my-icon-style';
            
            if (currentMode === 'bio' && isZombie) iconClass = 'emoji-marker-icon zombie-icon-style';
            if (currentMode === 'turf') {
                if (myTeam === 'red') iconClass = 'emoji-marker-icon turf-red-icon';
                if (myTeam === 'blue') iconClass = 'emoji-marker-icon turf-blue-icon';
            }

            myMarker.setIcon(L.divIcon({ className: iconClass, html: arrowHtml, iconSize: [40, 40], iconAnchor: [20, 20] }));
            if (myCurrentStatus) myMarker.bindTooltip(myCurrentStatus, { permanent: true, direction: 'top', offset: [0, -22], className: 'status-bubble' }); else myMarker.unbindTooltip();
            updateHeadingVisuals();
        }
        function updatePlayerList() {
            var container = document.getElementById('player-list-container'); container.innerHTML = ""; var hasPlayers = false;
            for (var id in otherPlayers) {
                hasPlayers = true; var p = otherPlayers[id];
                var distText = "--"; if (myLatLng) { var d = map.distance(myLatLng, [p.lat, p.lng]); d > 1000 ? distText = (d/1000).toFixed(1)+"km" : distText = Math.round(d)+"m"; }
                var statusHtml = p.status ? `<div class="player-status-text">ğŸ’¬ ${p.status}</div>` : '';
                var item = document.createElement('div'); item.className = 'player-item';
                item.innerHTML = `<div class="player-info"><div class="player-head"><span>${p.avatar}</span><span>${p.name}</span></div>${statusHtml}</div><div class="player-dist">${distText}</div>`;
                (function(targetLat, targetLng) { item.onclick = function() { map.flyTo([targetLat, targetLng], 18, { duration: 1.5 }); }; })(p.lat, p.lng);
                container.appendChild(item);
            }
            if (!hasPlayers) container.innerHTML = '<div style="font-size:12px; color:#ccc; text-align:center; padding:10px;">æš‚æ— å…¶ä»–äºº</div>';
        }

        function locateAndShare(showAlert = false) { 
            map.locate({ setView: false, maxZoom: 17, timeout: 30000, enableHighAccuracy: true, maximumAge: 0 }); 
            if(showAlert) showToast("æ­£åœ¨åˆ·æ–°ä½ç½®..."); 
        }
        function triggerManualLocate() { locateAndShare(true); }
        var isFirstLocate = true;
        
        function onLocationFound(e) {
            myLatLng = e.latlng; 
            var lastLat = myLatLng ? myLatLng.lat : e.latlng.lat;
            var lastLng = myLatLng ? myLatLng.lng : e.latlng.lng;
            
            if (isFollowing) map.panTo(myLatLng);
            
            var lineColor = '#3388ff'; var lineWidth = 4; var lineOpacity = 0.8;
            
            if(currentMode === 'turf') {
                lineWidth = 30; lineOpacity = 0.5;
                if(myTeam === 'red') lineColor = '#ff4d4f';
                if(myTeam === 'blue') lineColor = '#1890ff';
                
                if(myTeam && isGameRunning) {
                     var dist = map.distance([lastLat, lastLng], [e.latlng.lat, e.latlng.lng]);
                     var isInside = true;
                     if(fencePoints.length > 0) isInside = isPointInPolygon(e.latlng.lat, e.latlng.lng, fencePoints);
                     
                     if(dist < 50 && isInside) {
                         if(myTeam === 'red') redScore += dist;
                         if(myTeam === 'blue') blueScore += dist;
                         updateTurfScoreDisplay();
                     } else if (!isInside) {
                         document.getElementById('out-bounds-effect').style.display = 'block';
                         showToast("âš ï¸ å·²å‡ºç•Œï¼åœæ­¢æ¶‚è‰²ï¼");
                     } else {
                         document.getElementById('out-bounds-effect').style.display = 'none';
                     }
                }
            }

            if (!myPolyline) myPolyline = L.polyline([], { color: lineColor, weight: lineWidth, opacity: lineOpacity, lineCap: 'round' }).addTo(map); 
            else myPolyline.setStyle({ color: lineColor, weight: lineWidth, opacity: lineOpacity });
            
            myPolyline.addLatLng(e.latlng);
            if(myPolyline.getLatLngs().length > 500) { var pts = myPolyline.getLatLngs(); pts.shift(); myPolyline.setLatLngs(pts); }

            if (!myMarker) { 
                var arrowHtml = `<div class="heading-arrow"></div>` + myCurrentAvatar;
                myMarker = L.marker(e.latlng, { icon: L.divIcon({ className: 'emoji-marker-icon my-icon-style', html: arrowHtml, iconSize: [40, 40], iconAnchor: [20, 20] }) })
                    .addTo(map)
                    .bindPopup(`<b>æˆ‘</b><br><button onclick="copyMyCoord()" style="font-size:11px;margin-top:5px;">ğŸ“‹ å¤åˆ¶åæ ‡</button>`).openPopup(); 
                if(myCurrentStatus) updateMyMarkerVisuals(); 
            } else myMarker.setLatLng(e.latlng);
            
            if (isFirstLocate) { map.setView(e.latlng, 17); isFirstLocate = false; }
            
            if (currentMode === 'bio' && isGameRunning && !isZombie) {
                // 1. ç”µå­å›´æ 
                if(fencePoints.length > 0) {
                    var isInside = isPointInPolygon(e.latlng.lat, e.latlng.lng, fencePoints);
                    if(!isInside) {
                        document.getElementById('out-bounds-effect').style.display = 'block';
                        showToast("âš ï¸ è­¦å‘Šï¼šä½ å·²ç¦»å¼€æˆ˜åŒºï¼è¯·ç«‹å³è¿”å›ï¼");
                        if(!outOfBoundsTimer) {
                            outOfBoundsTimer = setTimeout(function() {
                                publishData({ type: 'sys_announce', msg: myName + " ç•ç½ªæ½œé€ƒï¼Œåˆ¤å®šå‡ºå±€/è¿è§„ï¼" });
                            }, 10000);
                        }
                    } else {
                        document.getElementById('out-bounds-effect').style.display = 'none';
                        if(outOfBoundsTimer) { clearTimeout(outOfBoundsTimer); outOfBoundsTimer = null; }
                    }
                }
                // 2. æ„ŸæŸ“
                for (var id in otherPlayers) {
                    if (zombieList.has(id)) {
                        var dist = map.distance(myLatLng, [otherPlayers[id].lat, otherPlayers[id].lng]);
                        if (dist < 10) { becomeZombie(); }
                    }
                }
            }
            
            // å¹½çµæ¨¡å¼è¿‘è·ç¦»è­¦æŠ¥
            if(currentMode === 'ghost' && isGameRunning) {
                // å›´æ æ£€æµ‹
                if(fencePoints.length > 0) {
                    var isInside = isPointInPolygon(e.latlng.lat, e.latlng.lng, fencePoints);
                    if(!isInside) {
                        document.getElementById('out-bounds-effect').style.display = 'block';
                        showToast("âš ï¸ å·²ç¦»å¼€å›´æ ï¼");
                    } else {
                        document.getElementById('out-bounds-effect').style.display = 'none';
                    }
                }
                
                checkProximityAlert();
                checkGhostInteractions();
            }
            
            publishData({ type: 'player_update', id: myUniqueId, name: myName, lat: e.latlng.lat, lng: e.latlng.lng, avatar: myCurrentAvatar, status: myCurrentStatus, team: myTeam });
        }

        if (window.DeviceOrientationEvent) {
            window.addEventListener('deviceorientation', function(event) {
                if (event.alpha !== null) {
                    var heading = event.webkitCompassHeading || (360 - event.alpha);
                    myHeading = heading; updateHeadingVisuals();
                }
            }, true);
        }
        function updateHeadingVisuals() {
            var arrow = document.querySelector('.my-icon-style .heading-arrow');
            if(arrow) { arrow.style.display = 'block'; arrow.style.transform = `translateX(-50%) rotate(${myHeading}deg)`; }
        }
    </script>
</body>
</html>
