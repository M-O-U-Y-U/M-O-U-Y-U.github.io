<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MOUYU æ¸¸æˆåœ°å›¾</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; background: #000; }
        
        /* ========================
           ğŸ” é—¨ç¦ç³»ç»Ÿ
           ======================== */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
            flex-direction: column; color: white;
        }
        .login-box {
            background: #1f1f1f; padding: 30px; border-radius: 16px; width: 85%; max-width: 320px;
            text-align: center; box-shadow: 0 0 20px rgba(0, 243, 255, 0.2); border: 1px solid #333;
        }
        .login-input {
            width: 100%; padding: 12px; font-size: 16px; border: 1px solid #444; border-radius: 8px;
            margin-bottom: 15px; text-align: center; outline: none; background: #2a2a2a; color: white;
        }
        .login-btn {
            width: 100%; padding: 12px; background: #00f3ff; color: #000; border: none;
            border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;
        }

        /* ========================
           ğŸ® æ¸¸æˆæ§åˆ¶å™¨ UI
           ======================== */
        .game-control-panel {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            z-index: 1000; display: none; /* é»˜è®¤éšè— */
            background: rgba(0, 0, 0, 0.8); border: 1px solid #00f3ff;
            padding: 10px 20px; border-radius: 30px; color: #00f3ff; font-weight: bold;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.3); pointer-events: auto;
            text-align: center; font-size: 14px;
        }
        .radar-scan-effect {
            position: absolute; top: 50%; left: 50%; width: 100vh; height: 100vh;
            transform: translate(-50%, -50%); border-radius: 50%;
            border: 2px solid rgba(0, 243, 255, 0.5); background: rgba(0, 243, 255, 0.1);
            opacity: 0; pointer-events: none; z-index: 900;
        }
        @keyframes radarPing { 0% { width: 0; height: 0; opacity: 1; } 100% { width: 100vmax; height: 100vmax; opacity: 0; } }

        /* é€šç”¨æŒ‰é’® */
        .map-btn {
            background: white; border: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            padding: 8px 12px; font-size: 13px; font-weight: 600; color: #333; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .locate-btn { position: absolute; bottom: 40px; right: 20px; z-index: 999; padding: 12px 20px; border-radius: 50px; }
        .follow-btn { position: absolute; bottom: 100px; right: 20px; z-index: 999; width: 40px; height: 40px; border-radius: 50%; font-size: 18px; }
        .measure-btn { position: absolute; bottom: 150px; right: 20px; z-index: 999; width: 40px; height: 40px; border-radius: 50%; font-size: 18px; }

        /* é¢æ¿åŸºç¡€æ ·å¼ */
        .player-list-panel {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px);
            padding: 15px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            width: 260px; max-height: 70vh; overflow-y: auto; 
            transition: all 0.3s ease;
        }
        @media (max-width: 600px) {
            .player-list-panel { width: 220px; top: 10px; right: 10px; padding: 10px; }
            .locate-btn { bottom: 30px; } .follow-btn { bottom: 90px; } .measure-btn { bottom: 135px; }
        }

        .panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 10px; cursor: pointer; }
        .panel-title { font-size: 14px; font-weight: 700; color: #1a1a1a; margin: 0; }
        
        .chat-panel {
            position: absolute; bottom: 30px; left: 20px; z-index: 1000;
            width: 280px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; transition: width 0.3s, transform 0.3s;
        }
        @media (max-width: 600px) { .chat-panel { width: 65%; left: 10px; bottom: 80px; } }
        
        .chat-header { background: #f0f2f5; padding: 10px 12px; font-size: 12px; font-weight: bold; color: #666; display: flex; justify-content: space-between; cursor: pointer; border-radius: 12px 12px 0 0; }
        .chat-panel.collapsed .chat-content-wrapper { display: none; }
        .chat-messages { height: 120px; overflow-y: auto; padding: 10px; font-size: 12px; background: white; }
        .chat-msg-row { margin-bottom: 4px; line-height: 1.4; word-wrap: break-word; }
        .chat-input-area { display: flex; padding: 8px; border-top: 1px solid #eee; background: #fff; border-radius: 0 0 12px 12px; }
        .chat-input { flex: 1; border: 1px solid #ddd; border-radius: 4px; padding: 6px; font-size: 12px; }
        .chat-send-btn { margin-left: 6px; background: #1890ff; color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 12px; }

        .user-setting-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .setting-label { font-size: 12px; color: #666; width: 40px; flex-shrink: 0; font-weight: bold; }
        .avatar-input { width: 40px; text-align: center; border: 1px solid #ddd; border-radius: 6px; padding: 4px; background: #f9f9f9; }
        .id-input, .status-input, .game-select { flex: 1; border: 1px solid #ddd; border-radius: 6px; padding: 4px 6px; font-size: 12px; background: #f9f9f9; }
        
        .player-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; margin-bottom: 4px; background: #f8f9fa; border-radius: 6px; cursor: pointer; }
        .emoji-marker-icon { position: relative; display: flex; justify-content: center; align-items: center; background: white; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.3); border: 2px solid white; font-size: 24px; transition: opacity 0.3s; }
        .my-icon-style { border-color: #3388ff; z-index: 1000 !important; }
        .heading-arrow { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid #3388ff; z-index: -1; }
        
        .toast-tip { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 8px; font-size: 14px; pointer-events: none; opacity: 0; transition: opacity 0.5s; z-index: 2000; }
        
        /* æ¸¸æˆæ¨¡å¼ç‰¹å®šæ ·å¼ */
        .game-btn { background: #ff4d4f; color: white; border: none; border-radius: 20px; padding: 5px 15px; cursor: pointer; margin-top: 5px; font-size: 12px; }
        .game-btn.blue { background: #1890ff; }
        .radar-hidden { opacity: 0 !important; pointer-events: none; } /* é›·è¾¾æ¨¡å¼éšèº« */
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <div style="font-size: 40px; margin-bottom: 10px;">ğŸ®</div>
            <div class="login-title">MOUYU æ¸¸æˆç³»ç»Ÿ</div>
            <input type="password" id="site-password" class="login-input" placeholder="è¾“å…¥å¯†ç ..." onkeypress="if(event.key==='Enter') checkSitePassword()">
            <button class="login-btn" onclick="checkSitePassword()">START</button>
            <div id="login-error" style="color:red; font-size:12px; margin-top:10px; opacity:0;">å¯†ç é”™è¯¯</div>
        </div>
    </div>

    <div id="game-hud" class="game-control-panel">
        <span id="game-status-text">ç­‰å¾…æŒ‡ä»¤...</span>
        <div id="game-actions" style="margin-top:5px;"></div>
    </div>
    
    <div id="radar-ping" class="radar-scan-effect"></div>

    <div id="toast" class="toast-tip">æç¤ºä¿¡æ¯</div>

    <div class="player-list-panel" id="player-panel">
        <div class="panel-header" onclick="togglePlayerPanel()">
            <div class="panel-title">ğŸ“¡ è®¾ç½®ä¸åˆ—è¡¨</div>
            <div style="font-size:12px;">â–¼</div>
        </div>
        <div class="panel-content" id="player-content">
            
            <div style="background: #e6f7ff; padding: 8px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #91d5ff;">
                <div class="user-setting-row">
                    <span class="setting-label">æˆ¿é—´</span>
                    <input type="text" id="room-input" class="id-input" value="å¤§å…" placeholder="æˆ¿é—´å">
                </div>
                <div class="user-setting-row">
                    <span class="setting-label">å¯†ç </span>
                    <input type="text" id="pass-input" class="status-input" placeholder="åŠ å¯†(å¯é€‰)">
                </div>
                <button class="map-btn" onclick="joinRoom()" style="width:100%; background:#1890ff; color:white; justify-content:center;">ğŸšª è¿›å…¥/åˆ‡æ¢</button>
            </div>

            <div style="background: #333; color: #fff; padding: 8px; border-radius: 8px; margin-bottom: 10px;">
                <div class="user-setting-row">
                    <span class="setting-label" style="color:#00f3ff;">æ¨¡å¼</span>
                    <select id="game-mode-select" class="game-select" onchange="switchGameMode(this.value)" style="background:#555; color:white; border:none;">
                        <option value="none">ğŸ“ é»˜è®¤ (æ— )</option>
                        <option value="zombie">ğŸ§Ÿ ç”ŸåŒ–å±æœº</option>
                        <option value="turf">ğŸ¨ æ¶‚é¸¦å é¢†</option>
                        <option value="treasure">ğŸ“¦ å¯»å®çŒäºº</option>
                        <option value="radar">ğŸ•µï¸ å¹½çµé›·è¾¾</option>
                    </select>
                </div>
                <div id="game-desc" style="font-size:10px; color:#aaa; margin-top:4px;">çº¯å‡€ä½ç½®å…±äº«æ¨¡å¼</div>
            </div>
            
            <div style="border-top:1px dashed #eee; padding-top:10px;">
                <div class="user-setting-row">
                    <span class="setting-label">æ˜µç§°</span>
                    <input type="text" id="my-name-input" class="id-input" placeholder="åå­—">
                </div>
                <div class="user-setting-row">
                    <span class="setting-label">å½¢è±¡</span>
                    <input type="text" id="my-avatar-input" class="avatar-input" value="ğŸ˜¼">
                </div>
            </div>

            <div id="player-list-container" style="margin-top:10px;">
                <div style="font-size:12px; color:#ccc; text-align:center;">æ‰«æä¸­...</div>
            </div>
        </div>
    </div>

    <div class="chat-panel" id="chat-panel">
        <div class="chat-header" onclick="toggleChat()">
            <div>ğŸ’¬ é¢‘é“ <span id="chat-badge" style="display:none; color:red;">â—</span></div>
            <span>â–²</span>
        </div>
        <div class="chat-content-wrapper">
            <div class="chat-messages" id="chat-messages">
                <div class="chat-msg-row" style="color:#999;">æ¬¢è¿...</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" class="chat-input" placeholder="å‘é€æ¶ˆæ¯..." onkeypress="if(event.key==='Enter') sendChat()">
                <button class="chat-send-btn" onclick="sendChat()">å‘é€</button>
            </div>
        </div>
    </div>

    <div id="map"></div>
    
    <button class="map-btn measure-btn" id="measure-btn" onclick="toggleMeasure()">ğŸ“</button>
    <button class="map-btn follow-btn" id="follow-btn" onclick="toggleFollow()">ğŸ”„</button>
    <button class="map-btn locate-btn" onclick="triggerManualLocate()">ğŸ“</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <script>
        // ============================================
        // ğŸ” 1. å¯†ç é…ç½® (è¯·ä¿®æ”¹è¿™é‡Œ!)
        // ============================================
        var SITE_PASSWORD = "MOUYU"; 

        function checkSitePassword() {
            var input = document.getElementById('site-password').value;
            if (input === SITE_PASSWORD) {
                document.getElementById('login-overlay').style.display = 'none';
                startApp();
            } else {
                var err = document.getElementById('login-error');
                err.style.opacity = 1; setTimeout(()=>err.style.opacity=0, 2000);
            }
        }

        // ============================================
        // ğŸ—ï¸ æ ¸å¿ƒå˜é‡
        // ============================================
        var map, client;
        var myUniqueId, myName;
        var otherPlayers = {}; var myLatLng = null; var myMarker = null; var myPolyline = null;
        var myCurrentAvatar = "ğŸ˜¼"; var myCurrentStatus = ""; var currentFlag = null; 
        var isFollowing = false; var myHeading = 0; var currentTopic = ""; 
        var isMeasuring = false; var measurePoints = []; var measureLine = null;
        
        // ğŸ® æ¸¸æˆçŠ¶æ€å˜é‡
        var currentGameMode = "none";
        var myTeamColor = "#3388ff"; // é»˜è®¤è“è‰²
        var amIZombie = false;
        var treasures = []; // å­˜å‚¨å®è—æ ‡è®°

        function startApp() {
            // åˆå§‹åŒ–åœ°å›¾ (é»˜è®¤å«æ˜Ÿå›¾)
            var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });
            var streetMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 20 });
            var darkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 });
            
            map = L.map('map', { center: [35.8617, 104.1954], zoom: 4, layers: [satellite], zoomControl: false });
            L.control.zoom({position: 'topleft'}).addTo(map);
            L.control.layers({ "ğŸ›°ï¸ å«æ˜Ÿå›¾": satellite, "ğŸŒ‘ å¤œé—´æ¨¡å¼": darkMap, "â˜€ï¸ è¡—é“å›¾": streetMap }).addTo(map);

            // ç”¨æˆ·IDåˆå§‹åŒ–
            myUniqueId = localStorage.getItem('uid') || "uid_" + Math.floor(Math.random()*100000);
            localStorage.setItem('uid', myUniqueId);
            myName = localStorage.getItem('name') || "ç©å®¶" + Math.floor(Math.random()*100);
            document.getElementById('my-name-input').value = myName;

            // MQTT è¿æ¥
            client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
            client.on('connect', () => { console.log('MQTT Connected'); joinRoom(); });
            client.on('message', handleMqttMessage);

            // äº‹ä»¶ç›‘å¬
            map.on('click', onMapClick);
            map.on('contextmenu', onMapContext);
            map.on('locationfound', onLocationFound);
            locateAndShare();
            setInterval(locateAndShare, 3000); // 3ç§’åˆ·æ–°ä¸€æ¬¡ä½ç½®
            
            // ç›‘å¬æ˜µç§°å¤´åƒå˜åŒ–
            document.getElementById('my-name-input').addEventListener('input', (e)=>{ myName=e.target.value; localStorage.setItem('name', myName); });
            document.getElementById('my-avatar-input').addEventListener('input', (e)=>{ myCurrentAvatar=e.target.value; updateMyMarker(); });
        }

        // ============================================
        // ğŸ® æ¸¸æˆæ¨¡å¼åˆ‡æ¢é€»è¾‘
        // ============================================
        function switchGameMode(mode) {
            currentGameMode = mode;
            var desc = document.getElementById('game-desc');
            var hud = document.getElementById('game-hud');
            var actions = document.getElementById('game-actions');
            
            // é‡ç½®çŠ¶æ€
            hud.style.display = 'none';
            amIZombie = false;
            myCurrentAvatar = document.getElementById('my-avatar-input').value; // æ¢å¤é»˜è®¤å¤´åƒ
            myTeamColor = "#3388ff"; // æ¢å¤é»˜è®¤é¢œè‰²
            document.querySelectorAll('.leaflet-marker-icon').forEach(el => el.classList.remove('radar-hidden')); // æ¸…é™¤é›·è¾¾éšèº«
            
            // æ¸…é™¤å®è—
            treasures.forEach(t => map.removeLayer(t)); treasures = [];

            if (mode === 'none') {
                desc.innerText = "çº¯å‡€ä½ç½®å…±äº«æ¨¡å¼";
            } 
            else if (mode === 'zombie') {
                desc.innerText = "é è¿‘æ„ŸæŸ“è€…ä¼šè¢«æ„ŸæŸ“ï¼";
                hud.style.display = 'block';
                document.getElementById('game-status-text').innerText = "æˆ‘æ˜¯: ğŸƒ å¹¸å­˜è€…";
                actions.innerHTML = `<button class="game-btn" onclick="becomeZombie()">å˜èº«æ¯ä½“(æ„ŸæŸ“æº)</button>`;
            }
            else if (mode === 'turf') {
                desc.innerText = "ç§»åŠ¨è½¨è¿¹å°†æ¶‚æŠ¹åœ°å›¾é¢œè‰²";
                hud.style.display = 'block';
                document.getElementById('game-status-text').innerText = "å½“å‰é˜µè¥";
                actions.innerHTML = `
                    <button class="game-btn" onclick="setTeam('red')">åŠ å…¥çº¢é˜Ÿ</button>
                    <button class="game-btn blue" onclick="setTeam('blue')">åŠ å…¥è“é˜Ÿ</button>`;
            }
            else if (mode === 'treasure') {
                desc.innerText = "é•¿æŒ‰åœ°å›¾åŸ‹è—å®è—ï¼Œé è¿‘20ç±³å¼€å¯";
                showToast("æç¤ºï¼šé•¿æŒ‰åœ°å›¾ä»»æ„ä½ç½®åŸ‹å®è—");
            }
            else if (mode === 'radar') {
                desc.innerText = "æ‰€æœ‰äººéšèº«ï¼Œç‚¹å‡»é›·è¾¾æ‰«æ";
                hud.style.display = 'block';
                document.getElementById('game-status-text').innerText = "å¹½çµæ¨¡å¼";
                actions.innerHTML = `<button class="game-btn blue" onclick="scanRadar()">ğŸ“¡ å¯åŠ¨é›·è¾¾ (3s)</button>`;
                // ç«‹å³è®©è‡ªå·±éšèº« (é€æ˜åº¦é™ä½)
                if(myMarker) myMarker.setOpacity(0.3);
            }
            updateMyMarker();
        }

        // --- ğŸ§Ÿ ç”ŸåŒ–æ¨¡å¼é€»è¾‘ ---
        function becomeZombie() {
            amIZombie = true;
            myCurrentAvatar = "ğŸ§Ÿ";
            document.getElementById('game-status-text').innerText = "æˆ‘æ˜¯: ğŸ§Ÿ æ„ŸæŸ“è€…";
            updateMyMarker();
            showToast("ä½ å·²å˜æˆåƒµå°¸ï¼å»æŠ“äººï¼");
        }
        function checkInfection(otherLat, otherLng, otherAvatar) {
            if (currentGameMode === 'zombie' && !amIZombie && otherAvatar === 'ğŸ§Ÿ') {
                var dist = map.distance(myLatLng, [otherLat, otherLng]);
                if (dist < 15) { // 15ç±³å†…è¢«æ„ŸæŸ“
                    becomeZombie();
                    client.publish(currentTopic, JSON.stringify({ type: 'chat', senderId: 'SYS', senderName: 'ç³»ç»Ÿ', text: `${myName} è¢«æ„ŸæŸ“äº†ï¼` }));
                }
            }
        }

        // --- ğŸ¨ æ¶‚é¸¦æ¨¡å¼é€»è¾‘ ---
        function setTeam(color) {
            if(color === 'red') { myTeamColor = '#ff4d4f'; showToast("å·²åŠ å…¥çº¢é˜Ÿ"); }
            else { myTeamColor = '#1890ff'; showToast("å·²åŠ å…¥è“é˜Ÿ"); }
            // ç«‹å³å¼€å§‹ä¸€æ®µæ–°è½¨è¿¹
            myPolyline = null; 
            if(myLatLng) {
                myPolyline = L.polyline([], { color: myTeamColor, weight: 8, opacity: 0.6 }).addTo(map);
                myPolyline.addLatLng(myLatLng);
            }
        }

        // --- ğŸ“¡ é›·è¾¾æ¨¡å¼é€»è¾‘ ---
        function scanRadar() {
            var wave = document.getElementById('radar-ping');
            wave.style.animation = 'none';
            wave.offsetHeight; /* trigger reflow */
            wave.style.animation = 'radarPing 2s linear';
            
            // æ˜¾ç¤ºæ‰€æœ‰äºº 3ç§’
            document.querySelectorAll('.other-icon-style').forEach(el => el.classList.remove('radar-hidden'));
            setTimeout(() => {
                // 3ç§’åå†æ¬¡éšè—
                document.querySelectorAll('.other-icon-style').forEach(el => el.classList.add('radar-hidden'));
            }, 3000);
        }

        // --- ğŸ“¦ å¯»å®æ¨¡å¼é€»è¾‘ ---
        function onMapContext(e) {
            if (currentGameMode === 'treasure') {
                if(confirm("ğŸ´â€â˜ ï¸ è¦åœ¨è¿™é‡ŒåŸ‹ä¸‹å®è—å—ï¼Ÿ")) {
                    var note = prompt("è¾“å…¥å®è—é‡Œçš„ç•™è¨€/å£ä»¤:");
                    if(note) {
                        client.publish(currentTopic, JSON.stringify({
                            type: 'treasure_add', lat: e.latlng.lat, lng: e.latlng.lng, note: note
                        }));
                    }
                }
            } else if (!isMeasuring) {
                // é»˜è®¤çš„é•¿æŒ‰æ’æ——åŠŸèƒ½
                if(confirm("ğŸš© æ’æ——é›†åˆï¼Ÿ")) client.publish(currentTopic, JSON.stringify({ type: 'flag_update', action: 'add', lat: e.latlng.lat, lng: e.latlng.lng, senderName: myName }));
            }
        }

        // ============================================
        // ğŸ“¡ MQTT & åœ°å›¾æ ¸å¿ƒ
        // ============================================
        function joinRoom() {
            var room = document.getElementById('room-input').value || "å¤§å…";
            var pass = document.getElementById('pass-input').value;
            var newTopic = 'mouyu/game/' + encodeURIComponent(room) + (pass ? "_" + encodeURIComponent(pass) : "");
            
            if(currentTopic) { client.unsubscribe(currentTopic); clearMap(); }
            currentTopic = newTopic;
            client.subscribe(currentTopic);
            client.publish(currentTopic, JSON.stringify({ type: 'chat', senderId: 'SYS', senderName: 'ç³»ç»Ÿ', text: `${myName} è¿›æˆ¿` }));
            showToast("å·²è¿›å…¥: " + room);
        }

        function handleMqttMessage(topic, msg) {
            var data = JSON.parse(msg.toString());
            if (data.type === 'chat') { appendChat(data); return; }
            if (data.type === 'flag_update') { updateFlag(data); return; }
            if (data.type === 'treasure_add') { addTreasure(data); return; }
            if (data.id === myUniqueId) return; // å¿½ç•¥è‡ªå·±

            updateOtherPlayer(data);
        }

        function updateOtherPlayer(data) {
            var id = data.id;
            var now = Date.now();
            
            // æ¸¸æˆæ¨¡å¼ç‰¹æ®Šå¤„ç†
            if (currentGameMode === 'zombie') checkInfection(data.lat, data.lng, data.avatar);
            
            if (!otherPlayers[id]) {
                var icon = L.divIcon({ className: 'emoji-marker-icon other-icon-style', html: data.avatar, iconSize: [30, 30] });
                var marker = L.marker([data.lat, data.lng], { icon: icon }).addTo(map);
                marker.bindPopup(data.name);
                // æ¶‚é¸¦æ¨¡å¼ç”¨ç²—çº¿ï¼Œæ™®é€šæ¨¡å¼ç”¨ç»†çº¿
                var weight = (currentGameMode === 'turf') ? 8 : 3;
                var color = (currentGameMode === 'turf') ? (data.teamColor || '#ff4d4f') : '#ff4d4f';
                var poly = L.polyline([], { color: color, weight: weight, opacity: 0.6 }).addTo(map);
                
                otherPlayers[id] = { marker: marker, polyline: poly, lastSeen: now };
                
                // é›·è¾¾æ¨¡å¼ä¸‹ï¼Œæ–°åŠ å…¥çš„äººé»˜è®¤éšè—
                if (currentGameMode === 'radar') marker.getElement().classList.add('radar-hidden');
            } else {
                var p = otherPlayers[id];
                p.lastSeen = now;
                p.marker.setLatLng([data.lat, data.lng]);
                p.polyline.addLatLng([data.lat, data.lng]);
                
                // æ›´æ–°å¤´åƒï¼ˆå¦‚æœæ˜¯åƒµå°¸ï¼‰
                var el = p.marker.getElement();
                if(el) el.innerHTML = data.avatar;
                
                // æ¶‚é¸¦æ¨¡å¼æ›´æ–°çº¿é¢œè‰²
                if (currentGameMode === 'turf' && data.teamColor) p.polyline.setStyle({ color: data.teamColor, weight: 8 });
            }
            updateList();
        }

        function addTreasure(data) {
            var icon = L.divIcon({ html: 'ğŸ“¦', className: 'emoji-marker-icon', iconSize: [24,24] });
            var marker = L.marker([data.lat, data.lng], { icon: icon }).addTo(map);
            // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼šåªæœ‰è·ç¦»å¤Ÿè¿‘æ‰èƒ½çœ‹
            marker.on('click', () => {
                var dist = map.distance(myLatLng, [data.lat, data.lng]);
                if (dist < 20) alert("ğŸ‰ å®è—å†…å®¹:\n" + data.note);
                else alert("ğŸ”’ è·ç¦»å¤ªè¿œ ("+Math.round(dist)+"ç±³)\nè¯·èµ°åˆ° 20ç±³ å†…å¼€å¯ï¼");
            });
            treasures.push(marker);
        }

        function onLocationFound(e) {
            myLatLng = e.latlng;
            if (isFollowing) map.panTo(myLatLng);
            
            // ç»˜åˆ¶è‡ªå·±çš„è½¨è¿¹ (æ”¯æŒæ¶‚é¸¦æ¨¡å¼æ¢è‰²)
            if (!myPolyline) myPolyline = L.polyline([], { color: myTeamColor, weight: currentGameMode==='turf'?8:4, opacity: 0.8 }).addTo(map);
            myPolyline.addLatLng(e.latlng);
            
            if (!myMarker) {
                var icon = L.divIcon({ className: 'emoji-marker-icon my-icon-style', html: myCurrentAvatar, iconSize: [30, 30] });
                myMarker = L.marker(e.latlng, { icon: icon }).addTo(map).bindPopup("æˆ‘");
            } else {
                myMarker.setLatLng(e.latlng);
            }

            // å‘é€æ•°æ® (åŒ…å«å½“å‰æ¸¸æˆçŠ¶æ€)
            client.publish(currentTopic, JSON.stringify({
                type: 'player_update', id: myUniqueId, name: myName, 
                lat: e.latlng.lat, lng: e.latlng.lng, 
                avatar: myCurrentAvatar, 
                teamColor: myTeamColor // ç”¨äºæ¶‚é¸¦æ¨¡å¼
            }));
        }

        function updateMyMarker() {
            if(myMarker) {
                myMarker.setIcon(L.divIcon({ className: 'emoji-marker-icon my-icon-style', html: myCurrentAvatar, iconSize: [30, 30] }));
            }
        }

        // ============================================
        // ğŸ› ï¸ è¾…åŠ© UI å‡½æ•° (æ¸…ç†ã€åˆ—è¡¨ã€èŠå¤©)
        // ============================================
        function clearMap() {
            for(var id in otherPlayers) { map.removeLayer(otherPlayers[id].marker); map.removeLayer(otherPlayers[id].polyline); }
            otherPlayers = {};
            treasures.forEach(t => map.removeLayer(t)); treasures = [];
            if(currentFlag) { map.removeLayer(currentFlag); currentFlag = null; }
        }
        function locateAndShare() { map.locate({ setView: false, maxZoom: 17, enableHighAccuracy: true }); }
        function triggerManualLocate() { map.locate({ setView: true, maxZoom: 17 }); }
        function showToast(msg) { var t=document.getElementById('toast'); t.innerText=msg; t.style.opacity=1; setTimeout(()=>t.style.opacity=0, 2000); }
        
        function updateList() {
            var box = document.getElementById('player-list-container'); box.innerHTML = "";
            for (var id in otherPlayers) {
                var p = otherPlayers[id];
                var div = document.createElement('div'); div.className = 'player-item';
                div.innerHTML = `<span>${p.marker.getElement().innerText} ${p.marker.getPopup().getContent()}</span>`;
                div.onclick = () => map.flyTo(p.marker.getLatLng(), 18);
                box.appendChild(div);
            }
        }
        
        // èŠå¤©ç›¸å…³
        function appendChat(data) {
            var box = document.getElementById('chat-messages');
            var div = document.createElement('div'); div.className = 'chat-msg-row';
            div.innerHTML = `<b style="color:${data.senderId===myUniqueId?'#1890ff':'#ff4d4f'}">${data.senderName}:</b> ${data.text}`;
            box.appendChild(div); box.scrollTop = box.scrollHeight;
        }
        function sendChat() {
            var input = document.getElementById('chat-input');
            if(input.value.trim()) {
                client.publish(currentTopic, JSON.stringify({ type:'chat', senderId:myUniqueId, senderName:myName, text:input.value }));
                appendChat({ senderId:myUniqueId, senderName:myName, text:input.value });
                input.value = "";
            }
        }
        
        // æ——å¸œç›¸å…³
        function updateFlag(data) {
            if (data.action === 'add') {
                if(currentFlag) map.removeLayer(currentFlag);
                var icon = L.divIcon({ html: 'ğŸ', className: 'flag-icon', iconSize: [30,30] });
                currentFlag = L.marker([data.lat, data.lng], { icon: icon }).addTo(map).bindPopup(`é›†åˆ! å‘èµ·: ${data.senderName}`);
            } else if (currentFlag) { map.removeLayer(currentFlag); currentFlag = null; }
        }

        // é¢æ¿åˆ‡æ¢
        function togglePlayerPanel() { 
            var p = document.getElementById('player-content'); 
            p.style.display = p.style.display==='none'?'block':'none'; 
        }
        function toggleChat() { 
            var p = document.querySelector('.chat-content-wrapper'); 
            p.style.display = p.style.display==='none'?'block':'none'; 
        }
        function onMapClick(e) {
            if (isMeasuring) {
                measurePoints.push(e.latlng);
                L.circleMarker(e.latlng, { radius: 3, color: 'red' }).addTo(map);
                if (measurePoints.length === 2) {
                    var dist = map.distance(measurePoints[0], measurePoints[1]);
                    alert("è·ç¦»: " + Math.round(dist) + " ç±³");
                    measurePoints = [];
                }
            }
        }
        function toggleMeasure() { isMeasuring = !isMeasuring; showToast(isMeasuring ? "ç‚¹å‡»ä¸¤ç‚¹æµ‹é‡" : "æµ‹é‡ç»“æŸ"); }
        function toggleFollow() { isFollowing = !isFollowing; showToast(isFollowing ? "è§†è§’è·Ÿéšå¼€å¯" : "è§†è§’è·Ÿéšå…³é—­"); }

    </script>
</body>
</html>
