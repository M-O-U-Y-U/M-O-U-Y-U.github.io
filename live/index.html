<script>
        // 1. è·å– URL æˆ¿é—´å·å‚æ•° ?room=xxx
        var urlParams = new URLSearchParams(window.location.search);
        var roomName = urlParams.get('room') || 'public'; // é»˜è®¤ä¸º public
        var topic = 'mouyu/live/' + roomName;

        // 2. åœ°å›¾å›¾å±‚é…ç½® (æ–°å¢ Dark Mode)
        var darkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        });
        var satellite = L.layerGroup([
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 }),
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 })
        ]);
        var streetMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: 'Â© CartoDB', maxZoom: 20 });

        // 3. åˆå§‹åŒ–åœ°å›¾ (é»˜è®¤ä½¿ç”¨ darkMap)
        var map = L.map('map', { center: [35.8617, 104.1954], zoom: 4, layers: [darkMap], zoomControl: false });
        
        L.control.zoom({position: 'topleft'}).addTo(map);
        L.control.layers({ "ğŸŒ‘ èµ›åšæ¨¡å¼": darkMap, "ğŸ›°ï¸ å«æ˜Ÿå›¾": satellite, "â˜€ï¸ è¡—é“å›¾": streetMap }).addTo(map);
        L.control.scale({ imperial: false, maxWidth: 200 }).addTo(map);

        // ä¿®æ”¹æ ‡é¢˜æ˜¾ç¤ºæˆ¿é—´å
        document.querySelector('.panel-title').innerHTML = `ğŸ“¡ MOUYUåœ°å›¾ <span style="color:#1890ff; font-weight:normal;">#${roomName}</span>`;

        // ... (ä»¥ä¸‹æ˜¯åŸæœ¬çš„ç”¨æˆ·IDã€MQTTè¿æ¥é€»è¾‘ï¼ŒåŸºæœ¬ä¿æŒä¸å˜ï¼Œå¤åˆ¶å›æ¥å³å¯) ...
        var myUniqueId = localStorage.getItem('my_unique_id');
        if (!myUniqueId) {
            myUniqueId = "uid_" + Date.now() + "_" + Math.floor(Math.random() * 10000);
            localStorage.setItem('my_unique_id', myUniqueId);
        }
        var myName = localStorage.getItem('my_nickname');
        if (!myName) { myName = "ç¥ç§˜äºº" + Math.floor(Math.random() * 100); }

        document.getElementById('my-name-input').value = myName;
        document.getElementById('my-status-text').innerText = "ç³»ç»ŸID: " + myUniqueId.substring(0,8)+"...";

        var otherPlayers = {}; var myLatLng = null; var myMarker = null; var myPolyline = null;
        var myCurrentAvatar = "ğŸ˜¼"; var myCurrentStatus = ""; var currentFlag = null; 
        var isMeasuring = false; var measurePoints = []; var measureLine = null; var measureTips = [];
        var isFollowing = false; var myHeading = 0; 
        
        var client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
        var debounceTimer = null;

        setTimeout(function(){ var t = document.getElementById('toast'); t.style.opacity = 1; setTimeout(function(){ t.style.opacity = 0; }, 3000); }, 2000);
        
        // è®¢é˜…åŠ¨æ€ç”Ÿæˆçš„ Topic
        client.on('connect', function () { 
            console.log('âœ… MQTT Connected to ' + topic); 
            client.subscribe(topic); 
            // è¿›æˆ¿æ—¶å‘ä¸€æ¡å¹¿æ’­
            client.publish(topic, JSON.stringify({ type: 'chat', senderId: 'SYSTEM', senderName: 'ç³»ç»Ÿ', text: `ç”¨æˆ· ${myName} åŠ å…¥äº†é¢‘é“ #${roomName}` }));
        });

        // ... (ViewMode, UI Toggle, Measure, Follow ç­‰å‡½æ•°ä¿æŒä¸å˜) ...
        var currentViewMode = 'auto';
        function setViewMode(mode, btnElement) {
            currentViewMode = mode; var btns = document.querySelectorAll('.view-opt'); btns.forEach(b => b.classList.remove('active')); if(btnElement) btnElement.classList.add('active'); applyViewMode();
        }
        function applyViewMode() {
            var body = document.body; var isMobile = false;
            if (currentViewMode === 'mobile') isMobile = true; else if (currentViewMode === 'pc') isMobile = false; else isMobile = window.innerWidth <= 600;
            if (isMobile) { body.classList.add('view-mobile'); if (!body.dataset.initMobile) { toggleChat(true); togglePlayerPanel(true); body.dataset.initMobile = "true"; } } else { body.classList.remove('view-mobile'); }
        }
        window.addEventListener('resize', function() { if (currentViewMode === 'auto') applyViewMode(); });
        applyViewMode();

        function togglePlayerPanel(forceCollapse) {
            var content = document.getElementById('player-content'); var icon = document.getElementById('player-toggle-icon'); var isHidden = content.style.display === 'none';
            if (forceCollapse === true || !isHidden) { content.style.display = 'none'; icon.innerText = "â—€"; icon.style.transform = "rotate(90deg)"; } else { content.style.display = 'block'; icon.innerText = "â–¼"; icon.style.transform = "rotate(0deg)"; }
        }
        function toggleChat(forceCollapse) {
            var panel = document.getElementById('chat-panel'); var icon = document.getElementById('chat-toggle-icon'); var badge = document.getElementById('chat-badge');
            if (forceCollapse === true || !panel.classList.contains('collapsed')) { panel.classList.add('collapsed'); icon.innerText = "â–²"; } else { panel.classList.remove('collapsed'); icon.innerText = "â–¼"; badge.style.display = 'none'; }
        }

        function toggleMeasure() {
            isMeasuring = !isMeasuring; var btn = document.getElementById('measure-btn');
            if(isMeasuring) { btn.classList.add('active'); btn.innerHTML = "âŒ"; document.getElementById('map').style.cursor = "crosshair"; alert("ç‚¹å‡»åœ°å›¾ä¸¤ç‚¹æµ‹é‡"); if(isFollowing) toggleFollow(); } 
            else { btn.classList.remove('active'); btn.innerHTML = "ğŸ“"; document.getElementById('map').style.cursor = ""; clearMeasure(); }
        }
        function clearMeasure() { if(measureLine) map.removeLayer(measureLine); measureTips.forEach(t => map.removeLayer(t)); measurePoints = []; measureTips = []; }

        function toggleFollow() {
            isFollowing = !isFollowing; var btn = document.getElementById('follow-btn');
            if(isFollowing) { btn.classList.add('active'); if(myLatLng) map.flyTo(myLatLng, 18); document.getElementById('toast').innerText = "è§†è§’è·Ÿéšå·²å¼€å¯"; document.getElementById('toast').style.opacity = 1; setTimeout(()=>document.getElementById('toast').style.opacity=0, 2000); } 
            else { btn.classList.remove('active'); document.getElementById('toast').innerText = "è§†è§’è·Ÿéšå·²å…³é—­"; document.getElementById('toast').style.opacity = 1; setTimeout(()=>document.getElementById('toast').style.opacity=0, 2000); }
        }
        map.on('dragstart', function() { if(isFollowing) toggleFollow(); });
        
        // ... (ExportGPX, DeviceOrientation, Click, Chat, Flag, Message Handler ç­‰ä¿æŒä¸å˜) ...
        // ä¸ºäº†ç¯‡å¹…ï¼Œä¸­é—´è¿™äº›é€»è¾‘ä»£ç å®Œå…¨ä¸ç”¨åŠ¨ï¼Œç›´æ¥ç”¨åŸæ¥çš„å³å¯
        // åªéœ€ç¡®ä¿ client.publish ç”¨çš„éƒ½æ˜¯ä¸Šé¢å®šä¹‰çš„æ–°çš„ topic å˜é‡
        
        if (window.DeviceOrientationEvent) {
            window.addEventListener('deviceorientation', function(event) {
                if (event.alpha !== null) {
                    var heading = event.webkitCompassHeading || (360 - event.alpha);
                    myHeading = heading; updateHeadingVisuals();
                }
            }, true);
        }
        function updateHeadingVisuals() {
            var arrow = document.querySelector('.my-icon-style .heading-arrow');
            if(arrow) { arrow.style.display = 'block'; arrow.style.transform = `translateX(-50%) rotate(${myHeading}deg)`; }
        }

        map.on('click', function(e) {
            if (isMeasuring) {
                measurePoints.push(e.latlng);
                var tip = L.circleMarker(e.latlng, { color: '#00f3ff', radius: 4 }).addTo(map); measureTips.push(tip); // æ”¹ä¸ªé¢œè‰²é…åˆæš—é»‘æ¨¡å¼
                if (measurePoints.length === 2) {
                    var p1 = measurePoints[0]; var p2 = measurePoints[1];
                    var dist = map.distance(p1, p2); var distStr = dist > 1000 ? (dist/1000).toFixed(2) + " km" : Math.round(dist) + " m";
                    measureLine = L.polyline([p1, p2], { color: '#00f3ff', weight: 2, dashArray: '5, 5' }).addTo(map);
                    measureLine.bindPopup(`<b>ğŸ“ ${distStr}</b>`).openPopup();
                    measurePoints = []; setTimeout(() => { measureTips.forEach(t => map.removeLayer(t)); measureTips = []; }, 500);
                } else if (measurePoints.length > 2) { clearMeasure(); }
            }
        });

        function handleChatKey(e) { if(e.key === 'Enter') sendChat(); }
        function sendChat() {
            var input = document.getElementById('chat-input'); var text = input.value; if(!text.trim()) return;
            client.publish(topic, JSON.stringify({ type: 'chat', senderId: myUniqueId, senderName: myName, text: text }));
            appendChatMsg(myName, text, true); input.value = "";
        }
        function appendChatMsg(name, text, isMe) {
            var box = document.getElementById('chat-messages'); var div = document.createElement('div'); div.className = 'chat-msg-row';
            var senderHtml = isMe ? `<span class="chat-sender" style="color:#1890ff">æˆ‘:</span>` : `<span class="chat-sender" style="color:#ff4d4f">${name}:</span>`;
            div.innerHTML = `${senderHtml} <span class="chat-text">${text}</span>`;
            box.appendChild(div); box.scrollTop = box.scrollHeight;
            if (!isMe && document.getElementById('chat-panel').classList.contains('collapsed')) { showMsgBubble(name, text); document.getElementById('chat-badge').style.display = 'block'; }
        }
        function showMsgBubble(name, text) {
            var container = document.getElementById('msg-bubble-container'); var bubble = document.createElement('div'); bubble.className = 'msg-bubble';
            bubble.innerText = `${name}: ${text}`; container.appendChild(bubble); setTimeout(() => { bubble.style.opacity = '0'; setTimeout(() => bubble.remove(), 300); }, 3000);
        }

        map.on('contextmenu', function(e) {
            if(isMeasuring) return;
            if(confirm("ğŸš© æ’æ——é›†åˆï¼Ÿ")) client.publish(topic, JSON.stringify({ type: 'flag_update', senderName: myName, action: 'add', lat: e.latlng.lat, lng: e.latlng.lng }));
        });
        window.removeFlag = function() { if(confirm("å–æ¶ˆé›†åˆç‚¹ï¼Ÿ")) client.publish(topic, JSON.stringify({ type: 'flag_update', action: 'remove' })); };

        client.on('message', function (topic, message) {
            try {
                var data = JSON.parse(message.toString());
                if (data.type === 'chat') { if (data.senderId !== myUniqueId) appendChatMsg(data.senderName, data.text, false); return; }
                if (data.type === 'flag_update') {
                    if (data.action === 'add') {
                        if (currentFlag) map.removeLayer(currentFlag);
                        var flagIcon = L.divIcon({ className: 'flag-icon', html: 'ğŸ', iconSize: [30, 40], iconAnchor: [15, 40] });
                        currentFlag = L.marker([data.lat, data.lng], { icon: flagIcon }).addTo(map).bindPopup(`<b>ğŸ é›†åˆ</b><br>å‘èµ·: ${data.senderName}<br><button onclick="removeFlag()">æ‹”æ‰</button>`).openPopup();
                    } else if (data.action === 'remove') { if (currentFlag) { map.removeLayer(currentFlag); currentFlag = null; } }
                    return;
                }
                if (data.id === myUniqueId) return;
                
                var now = Date.now(); var pAvatar = data.avatar || "ğŸ“"; var pStatus = data.status || ""; var pName = data.name || "æœªçŸ¥";
                if (!otherPlayers[data.id]) {
                    var icon = L.divIcon({ className: 'emoji-marker-icon other-icon-style', html: pAvatar, iconSize: [40, 40], iconAnchor: [20, 20] });
                    var newMarker = L.marker([data.lat, data.lng], { icon: icon }).addTo(map);
                    if(pStatus) newMarker.bindTooltip(pStatus, { permanent: true, direction: 'top', offset: [0, -22], className: 'status-bubble' });
                    newMarker.bindPopup("ğŸš© " + pName);
                    // å¯¹æ–¹çš„è½¨è¿¹çº¿æ”¹æˆè§å…‰ç»¿ï¼Œåœ¨é»‘è‰²åœ°å›¾ä¸Šæ›´æ˜¾çœ¼
                    var newPolyline = L.polyline([], { color: '#00ff00', weight: 3, opacity: 0.8, dashArray: '5, 10' }).addTo(map); newPolyline.addLatLng([data.lat, data.lng]);
                    otherPlayers[data.id] = { marker: newMarker, polyline: newPolyline, lastSeen: now, lat: data.lat, lng: data.lng, avatar: pAvatar, status: pStatus, name: pName };
                } else {
                    var p = otherPlayers[data.id]; p.marker.setLatLng([data.lat, data.lng]); p.polyline.addLatLng([data.lat, data.lng]);
                    p.lastSeen = now; p.lat = data.lat; p.lng = data.lng;
                    if (p.name !== pName) { p.marker.bindPopup("ğŸš© " + pName); p.name = pName; }
                    if (p.avatar !== pAvatar) { p.marker.setIcon(L.divIcon({ className: 'emoji-marker-icon other-icon-style', html: pAvatar, iconSize: [40, 40], iconAnchor: [20, 20] })); p.avatar = pAvatar; }
                    if (p.status !== pStatus) { p.status = pStatus; pStatus ? p.marker.bindTooltip(pStatus, { permanent: true, direction: 'top', offset: [0, -22], className: 'status-bubble' }) : p.marker.unbindTooltip(); }
                }
                updatePlayerList();
            } catch (e) {}
        });

        function triggerQuietUpdate() { clearTimeout(debounceTimer); debounceTimer = setTimeout(function() { locateAndShare(false); }, 800); }

        document.getElementById('my-name-input').addEventListener('input', function(e) { myName = e.target.value.trim(); localStorage.setItem('my_nickname', myName); triggerQuietUpdate(); });
        document.getElementById('my-avatar-input').addEventListener('input', function(e) { myCurrentAvatar = e.target.value; updateMyMarkerVisuals(); triggerQuietUpdate(); });
        document.getElementById('my-status-input').addEventListener('input', function(e) { myCurrentStatus = e.target.value; updateMyMarkerVisuals(); triggerQuietUpdate(); });

        function updateMyMarkerVisuals() {
            if(!myMarker) return;
            var arrowHtml = `<div class="heading-arrow"></div>` + myCurrentAvatar;
            myMarker.setIcon(L.divIcon({ className: 'emoji-marker-icon my-icon-style', html: arrowHtml, iconSize: [40, 40], iconAnchor: [20, 20] }));
            if (myCurrentStatus) myMarker.bindTooltip(myCurrentStatus, { permanent: true, direction: 'top', offset: [0, -22], className: 'status-bubble' }); else myMarker.unbindTooltip();
            updateHeadingVisuals();
        }
        
        function updatePlayerList() {
            var container = document.getElementById('player-list-container'); container.innerHTML = ""; var hasPlayers = false;
            for (var id in otherPlayers) {
                hasPlayers = true; var p = otherPlayers[id];
                var distText = "--"; if (myLatLng) { var d = map.distance(myLatLng, [p.lat, p.lng]); d > 1000 ? distText = (d/1000).toFixed(1)+"km" : distText = Math.round(d)+"m"; }
                var statusHtml = p.status ? `<div class="player-status-text">ğŸ’¬ ${p.status}</div>` : '';
                var item = document.createElement('div'); item.className = 'player-item';
                item.innerHTML = `<div class="player-info"><div class="player-head"><span>${p.avatar}</span><span>${p.name}</span></div>${statusHtml}</div><div class="player-dist">${distText}</div>`;
                (function(targetLat, targetLng) { item.onclick = function() { map.flyTo([targetLat, targetLng], 18, { duration: 1.5 }); }; })(p.lat, p.lng);
                container.appendChild(item);
            }
            if (!hasPlayers) container.innerHTML = '<div style="font-size:12px; color:#ccc; text-align:center; padding:10px;">æš‚æ— å…¶ä»–äºº</div>';
        }
        setInterval(function() {
            var now = Date.now(); var listChanged = false;
            for (var id in otherPlayers) { if (now - otherPlayers[id].lastSeen > 10000) { map.removeLayer(otherPlayers[id].marker); if(otherPlayers[id].polyline) map.removeLayer(otherPlayers[id].polyline); delete otherPlayers[id]; listChanged = true; } }
            if(listChanged) updatePlayerList();
        }, 2000);

        function locateAndShare(showAlert = false) { map.locate({ setView: false, maxZoom: 17, timeout: 30000, enableHighAccuracy: true, maximumAge: 0 }); if(showAlert) alert("æ­£åœ¨åˆ·æ–°ä½ç½®..."); }
        function triggerManualLocate() { locateAndShare(true); }

        var isFirstLocate = true;
        map.on('locationfound', function(e) {
            myLatLng = e.latlng; 
            
            if (isFollowing) map.panTo(myLatLng);

            // æˆ‘è‡ªå·±çš„è½¨è¿¹çº¿é¢œè‰²
            if (!myPolyline) myPolyline = L.polyline([], { color: '#00f3ff', weight: 4, opacity: 0.8 }).addTo(map); myPolyline.addLatLng(e.latlng);
            if (!myMarker) { 
                var arrowHtml = `<div class="heading-arrow"></div>` + myCurrentAvatar;
                myMarker = L.marker(e.latlng, { icon: L.divIcon({ className: 'emoji-marker-icon my-icon-style', html: arrowHtml, iconSize: [40, 40], iconAnchor: [20, 20] }) }).addTo(map).bindPopup("<b>æˆ‘</b>").openPopup(); if(myCurrentStatus) updateMyMarkerVisuals(); 
            } else myMarker.setLatLng(e.latlng);
            
            if (isFirstLocate) { map.setView(e.latlng, 17); isFirstLocate = false; }
            client.publish(topic, JSON.stringify({ type: 'player_update', id: myUniqueId, name: myName, lat: e.latlng.lat, lng: e.latlng.lng, avatar: myCurrentAvatar, status: myCurrentStatus }));
        });
        map.on('locationerror', function(e) { console.log("å®šä½ä¸­..."); });

        locateAndShare(false); setInterval(() => locateAndShare(false), 3000);
</script>
